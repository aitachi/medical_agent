<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ»ç–—æ™ºèƒ½åŠ©æ‰‹ - AIå¥åº·å’¨è¯¢</title>
    <link rel="icon" type="image/svg+xml" href="/medical/static/favicon.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 260px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(0,0,0,0.1);
            box-shadow: 2px 0 20px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }

        .sidebar-header .logo {
            font-size: 42px;
            margin-bottom: 10px;
        }

        .sidebar-header h1 {
            font-size: 18px;
            color: #333;
            font-weight: 700;
        }

        .sidebar-header .subtitle {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        .sidebar-menu {
            flex: 1;
            padding: 20px 10px;
            overflow-y: auto;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            margin-bottom: 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #555;
            font-size: 14px;
        }

        .menu-item:hover {
            background: #f0f0ff;
            color: #667eea;
        }

        .menu-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .menu-item .icon {
            font-size: 22px;
            margin-right: 12px;
            width: 32px;
            text-align: center;
        }

        .menu-item .text {
            flex: 1;
            font-weight: 500;
        }

        .menu-item .arrow {
            font-size: 12px;
            opacity: 0.5;
        }

        .menu-item.active .arrow {
            opacity: 1;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid #eee;
        }

        .status-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 12px;
            font-size: 12px;
        }

        .status-card .status-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .status-card .status-row:last-child {
            margin-bottom: 0;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .llm-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-header h2 {
            font-size: 18px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .content-header .page-icon {
            font-size: 24px;
        }

        .content-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* é¡µé¢å®¹å™¨ */
        .page {
            display: none;
            height: 100%;
        }

        .page.active {
            display: flex;
            flex-direction: column;
        }

        /* èŠå¤©é¡µé¢ */
        .chat-page {
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .chat-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 140px);
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant {
            align-self: flex-start;
            background: #f1f3f5;
            color: #333;
            border-bottom-left-radius: 4px;
        }

        .process-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            font-size: 12px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .process-container.collapsed {
            max-height: 45px;
            overflow: hidden;
            cursor: pointer;
        }

        .process-container.collapsed .process-title::after {
            content: 'â–¼';
            float: right;
            font-size: 10px;
            color: #999;
        }

        .process-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .process-container.collapsed .process-title {
            margin-bottom: 0;
        }

        .process-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid #dee2e6;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .process-item:last-child {
            border-bottom: none;
        }

        .process-icon {
            font-size: 14px;
        }

        .process-text {
            flex: 1;
            color: #495057;
        }

        .process-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .process-status {
            color: #28a745;
            font-size: 11px;
            font-weight: 600;
        }

        /* æ¶ˆæ¯å†…å®¹æ ·å¼ */
        .message-content table {
            font-size: 13px;
        }

        .message-content .checked-item {
            padding: 8px 12px;
            background: #d4edda;
            border-radius: 6px;
            margin: 5px 0;
            color: #155724;
        }

        .message-content .unchecked-item {
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin: 5px 0;
            color: #666;
        }

        .message-content .warning-box {
            padding: 12px 16px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 6px;
            margin: 10px 0;
            color: #856404;
        }

        .message-content .success-item {
            padding: 8px 12px;
            background: #d4edda;
            border-radius: 6px;
            margin: 5px 0;
            color: #155724;
        }

        /* æ¬¢è¿æ¶ˆæ¯æ ·å¼ */
        .welcome-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .welcome-avatar {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .welcome-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .welcome-text strong {
            font-size: 16px;
            color: #333;
        }

        .welcome-badge {
            display: inline-block;
            padding: 2px 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            font-size: 11px;
            width: fit-content;
        }

        .welcome-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, #e0e0e0, transparent);
            margin: 15px 0;
        }

        .welcome-services {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .service-item {
            padding: 10px 12px;
            background: #f8f9ff;
            border-radius: 8px;
            font-size: 13px;
            color: #555;
            border: 1px solid #e0e0ff;
            transition: all 0.2s;
        }

        .service-item:hover {
            background: #e8e8ff;
            border-color: #667eea;
        }

        .welcome-tip {
            padding: 10px 15px;
            background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
            border-radius: 8px;
            font-size: 13px;
            color: #856404;
            text-align: center;
            border: 1px solid #ffc107;
        }

        .chat-input-area {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            background: #f8f9fa;
        }

        .chat-input-area input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 15px;
            outline: none;
        }

        .chat-input-area input:focus {
            border-color: #667eea;
        }

        .chat-input-area button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .quick-actions {
            padding: 10px 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }

        .quick-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* åŠŸèƒ½å¡ç‰‡åŒºåŸŸ */
        .feature-cards-section {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            padding: 25px;
            margin-bottom: 20px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
        }

        .section-icon {
            font-size: 24px;
        }

        .feature-cards-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .feature-card {
            display: flex;
            align-items: center;
            padding: 18px 20px;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f0ff 100%);
            border: 2px solid #e0e0ff;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .feature-card:hover .feature-icon,
        .feature-card:hover .feature-name,
        .feature-card:hover .feature-desc,
        .feature-card:hover .feature-arrow {
            color: white;
        }

        .feature-icon {
            font-size: 36px;
            margin-right: 15px;
        }

        .feature-info {
            flex: 1;
        }

        .feature-name {
            font-weight: 600;
            color: #333;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .feature-desc {
            color: #888;
            font-size: 12px;
        }

        .feature-arrow {
            font-size: 20px;
            color: #667eea;
            font-weight: bold;
        }

        /* ç—‡çŠ¶å’¨è¯¢é¡µé¢ */
        .symptom-page {
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .form-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            padding: 30px;
            margin-bottom: 20px;
        }

        .form-card h3 {
            font-size: 22px;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            display: block;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 15px;
            outline: none;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            border-color: #667eea;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .symptom-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .symptom-tag {
            padding: 8px 16px;
            background: #f0f0ff;
            border: 1px solid #d0d0ff;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .symptom-tag:hover, .symptom-tag.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .result-box {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            display: none;
        }

        .result-box.show {
            display: block;
        }

        /* ç§‘å®¤æ¨èé¡µé¢ */
        .department-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .dept-card {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .dept-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .dept-card.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .dept-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .dept-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .dept-desc {
            font-size: 11px;
            color: #666;
        }

        .dept-card.selected .dept-desc {
            color: rgba(255,255,255,0.8);
        }

        /* ç”¨è¯å’¨è¯¢é¡µé¢ */
        .medication-search {
            position: relative;
        }

        .medication-search input {
            padding-left: 45px;
        }

        .medication-search .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: #999;
        }

        .query-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .query-option {
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .query-option:hover, .query-option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* é¢„çº¦æŒ‚å·é¡µé¢ */
        .appointment-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .step {
            flex: 1;
            text-align: center;
            padding: 15px 10px;
            position: relative;
        }

        .step-number {
            width: 36px;
            height: 36px;
            background: #e0e0e0;
            color: #666;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .step.active .step-number {
            background: #667eea;
            color: white;
        }

        .step.completed .step-number {
            background: #4ade80;
            color: white;
        }

        .step-title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }

        .step-desc {
            font-size: 11px;
            color: #888;
        }

        .step::after {
            content: '';
            position: absolute;
            top: 33px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #e0e0e0;
            z-index: 1;
        }

        .step:last-child::after {
            display: none;
        }

        .step.completed::after {
            background: #4ade80;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .time-slot {
            padding: 12px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .time-slot:hover, .time-slot.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .time-slot.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #eee;
        }

        .doctor-list {
            display: grid;
            gap: 15px;
        }

        .doctor-card {
            display: flex;
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .doctor-card:hover, .doctor-card.selected {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .doctor-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-right: 15px;
        }

        .doctor-info {
            flex: 1;
        }

        .doctor-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .doctor-title {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }

        .doctor-tags {
            display: flex;
            gap: 5px;
        }

        .doctor-tag {
            padding: 2px 8px;
            background: #e0e0ff;
            color: #667eea;
            border-radius: 10px;
            font-size: 11px;
        }

        /* å¥åº·æ•™è‚²é¡µé¢ */
        .health-categories {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .health-category {
            padding: 20px;
            background: white;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #eee;
            text-align: center;
        }

        .health-category:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .health-category-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .health-category-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .health-category-desc {
            font-size: 12px;
            color: #888;
        }

        .health-tips {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .health-tips h3 {
            color: #0056b3;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .health-tips ul {
            list-style: none;
        }

        .health-tips li {
            padding: 8px 0;
            border-bottom: 1px solid #cce5ff;
        }

        .health-tips li:last-child {
            border-bottom: none;
        }

        .health-tips li::before {
            content: 'âœ“ ';
            color: #00a86b;
            margin-right: 8px;
        }

        /* éšè®¿é¡µé¢æ ·å¼ */
        .followup-rating {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .followup-rating label {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .followup-rating label:hover {
            background: #e8e8ff;
            border-color: #667eea;
        }

        .followup-rating input[type="radio"] {
            margin: 0;
        }

        .followup-rating input[type="radio"]:checked + span {
            color: #667eea;
            font-weight: 600;
        }

        /* æ¡£æ¡ˆæ ·å¼ */
        .record-timeline {
            position: relative;
            padding-left: 30px;
        }

        .record-timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e0e0e0;
        }

        .record-timeline-item {
            position: relative;
            padding: 15px 20px;
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .record-timeline-item::before {
            content: '';
            position: absolute;
            left: -36px;
            top: 20px;
            width: 12px;
            height: 12px;
            background: #667eea;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #667eea;
        }

        .record-date {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
        }

        .record-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .record-detail {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        /* æ‚£è€…åŸºæœ¬ä¿¡æ¯å¡ç‰‡ */
        .patient-info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .patient-info-card h4 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .patient-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .patient-info-item {
            background: rgba(255,255,255,0.15);
            padding: 12px 15px;
            border-radius: 10px;
        }

        .patient-info-item label {
            font-size: 12px;
            opacity: 0.8;
            display: block;
            margin-bottom: 4px;
        }

        .patient-info-item span {
            font-size: 16px;
            font-weight: 600;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }

            .sidebar-header .logo,
            .menu-item .text,
            .menu-item .arrow,
            .sidebar-header h1,
            .sidebar-header .subtitle,
            .sidebar-footer {
                display: none;
            }

            .menu-item {
                justify-content: center;
                padding: 15px;
            }

            .menu-item .icon {
                margin-right: 0;
                font-size: 24px;
            }

            .time-slots {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .cursor {
            display: inline-block;
            animation: blink 1s infinite;
            color: #667eea;
            font-weight: bold;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">ğŸ¥</div>
            <h1>åŒ»ç–—æ™ºèƒ½åŠ©æ‰‹</h1>
            <div class="subtitle">AIå¥åº·å’¨è¯¢å¹³å°</div>
        </div>

        <div class="sidebar-menu">
            <div class="menu-item active" data-page="chat">
                <span class="icon">ğŸ’¬</span>
                <span class="text">æ™ºèƒ½å’¨è¯¢</span>
                <span class="arrow">â€º</span>
            </div>
            <div class="menu-item" data-page="symptom">
                <span class="icon">ğŸ©º</span>
                <span class="text">ç—‡çŠ¶å’¨è¯¢</span>
                <span class="arrow">â€º</span>
            </div>
            <div class="menu-item" data-page="department">
                <span class="icon">ğŸ¥</span>
                <span class="text">ç§‘å®¤æ¨è</span>
                <span class="arrow">â€º</span>
            </div>
            <div class="menu-item" data-page="medication">
                <span class="icon">ğŸ’Š</span>
                <span class="text">ç”¨è¯å’¨è¯¢</span>
                <span class="arrow">â€º</span>
            </div>
            <div class="menu-item" data-page="appointment">
                <span class="icon">ğŸ“…</span>
                <span class="text">é¢„çº¦æŒ‚å·</span>
                <span class="arrow">â€º</span>
            </div>
            <div class="menu-item" data-page="my-appointment">
                <span class="icon">ğŸ“‹</span>
                <span class="text">é¢„çº¦æŸ¥è¯¢</span>
                <span class="arrow">â€º</span>
            </div>
            <div class="menu-item" data-page="followup">
                <span class="icon">ğŸ””</span>
                <span class="text">é¢„çº¦éšè®¿</span>
                <span class="arrow">â€º</span>
            </div>
            <div class="menu-item" data-page="records">
                <span class="icon">ğŸ“‚</span>
                <span class="text">æ²»ç–—æ¡£æ¡ˆ</span>
                <span class="arrow">â€º</span>
            </div>
            <div class="menu-item" data-page="patient">
                <span class="icon">ğŸ‘¤</span>
                <span class="text">æ‚£è€…ä¿¡æ¯</span>
                <span class="arrow">â€º</span>
            </div>
            <div class="menu-item" data-page="health">
                <span class="icon">ğŸ“š</span>
                <span class="text">å¥åº·æ•™è‚²</span>
                <span class="arrow">â€º</span>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="status-card">
                <div class="status-row">
                    <div class="status-indicator"></div>
                    <span id="status-text">æœåŠ¡æ­£å¸¸</span>
                </div>
                <div class="status-row">
                    <span class="llm-badge">ğŸ¤– qwen-plus</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
        <div class="content-header">
            <h2><span class="page-icon">ğŸ’¬</span><span id="page-title">æ™ºèƒ½å’¨è¯¢</span></h2>
        </div>

        <div class="content-body">
            <!-- æ™ºèƒ½å’¨è¯¢é¡µé¢ (ä¸»é¡µ) -->
            <div class="page active" id="page-chat">
                <div class="chat-page">
                    <!-- åŠŸèƒ½å¡ç‰‡åŒºåŸŸ -->
                    <div class="feature-cards-section">
                        <div class="section-title">
                            <span class="section-icon">âœ¨</span>
                            <span>å¿«æ·æœåŠ¡</span>
                        </div>
                        <div class="feature-cards-grid">
                            <div class="feature-card" onclick="triggerFeature('symptom')">
                                <div class="feature-icon">ğŸ©º</div>
                                <div class="feature-info">
                                    <div class="feature-name">ç—‡çŠ¶å’¨è¯¢</div>
                                    <div class="feature-desc">æ™ºèƒ½åˆ†æç—‡çŠ¶ï¼Œç»™å‡ºå¥åº·å»ºè®®</div>
                                </div>
                                <div class="feature-arrow">â†’</div>
                            </div>
                            <div class="feature-card" onclick="triggerFeature('department')">
                                <div class="feature-icon">ğŸ¥</div>
                                <div class="feature-info">
                                    <div class="feature-name">ç§‘å®¤æ¨è</div>
                                    <div class="feature-desc">ä¸çŸ¥é“æŒ‚ä»€ä¹ˆç§‘ï¼Ÿæ™ºèƒ½æ¨è</div>
                                </div>
                                <div class="feature-arrow">â†’</div>
                            </div>
                            <div class="feature-card" onclick="triggerFeature('medication')">
                                <div class="feature-icon">ğŸ’Š</div>
                                <div class="feature-info">
                                    <div class="feature-name">ç”¨è¯å’¨è¯¢</div>
                                    <div class="feature-desc">è¯å“ç”¨æ³•ã€å‰¯ä½œç”¨ã€ç¦å¿Œ</div>
                                </div>
                                <div class="feature-arrow">â†’</div>
                            </div>
                            <div class="feature-card" onclick="triggerFeature('appointment')">
                                <div class="feature-icon">ğŸ“…</div>
                                <div class="feature-info">
                                    <div class="feature-name">é¢„çº¦æŒ‚å·</div>
                                    <div class="feature-desc">åœ¨çº¿é¢„çº¦åŒ»ç”Ÿï¼Œä¾¿æ·å°±è¯Š</div>
                                </div>
                                <div class="feature-arrow">â†’</div>
                            </div>
                            <div class="feature-card" onclick="triggerFeature('my-appointment')">
                                <div class="feature-icon">ğŸ“‹</div>
                                <div class="feature-info">
                                    <div class="feature-name">é¢„çº¦æŸ¥è¯¢</div>
                                    <div class="feature-desc">æŸ¥è¯¢é¢„çº¦è®°å½•ï¼Œç®¡ç†å°±è¯Š</div>
                                </div>
                                <div class="feature-arrow">â†’</div>
                            </div>
                            <div class="feature-card" onclick="triggerFeature('followup')">
                                <div class="feature-icon">ğŸ””</div>
                                <div class="feature-info">
                                    <div class="feature-name">é¢„çº¦éšè®¿</div>
                                    <div class="feature-desc">è®°å½•éšè®¿æƒ…å†µï¼Œè·Ÿè¸ªåº·å¤</div>
                                </div>
                                <div class="feature-arrow">â†’</div>
                            </div>
                            <div class="feature-card" onclick="triggerFeature('records')">
                                <div class="feature-icon">ğŸ“‚</div>
                                <div class="feature-info">
                                    <div class="feature-name">æ²»ç–—æ¡£æ¡ˆ</div>
                                    <div class="feature-desc">æŸ¥çœ‹å°±è¯Šå†å²ï¼Œå¥åº·æ¡£æ¡ˆ</div>
                                </div>
                                <div class="feature-arrow">â†’</div>
                            </div>
                            <div class="feature-card" onclick="triggerFeature('patient')">
                                <div class="feature-icon">ğŸ‘¤</div>
                                <div class="feature-info">
                                    <div class="feature-name">æ‚£è€…ä¿¡æ¯</div>
                                    <div class="feature-desc">ç®¡ç†ä¸ªäººå¥åº·æ¡£æ¡ˆ</div>
                                </div>
                                <div class="feature-arrow">â†’</div>
                            </div>
                            <div class="feature-card" onclick="triggerFeature('health')">
                                <div class="feature-icon">ğŸ“š</div>
                                <div class="feature-info">
                                    <div class="feature-name">å¥åº·æ•™è‚²</div>
                                    <div class="feature-desc">å¥åº·çŸ¥è¯†ã€å…»ç”ŸæŒ‡å—</div>
                                </div>
                                <div class="feature-arrow">â†’</div>
                            </div>
                        </div>
                    </div>

                    <!-- èŠå¤©åŒºåŸŸ -->
                    <div class="chat-container">
                        <div class="chat-messages" id="chat-messages">
                            <div class="message assistant">
                                <div class="message-content">
                                    <div class="welcome-header">
                                        <div class="welcome-avatar">ğŸ¤–</div>
                                        <div class="welcome-text">
                                            <strong>åŒ»å°åŠ©</strong>
                                            <span class="welcome-badge">AIå¥åº·åŠ©æ‰‹</span>
                                        </div>
                                    </div>
                                    <div class="welcome-divider"></div>
                                    <div class="welcome-services">
                                        <div class="service-item">ğŸ©º <strong>ç—‡çŠ¶å’¨è¯¢</strong> - æ™ºèƒ½åˆ†æç—‡çŠ¶</div>
                                        <div class="service-item">ğŸ¥ <strong>ç§‘å®¤æ¨è</strong> - æ‰¾å¯¹å°±è¯Šç§‘å®¤</div>
                                        <div class="service-item">ğŸ’Š <strong>ç”¨è¯å’¨è¯¢</strong> - è¯å“ä½¿ç”¨æŒ‡å¯¼</div>
                                        <div class="service-item">ğŸ“… <strong>é¢„çº¦æŒ‚å·</strong> - åœ¨çº¿é¢„çº¦åŒ»ç”Ÿ</div>
                                        <div class="service-item">ğŸ“‹ <strong>é¢„çº¦æŸ¥è¯¢</strong> - ç®¡ç†æ‚¨çš„é¢„çº¦</div>
                                        <div class="service-item">ğŸ”” <strong>é¢„çº¦éšè®¿</strong> - è·Ÿè¸ªåº·å¤æƒ…å†µ</div>
                                        <div class="service-item">ğŸ“‚ <strong>æ²»ç–—æ¡£æ¡ˆ</strong> - æŸ¥çœ‹ç—…å†è®°å½•</div>
                                        <div class="service-item">ğŸ“š <strong>å¥åº·æ•™è‚²</strong> - å¥åº·çŸ¥è¯†æ™®åŠ</div>
                                    </div>
                                    <div class="welcome-tip">ğŸ’¡ ç‚¹å‡»ä¸Šæ–¹å¿«æ·å¡ç‰‡æˆ–ç›´æ¥è¾“å…¥æ‚¨çš„é—®é¢˜</div>
                                </div>
                            </div>
                        </div>
                        <div class="quick-actions">
                            <button class="quick-btn" onclick="sendQuickMessage('æˆ‘å¤´ç—›æ€ä¹ˆåŠ')">ğŸ©º æˆ‘å¤´ç—›æ€ä¹ˆåŠ</button>
                            <button class="quick-btn" onclick="sendQuickMessage('å¤´ç—›æŒ‚ä»€ä¹ˆç§‘')">ğŸ¥ å¤´ç—›æŒ‚ä»€ä¹ˆç§‘</button>
                            <button class="quick-btn" onclick="sendQuickMessage('é˜¿è«è¥¿æ—æ€ä¹ˆåƒ')">ğŸ’Š é˜¿è«è¥¿æ—æ€ä¹ˆåƒ</button>
                            <button class="quick-btn" onclick="sendQuickMessage('æˆ‘æƒ³æŒ‚å·')">ğŸ“… æˆ‘æƒ³æŒ‚å·</button>
                        </div>
                        <div class="chat-input-area">
                            <input type="text" id="chat-input" placeholder="è¾“å…¥æ‚¨çš„å¥åº·é—®é¢˜ï¼Œå¦‚ï¼šæˆ‘å¤´ç—›æ€ä¹ˆåŠ..." onkeypress="handleKeyPress(event)">
                            <button onclick="sendChatMessage()">å‘é€</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç—‡çŠ¶å’¨è¯¢é¡µé¢ -->
            <div class="page" id="page-symptom">
                <div class="symptom-page">
                    <div class="form-card">
                        <h3>ğŸ©º ç—‡çŠ¶æ™ºèƒ½åˆ†æ</h3>
                        <div class="form-group">
                            <label class="form-label">æ‚¨æœ‰å“ªäº›ä¸é€‚ï¼Ÿ</label>
                            <textarea class="form-textarea" id="symptom-desc" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„ç—‡çŠ¶ï¼Œå¦‚ï¼šå¤´ç—›ã€å‘çƒ­ã€å’³å—½çš„æŒç»­æ—¶é—´ã€ä¸¥é‡ç¨‹åº¦ç­‰..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å¸¸è§ç—‡çŠ¶ï¼ˆå¯å¤šé€‰ï¼‰</label>
                            <div class="symptom-tags">
                                <span class="symptom-tag" onclick="toggleSymptom(this)">å¤´ç—›</span>
                                <span class="symptom-tag" onclick="toggleSymptom(this)">å‘çƒ­</span>
                                <span class="symptom-tag" onclick="toggleSymptom(this)">å’³å—½</span>
                                <span class="symptom-tag" onclick="toggleSymptom(this)">æ¶å¿ƒ</span>
                                <span class="symptom-tag" onclick="toggleSymptom(this)">å‘•å</span>
                                <span class="symptom-tag" onclick="toggleSymptom(this)">è…¹æ³»</span>
                                <span class="symptom-tag" onclick="toggleSymptom(this)">èƒ¸é—·</span>
                                <span class="symptom-tag" onclick="toggleSymptom(this)">æ°”çŸ­</span>
                                <span class="symptom-tag" onclick="toggleSymptom(this)">è…¹ç—›</span>
                                <span class="symptom-tag" onclick="toggleSymptom(this)">å¤±çœ </span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç—‡çŠ¶æŒç»­æ—¶é—´</label>
                            <select class="form-select" id="symptom-duration">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="today">ä»Šå¤©åˆšå¼€å§‹</option>
                                <option value="days">1-3å¤©</option>
                                <option value="week">çº¦ä¸€å‘¨</option>
                                <option value="weeks">è¶…è¿‡ä¸€å‘¨</option>
                                <option value="month">æŒç»­ä¸€ä¸ªæœˆä»¥ä¸Š</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç–¼ç—›/ä¸é€‚ç¨‹åº¦</label>
                            <select class="form-select" id="symptom-severity">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="mild">è½»å¾® - å¯ä»¥å¿å—</option>
                                <option value="moderate">ä¸­åº¦ - æœ‰äº›å½±å“ç”Ÿæ´»</option>
                                <option value="severe">ä¸¥é‡ - éš¾ä»¥å¿å—</option>
                            </select>
                        </div>
                        <button class="btn-primary" onclick="analyzeSymptom()">ğŸ” å¼€å§‹åˆ†æç—‡çŠ¶</button>
                    </div>
                    <div class="result-box" id="symptom-result">
                        <div id="symptom-result-content"></div>
                    </div>
                </div>
            </div>

            <!-- ç§‘å®¤æ¨èé¡µé¢ -->
            <div class="page" id="page-department">
                <div class="symptom-page">
                    <div class="form-card">
                        <h3>ğŸ¥ æ™ºèƒ½ç§‘å®¤æ¨è</h3>
                        <p style="color:#666;margin-bottom:20px;">ä¸çŸ¥é“æŒ‚ä»€ä¹ˆç§‘ï¼Ÿå‘Šè¯‰æˆ‘æ‚¨çš„ç—‡çŠ¶ï¼Œæˆ‘æ¥å¸®æ‚¨æ¨è</p>

                        <div class="form-group">
                            <label class="form-label">å¸¸è§ç§‘å®¤å¿«é€Ÿé€‰æ‹©</label>
                            <div class="department-grid">
                                <div class="dept-card" onclick="selectDepartment(this, 'ç¥ç»å†…ç§‘', 'å¤´ç—›ã€å¤´æ™•ã€å¤±çœ ã€ç™«ç—«')">
                                    <div class="dept-icon">ğŸ§ </div>
                                    <div class="dept-name">ç¥ç»å†…ç§‘</div>
                                    <div class="dept-desc">å¤´ç—›ã€å¤´æ™•ã€å¤±çœ </div>
                                </div>
                                <div class="dept-card" onclick="selectDepartment(this, 'å¿ƒè¡€ç®¡å†…ç§‘', 'èƒ¸ç—›ã€å¿ƒæ‚¸ã€é«˜è¡€å‹')">
                                    <div class="dept-icon">â¤ï¸</div>
                                    <div class="dept-name">å¿ƒè¡€ç®¡å†…ç§‘</div>
                                    <div class="dept-desc">èƒ¸ç—›ã€å¿ƒæ‚¸ã€é«˜è¡€å‹</div>
                                </div>
                                <div class="dept-card" onclick="selectDepartment(this, 'å‘¼å¸å†…ç§‘', 'å’³å—½ã€æ°”ä¿ƒã€å‘çƒ­')">
                                    <div class="dept-icon">ğŸ«</div>
                                    <div class="dept-name">å‘¼å¸å†…ç§‘</div>
                                    <div class="dept-desc">å’³å—½ã€æ°”ä¿ƒã€å‘çƒ­</div>
                                </div>
                                <div class="dept-card" onclick="selectDepartment(this, 'æ¶ˆåŒ–å†…ç§‘', 'è…¹ç—›ã€æ¶å¿ƒã€å‘•å')">
                                    <div class="dept-icon">ğŸ¥—</div>
                                    <div class="dept-name">æ¶ˆåŒ–å†…ç§‘</div>
                                    <div class="dept-desc">è…¹ç—›ã€æ¶å¿ƒã€å‘•å</div>
                                </div>
                                <div class="dept-card" onclick="selectDepartment(this, 'å†…åˆ†æ³Œç§‘', 'ç³–å°¿ç—…ã€ç”²çŠ¶è…º')">
                                    <div class="dept-icon">ğŸ”¬</div>
                                    <div class="dept-name">å†…åˆ†æ³Œç§‘</div>
                                    <div class="dept-desc">ç³–å°¿ç—…ã€ç”²çŠ¶è…º</div>
                                </div>
                                <div class="dept-card" onclick="selectDepartment(this, 'éª¨ç§‘', 'å…³èŠ‚ç—›ã€è…°ç—›ã€éª¨æŠ˜')">
                                    <div class="dept-icon">ğŸ¦´</div>
                                    <div class="dept-name">éª¨ç§‘</div>
                                    <div class="dept-desc">å…³èŠ‚ç—›ã€è…°ç—›ã€éª¨æŠ˜</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">æˆ–æè¿°æ‚¨çš„ç—‡çŠ¶</label>
                            <textarea class="form-textarea" id="dept-symptom" placeholder="ä¾‹å¦‚ï¼šæˆ‘æœ€è¿‘ç»å¸¸å¤´ç—›ï¼Œè¿˜æœ‰ç‚¹æ¶å¿ƒ..."></textarea>
                        </div>
                        <button class="btn-primary" onclick="recommendDepartment()">ğŸ¥ æ¨èç§‘å®¤</button>
                    </div>
                    <div class="result-box" id="dept-result">
                        <div id="dept-result-content"></div>
                    </div>
                </div>
            </div>

            <!-- ç”¨è¯å’¨è¯¢é¡µé¢ -->
            <div class="page" id="page-medication">
                <div class="symptom-page">
                    <div class="form-card">
                        <h3>ğŸ’Š è¯å“å’¨è¯¢</h3>
                        <div class="drug-warning" style="background:#fff3cd;border:1px solid #ffc107;border-radius:10px;padding:15px;margin-bottom:20px;font-size:13px;">
                            âš ï¸ <strong>é‡è¦æç¤º</strong>ï¼šæœ¬å’¨è¯¢ä»…ä¾›å‚è€ƒï¼Œä¸èƒ½æ›¿ä»£åŒ»ç”Ÿæˆ–è¯å¸ˆçš„æŒ‡å¯¼ã€‚ç”¨è¯è¯·éµåŒ»å˜±ã€‚
                        </div>

                        <div class="form-group">
                            <label class="form-label">è¯å“åç§°</label>
                            <div class="medication-search">
                                <span class="search-icon">ğŸ”</span>
                                <input type="text" class="form-input" id="medication-name" placeholder="è¯·è¾“å…¥è¯å“åç§°ï¼Œå¦‚ï¼šé˜¿è«è¥¿æ—ã€å¸ƒæ´›èŠ¬">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ</label>
                            <div class="query-options">
                                <div class="query-option" onclick="selectQueryOption(this, 'æ€ä¹ˆåƒ')">
                                    ğŸ“‹ æ€ä¹ˆåƒ/ç”¨æ³•ç”¨é‡
                                </div>
                                <div class="query-option" onclick="selectQueryOption(this, 'å‰¯ä½œç”¨')">
                                    âš ï¸ å‰¯ä½œç”¨
                                </div>
                                <div class="query-option" onclick="selectQueryOption(this, 'ç¦å¿Œ')">
                                    ğŸš« ç¦å¿Œç—‡
                                </div>
                                <div class="query-option" onclick="selectQueryOption(this, 'ç›¸äº’ä½œç”¨')">
                                    ğŸ’Š è¯ç‰©ç›¸äº’ä½œç”¨
                                </div>
                            </div>
                        </div>

                        <button class="btn-primary" onclick="consultMedication()">ğŸ’Š å’¨è¯¢è¯å“</button>
                    </div>
                    <div class="result-box" id="medication-result">
                        <div id="medication-result-content"></div>
                    </div>
                </div>
            </div>

            <!-- é¢„çº¦æŒ‚å·é¡µé¢ -->
            <div class="page" id="page-appointment">
                <div class="symptom-page">
                    <div class="form-card">
                        <h3>ğŸ“… é¢„çº¦æŒ‚å·</h3>

                        <div class="appointment-steps">
                            <div class="step active" id="step1-indicator">
                                <div class="step-number">1</div>
                                <div class="step-title">é€‰æ‹©ç§‘å®¤</div>
                            </div>
                            <div class="step" id="step2-indicator">
                                <div class="step-number">2</div>
                                <div class="step-title">é€‰æ‹©åŒ»ç”Ÿ</div>
                            </div>
                            <div class="step" id="step3-indicator">
                                <div class="step-number">3</div>
                                <div class="step-title">é€‰æ‹©æ—¶é—´</div>
                            </div>
                            <div class="step" id="step4-indicator">
                                <div class="step-number">4</div>
                                <div class="step-title">ç¡®è®¤é¢„çº¦</div>
                            </div>
                        </div>

                        <!-- æ­¥éª¤1: é€‰æ‹©ç§‘å®¤ -->
                        <div class="step-content active" id="step1">
                            <div class="form-group">
                                <label class="form-label">é€‰æ‹©æŒ‚å·ç§‘å®¤</label>
                                <select class="form-select" id="appoint-dept" onchange="updateDoctorList()">
                                    <option value="">è¯·é€‰æ‹©ç§‘å®¤</option>
                                    <option value="å†…ç§‘">å†…ç§‘</option>
                                    <option value="å¤–ç§‘">å¤–ç§‘</option>
                                    <option value="å¦‡ç§‘">å¦‡ç§‘</option>
                                    <option value="å„¿ç§‘">å„¿ç§‘</option>
                                    <option value="éª¨ç§‘">éª¨ç§‘</option>
                                    <option value="çœ¼ç§‘">çœ¼ç§‘</option>
                                    <option value="è€³é¼»å–‰ç§‘">è€³é¼»å–‰ç§‘</option>
                                    <option value="ç¥ç»å†…ç§‘">ç¥ç»å†…ç§‘</option>
                                    <option value="å¿ƒè¡€ç®¡å†…ç§‘">å¿ƒè¡€ç®¡å†…ç§‘</option>
                                    <option value="å‘¼å¸å†…ç§‘">å‘¼å¸å†…ç§‘</option>
                                    <option value="æ¶ˆåŒ–å†…ç§‘">æ¶ˆåŒ–å†…ç§‘</option>
                                    <option value="å†…åˆ†æ³Œç§‘">å†…åˆ†æ³Œç§‘</option>
                                    <option value="çš®è‚¤ç§‘">çš®è‚¤ç§‘</option>
                                    <option value="ä¸­åŒ»ç§‘">ä¸­åŒ»ç§‘</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">åŒ»ç”Ÿç±»å‹</label>
                                <select class="form-select" id="appoint-type" onchange="updateDoctorList()">
                                    <option value="æ™®é€š">æ™®é€šé—¨è¯Š</option>
                                    <option value="ä¸“å®¶">ä¸“å®¶é—¨è¯Š</option>
                                </select>
                            </div>
                            <div style="background:#f0f0ff;border-radius:10px;padding:15px;margin-top:15px;font-size:13px;color:#666;">
                                ğŸ’¡ <strong>æç¤º</strong>ï¼šä¸“å®¶é—¨è¯Šç”±ä¸»ä»»åŒ»å¸ˆ/å‰¯ä¸»ä»»åŒ»å¸ˆåè¯Šï¼Œéœ€æå‰é¢„çº¦ï¼›æ™®é€šé—¨è¯Šç”±ä¸»æ²»åŒ»å¸ˆåè¯Šï¼Œå½“å¤©å¯æŒ‚å·ã€‚
                            </div>
                            <button class="btn-primary" onclick="nextStep(2)" style="margin-top:20px;">ä¸‹ä¸€æ­¥ â†’</button>
                        </div>

                        <!-- æ­¥éª¤2: é€‰æ‹©åŒ»ç”Ÿ -->
                        <div class="step-content" id="step2">
                            <div class="form-group">
                                <label class="form-label">é€‰æ‹©åŒ»ç”Ÿ</label>
                                <div id="doctor-list-container">
                                    <div style="text-align:center;padding:30px;color:#999;">
                                        è¯·å…ˆé€‰æ‹©ç§‘å®¤å’Œé—¨è¯Šç±»å‹
                                    </div>
                                </div>
                            </div>
                            <div style="display:flex;gap:10px;margin-top:20px;">
                                <button class="btn-primary" style="background:#999;" onclick="prevStep(1)">â† ä¸Šä¸€æ­¥</button>
                                <button class="btn-primary" onclick="nextStep(3)">ä¸‹ä¸€æ­¥ â†’</button>
                            </div>
                        </div>

                        <!-- æ­¥éª¤3: é€‰æ‹©æ—¶é—´ -->
                        <div class="step-content" id="step3">
                            <div class="form-group">
                                <label class="form-label">é€‰æ‹©å°±è¯Šæ—¥æœŸ</label>
                                <input type="date" class="form-input" id="appoint-date">
                            </div>
                            <div class="form-group">
                                <label class="form-label">é€‰æ‹©å°±è¯Šæ—¶é—´</label>
                                <div class="time-slots">
                                    <div class="time-slot" onclick="selectTime(this, '08:00')">08:00</div>
                                    <div class="time-slot" onclick="selectTime(this, '09:00')">09:00</div>
                                    <div class="time-slot" onclick="selectTime(this, '10:00')">10:00</div>
                                    <div class="time-slot" onclick="selectTime(this, '11:00')">11:00</div>
                                    <div class="time-slot" onclick="selectTime(this, '14:00')">14:00</div>
                                    <div class="time-slot" onclick="selectTime(this, '15:00')">15:00</div>
                                    <div class="time-slot" onclick="selectTime(this, '16:00')">16:00</div>
                                    <div class="time-slot disabled">17:00</div>
                                </div>
                            </div>
                            <div style="display:flex;gap:10px;margin-top:20px;">
                                <button class="btn-primary" style="background:#999;" onclick="prevStep(2)">â† ä¸Šä¸€æ­¥</button>
                                <button class="btn-primary" onclick="nextStep(4)">ä¸‹ä¸€æ­¥ â†’</button>
                            </div>
                        </div>

                        <!-- æ­¥éª¤4: ç¡®è®¤é¢„çº¦ -->
                        <div class="step-content" id="step4">
                            <div style="background:#f8f9fa;border-radius:12px;padding:20px;">
                                <h4 style="margin-bottom:15px;color:#333;">ğŸ“‹ é¢„çº¦ä¿¡æ¯ç¡®è®¤</h4>
                                <div style="line-height:2;color:#555;">
                                    <p><strong>å°±è¯Šç§‘å®¤ï¼š</strong><span id="confirm-dept">-</span></p>
                                    <p><strong>åŒ»ç”Ÿï¼š</strong><span id="confirm-doctor">-</span> <span id="confirm-title" style="color:#666;font-size:13px;"></span></p>
                                    <p><strong>é—¨è¯Šç±»å‹ï¼š</strong><span id="confirm-type">-</span></p>
                                    <p><strong>å°±è¯Šæ—¥æœŸï¼š</strong><span id="confirm-date">-</span></p>
                                    <p><strong>å°±è¯Šæ—¶é—´ï¼š</strong><span id="confirm-time">-</span></p>
                                    <p style="margin-top:10px;padding-top:10px;border-top:1px solid #ddd;"><strong>æŒ‚å·è´¹ï¼š</strong><span id="confirm-price" style="color:#ff6b35;font-size:18px;font-weight:700;">-</span></p>
                                </div>
                            </div>

                            <div class="form-group" style="margin-top:20px;">
                                <label class="form-label">ğŸ“± è”ç³»æ‰‹æœºå· <span style="color:red;">*</span></label>
                                <input type="tel" class="form-input" id="appoint-phone" placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·ç ï¼Œç”¨äºæ¥æ”¶é¢„çº¦é€šçŸ¥å’ŒæŸ¥è¯¢é¢„çº¦" maxlength="11" oninput="validatePhone(this)">
                                <small style="color:#888;font-size:12px;">è¯·è¾“å…¥çœŸå®æ‰‹æœºå·ï¼Œç”¨äºé¢„çº¦æŸ¥è¯¢å’Œæ¥æ”¶å°±è¯Šæé†’</small>
                            </div>

                            <div style="background:#fff3cd;border-radius:10px;padding:15px;margin-top:15px;font-size:13px;color:#856404;">
                                âš ï¸ <strong>å°±è¯Šé¡»çŸ¥</strong>ï¼šè¯·æŒ‰é¢„çº¦æ—¶é—´æå‰15åˆ†é’Ÿåˆ°è¾¾åŒ»é™¢ï¼Œæºå¸¦èº«ä»½è¯å’Œç›¸å…³ç—…å†èµ„æ–™ã€‚å¦‚éœ€æ”¹æœŸæˆ–å–æ¶ˆï¼Œè¯·è‡³å°‘æå‰24å°æ—¶è”ç³»åŒ»é™¢ã€‚
                            </div>
                            <div style="display:flex;gap:10px;margin-top:20px;">
                                <button class="btn-primary" style="background:#999;" onclick="prevStep(3)">â† ä¸Šä¸€æ­¥</button>
                                <button class="btn-primary" onclick="submitAppointment()">âœ… ç¡®è®¤é¢„çº¦</button>
                            </div>
                        </div>
                    </div>
                    <div class="result-box" id="appointment-result">
                        <div id="appointment-result-content"></div>
                    </div>
                </div>
            </div>

            <!-- é¢„çº¦æŸ¥è¯¢é¡µé¢ -->
            <div class="page" id="page-my-appointment">
                <div class="symptom-page">
                    <div class="form-card">
                        <h3>ğŸ“‹ æˆ‘çš„é¢„çº¦</h3>

                        <div class="form-group">
                            <label class="form-label">è¾“å…¥é¢„çº¦ç¼–å·æˆ–æ‰‹æœºå·æŸ¥è¯¢</label>
                            <div style="display:flex;gap:10px;">
                                <input type="text" class="form-input" id="query-input" placeholder="è¯·è¾“å…¥é¢„çº¦ç¼–å·æˆ–æ‰‹æœºå·">
                                <button class="btn-primary" style="width:auto;min-width:120px;" onclick="queryAppointment()">ğŸ” æŸ¥è¯¢</button>
                            </div>
                        </div>
                    </div>

                    <div id="appointment-list">
                        <!-- é¢„çº¦åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>

                    <div id="appointment-detail" style="display:none;">
                        <!-- é¢„çº¦è¯¦æƒ…å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>

            <!-- å¥åº·æ•™è‚²é¡µé¢ -->
            <div class="page" id="page-health">
                <div class="symptom-page">
                    <div class="health-tips">
                        <h3>ğŸ’¡ æ¯æ—¥å¥åº·å°è´´å£«</h3>
                        <ul>
                            <li>æ¯å¤©å–è¶³8æ¯æ°´ï¼ˆçº¦2000mlï¼‰</li>
                            <li>æ¯å‘¨è¿åŠ¨è‡³å°‘150åˆ†é’Ÿ</li>
                            <li>ä¿è¯7-8å°æ—¶ä¼˜è´¨ç¡çœ </li>
                            <li>æ¯å¤©åƒ5ä»½è”¬èœæ°´æœ</li>
                            <li>å‡å°‘ç›å’Œç³–çš„æ‘„å…¥</li>
                        </ul>
                    </div>

                    <div class="form-card">
                        <h3>ğŸ“š å¥åº·çŸ¥è¯†åº“</h3>
                        <div class="health-categories">
                            <div class="health-category" onclick="getHealthInfo('é«˜è¡€å‹é¢„é˜²')">
                                <div class="health-category-icon">ğŸ’‰</div>
                                <div class="health-category-name">é«˜è¡€å‹é¢„é˜²</div>
                                <div class="health-category-desc">ä½ç›é¥®é£ŸÂ·è§„å¾‹è¿åŠ¨Â·æ§åˆ¶ä½“é‡</div>
                            </div>
                            <div class="health-category" onclick="getHealthInfo('ç³–å°¿ç—…é¥®é£Ÿ')">
                                <div class="health-category-icon">ğŸ¥—</div>
                                <div class="health-category-name">ç³–å°¿ç—…é¥®é£Ÿ</div>
                                <div class="health-category-desc">æ§ç³–Â·ä½GIÂ·å°‘é‡å¤šé¤</div>
                            </div>
                            <div class="health-category" onclick="getHealthInfo('è¿åŠ¨å»ºè®®')">
                                <div class="health-category-icon">ğŸƒ</div>
                                <div class="health-category-name">è¿åŠ¨å»ºè®®</div>
                                <div class="health-category-desc">æœ‰æ°§è¿åŠ¨Â·åŠ›é‡è®­ç»ƒÂ·æŸ”éŸ§æ€§</div>
                            </div>
                            <div class="health-category" onclick="getHealthInfo('ç¡çœ å¥åº·')">
                                <div class="health-category-icon">ğŸ˜´</div>
                                <div class="health-category-name">ç¡çœ å¥åº·</div>
                                <div class="health-category-desc">è§„å¾‹ä½œæ¯Â·ç¡çœ ç¯å¢ƒÂ·æ”¾æ¾æŠ€å·§</div>
                            </div>
                            <div class="health-category" onclick="getHealthInfo('å¿ƒç†å¥åº·')">
                                <div class="health-category-icon">ğŸ§˜</div>
                                <div class="health-category-name">å¿ƒç†å¥åº·</div>
                                <div class="health-category-desc">å‹åŠ›ç®¡ç†Â·æƒ…ç»ªè°ƒèŠ‚Â·å†¥æƒ³æ”¾æ¾</div>
                            </div>
                            <div class="health-category" onclick="getHealthInfo('è¥å…»è†³é£Ÿ')">
                                <div class="health-category-icon">ğŸ¥•</div>
                                <div class="health-category-name">è¥å…»è†³é£Ÿ</div>
                                <div class="health-category-desc">å‡è¡¡é¥®é£ŸÂ·ç»´ç”Ÿç´ è¡¥å……Â·å¥åº·çƒ¹é¥ª</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">æˆ–ç›´æ¥æœç´¢å¥åº·é—®é¢˜</label>
                            <input type="text" class="form-input" id="health-query" placeholder="ä¾‹å¦‚ï¼šæ€ä¹ˆé¢„é˜²æ„Ÿå†’ã€å‡è‚¥å»ºè®®...">
                        </div>
                        <button class="btn-primary" onclick="searchHealth()">ğŸ“š è·å–å¥åº·å»ºè®®</button>
                    </div>
                    <div class="result-box" id="health-result">
                        <div id="health-result-content"></div>
                    </div>
                </div>
            </div>

            <!-- é¢„çº¦éšè®¿é¡µé¢ -->
            <div class="page" id="page-followup">
                <div class="symptom-page">
                    <div class="form-card">
                        <h3>ğŸ”” é¢„çº¦éšè®¿</h3>
                        <p style="color:#666;margin-bottom:20px;">è®°å½•å°±è¯Šåçš„éšè®¿æƒ…å†µï¼Œè·Ÿè¸ªåº·å¤è¿›å±•</p>

                        <!-- æ‰‹æœºå·è¾“å…¥ -->
                        <div class="form-group">
                            <label class="form-label">ğŸ“± æ‰‹æœºå·ï¼ˆæŸ¥è¯¢IDï¼‰</label>
                            <input type="tel" class="form-input" id="followup-phone" placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·ç " maxlength="11" oninput="validatePhone(this)">
                        </div>

                        <!-- éšè®¿åˆ—è¡¨ -->
                        <div id="followup-list-container">
                            <div style="text-align:center;padding:30px;color:#999;background:#f8f9fa;border-radius:12px;">
                                <div style="font-size:48px;margin-bottom:10px;">ğŸ””</div>
                                <p>è¯·è¾“å…¥æ‰‹æœºå·æŸ¥çœ‹éšè®¿è®°å½•</p>
                            </div>
                        </div>

                        <button class="btn-primary" onclick="loadFollowups()">ğŸ” æŸ¥è¯¢éšè®¿è®°å½•</button>
                    </div>

                    <!-- æ·»åŠ éšè®¿è®°å½• -->
                    <div class="form-card">
                        <h4>ğŸ“ æ·»åŠ éšè®¿è®°å½•</h4>

                        <div class="form-group">
                            <label class="form-label">å…³è”é¢„çº¦</label>
                            <select class="form-select" id="followup-appointment">
                                <option value="">è¯·å…ˆæŸ¥è¯¢é¢„çº¦è®°å½•</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">éšè®¿æ—¥æœŸ</label>
                            <input type="date" class="form-input" id="followup-date">
                        </div>

                        <div class="form-group">
                            <label class="form-label">éšè®¿ç±»å‹</label>
                            <select class="form-select" id="followup-type">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="ç”µè¯éšè®¿">ç”µè¯éšè®¿</option>
                                <option value="çº¿ä¸Šéšè®¿">çº¿ä¸Šéšè®¿</option>
                                <option value="é—¨è¯Šéšè®¿">é—¨è¯Šéšè®¿</option>
                                <option value="ä¸Šé—¨éšè®¿">ä¸Šé—¨éšè®¿</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">éšè®¿å†…å®¹</label>
                            <textarea class="form-textarea" id="followup-content" placeholder="è®°å½•æ‚£è€…çš„ç—‡çŠ¶æ”¹å–„æƒ…å†µã€ç”¨è¯ååº”ã€æ³¨æ„äº‹é¡¹ç­‰..." rows="4"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">åº·å¤è¯„ä¼°</label>
                            <div class="followup-rating">
                                <label><input type="radio" name="rating" value="æ˜æ˜¾å¥½è½¬"> æ˜æ˜¾å¥½è½¬</label>
                                <label><input type="radio" name="rating" value="æœ‰æ‰€æ”¹å–„"> æœ‰æ‰€æ”¹å–„</label>
                                <label><input type="radio" name="rating" value="ç»´æŒç°çŠ¶"> ç»´æŒç°çŠ¶</label>
                                <label><input type="radio" name="rating" value="æœ‰æ‰€åŠ é‡"> æœ‰æ‰€åŠ é‡</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ä¸‹æ¬¡éšè®¿æ—¶é—´</label>
                            <input type="date" class="form-input" id="followup-next-date">
                        </div>

                        <button class="btn-primary" onclick="addFollowup()">âœ… ä¿å­˜éšè®¿è®°å½•</button>
                    </div>
                </div>
            </div>

            <!-- æ²»ç–—æ¡£æ¡ˆé¡µé¢ -->
            <div class="page" id="page-records">
                <div class="symptom-page">
                    <div class="form-card">
                        <h3>ğŸ“‚ æ²»ç–—æ¡£æ¡ˆ</h3>
                        <p style="color:#666;margin-bottom:20px;">æŸ¥çœ‹å®Œæ•´çš„å°±è¯Šå†å²å’Œå¥åº·æ¡£æ¡ˆ</p>

                        <!-- æ‰‹æœºå·è¾“å…¥ -->
                        <div class="form-group">
                            <label class="form-label">ğŸ“± æ‰‹æœºå·ï¼ˆæŸ¥è¯¢IDï¼‰</label>
                            <input type="tel" class="form-input" id="record-phone" placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·ç " maxlength="11" oninput="validatePhone(this)">
                        </div>

                        <button class="btn-primary" onclick="loadMedicalRecords()">ğŸ” æŸ¥è¯¢å¥åº·æ¡£æ¡ˆ</button>
                    </div>

                    <!-- æ¡£æ¡ˆå±•ç¤ºåŒºåŸŸ -->
                    <div id="record-display-area">
                        <div style="text-align:center;padding:40px;color:#999;background:#f8f9fa;border-radius:12px;">
                            <div style="font-size:48px;margin-bottom:10px;">ğŸ“‚</div>
                            <p>è¯·è¾“å…¥æ‰‹æœºå·æŸ¥è¯¢å¥åº·æ¡£æ¡ˆ</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ‚£è€…ä¿¡æ¯ç®¡ç†é¡µé¢ -->
            <div class="page" id="page-patient">
                <div class="symptom-page">
                    <div class="form-card">
                        <h3>ğŸ‘¤ æ‚£è€…ä¿¡æ¯ç®¡ç†</h3>
                        <p style="color:#666;margin-bottom:20px;">ä»¥æ‰‹æœºå·ä¸ºå”¯ä¸€IDç®¡ç†æ‚£è€…åŸºæœ¬ä¿¡æ¯</p>

                        <!-- æœç´¢/åˆ›å»ºæ‚£è€… -->
                        <div class="form-group">
                            <label class="form-label">ğŸ“± æ‚£è€…æ‰‹æœºå·ï¼ˆå”¯ä¸€IDï¼‰</label>
                            <div style="display:flex;gap:10px;">
                                <input type="tel" class="form-input" id="patient-search-phone" placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·ç " maxlength="11" oninput="validatePhone(this)">
                                <button class="btn-primary" style="width:auto;min-width:100px;" onclick="searchPatient()">ğŸ” æœç´¢</button>
                                <button class="btn-primary" style="width:auto;min-width:100px;background:#28a745;" onclick="showNewPatientForm()">â• æ–°å»º</button>
                            </div>
                        </div>
                    </div>

                    <!-- æ‚£è€…ä¿¡æ¯å±•ç¤º/ç¼–è¾‘åŒºåŸŸ -->
                    <div id="patient-display-area">
                        <div style="text-align:center;padding:40px;color:#999;background:#f8f9fa;border-radius:12px;">
                            <div style="font-size:48px;margin-bottom:10px;">ğŸ‘¤</div>
                            <p>è¯·è¾“å…¥æ‰‹æœºå·æœç´¢æˆ–æ–°å»ºæ‚£è€…æ¡£æ¡ˆ</p>
                        </div>
                    </div>

                    <!-- æ‚£è€…ä¿¡æ¯è¡¨å•ï¼ˆé»˜è®¤éšè—ï¼‰ -->
                    <div id="patient-form-area" style="display:none;">
                        <div class="form-card">
                            <h4>ğŸ“ æ‚£è€…åŸºæœ¬ä¿¡æ¯</h4>

                            <div class="form-group">
                                <label class="form-label">ğŸ“± æ‰‹æœºå·ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰</label>
                                <input type="tel" class="form-input" id="patient-phone" placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·ç " maxlength="11" oninput="validatePhone(this)" readonly style="background:#f5f5f5;">
                                <small style="color:#888;">æ‰‹æœºå·æ˜¯æ‚£è€…å”¯ä¸€æ ‡è¯†ï¼Œæ‰€æœ‰åŒ»ç–—è®°å½•éƒ½å°†å…³è”æ­¤æ‰‹æœºå·</small>
                            </div>

                            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;">
                                <div class="form-group">
                                    <label class="form-label">ğŸ‘¤ æ‚£è€…å§“å</label>
                                    <input type="text" class="form-input" id="patient-name" placeholder="è¯·è¾“å…¥çœŸå®å§“å">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ğŸ†” èº«ä»½è¯å·</label>
                                    <input type="text" class="form-input" id="patient-idcard" placeholder="é€‰å¡«ï¼Œ18ä½èº«ä»½è¯å·" maxlength="18">
                                </div>
                            </div>

                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;">
                                <div class="form-group">
                                    <label class="form-label">ğŸ‚ å‡ºç”Ÿæ—¥æœŸ</label>
                                    <input type="date" class="form-input" id="patient-birthday">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">âš§ï¸ æ€§åˆ«</label>
                                    <select class="form-input" id="patient-gender">
                                        <option value="">è¯·é€‰æ‹©</option>
                                        <option value="ç”·">ç”·</option>
                                        <option value="å¥³">å¥³</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ğŸ©¸ è¡€å‹</label>
                                    <select class="form-input" id="patient-blood">
                                        <option value="">æœªçŸ¥</option>
                                        <option value="A">Aå‹</option>
                                        <option value="B">Bå‹</option>
                                        <option value="AB">ABå‹</option>
                                        <option value="O">Oå‹</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">ğŸ  è”ç³»åœ°å€</label>
                                <input type="text" class="form-input" id="patient-address" placeholder="è¯·è¾“å…¥è¯¦ç»†åœ°å€">
                            </div>

                            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;">
                                <div class="form-group">
                                    <label class="form-label">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ç´§æ€¥è”ç³»äºº</label>
                                    <input type="text" class="form-input" id="patient-emergency-name" placeholder="ç´§æ€¥è”ç³»äººå§“å">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ğŸ“ ç´§æ€¥è”ç³»ç”µè¯</label>
                                    <input type="tel" class="form-input" id="patient-emergency-phone" placeholder="ç´§æ€¥è”ç³»äººç”µè¯" maxlength="11">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">ğŸ“‹ è¿‡æ•å²</label>
                                <textarea class="form-input" id="patient-allergies" rows="2" placeholder="è¯·å¡«å†™è¯ç‰©æˆ–é£Ÿç‰©è¿‡æ•å²ï¼Œæ— åˆ™å¡«'æ— '"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">ğŸ¥ æ—¢å¾€ç—…å²</label>
                                <textarea class="form-input" id="patient-history" rows="2" placeholder="è¯·å¡«å†™æ—¢å¾€é‡å¤§ç–¾ç—…å²ï¼Œæ— åˆ™å¡«'æ— '"></textarea>
                            </div>

                            <div style="display:flex;gap:10px;margin-top:20px;">
                                <button class="btn-primary" onclick="savePatientInfo()">ğŸ’¾ ä¿å­˜æ‚£è€…ä¿¡æ¯</button>
                                <button class="btn-primary" style="background:#999;" onclick="cancelPatientEdit()">å–æ¶ˆ</button>
                                <button class="btn-primary" style="background:#dc3545;" onclick="deletePatientInfo()">ğŸ—‘ï¸ åˆ é™¤æ‚£è€…</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ä¿®å¤APIè·¯å¾„ï¼Œç¡®ä¿æŒ‡å‘ /medical/api
        const API_BASE = window.location.protocol + '//' + window.location.host + '/medical/api';
        let currentStep = 1;
        let appointmentData = {};

        // é¡µé¢åˆ‡æ¢
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function() {
                const page = this.dataset.page;
                switchPage(page);
            });
        });

        const pageInfo = {
            'chat': { icon: 'ğŸ’¬', title: 'æ™ºèƒ½å’¨è¯¢' },
            'symptom': { icon: 'ğŸ©º', title: 'ç—‡çŠ¶å’¨è¯¢' },
            'department': { icon: 'ğŸ¥', title: 'ç§‘å®¤æ¨è' },
            'medication': { icon: 'ğŸ’Š', title: 'ç”¨è¯å’¨è¯¢' },
            'appointment': { icon: 'ğŸ“…', title: 'é¢„çº¦æŒ‚å·' },
            'my-appointment': { icon: 'ğŸ“‹', title: 'é¢„çº¦æŸ¥è¯¢' },
            'followup': { icon: 'ğŸ””', title: 'é¢„çº¦éšè®¿' },
            'records': { icon: 'ğŸ“‚', title: 'æ²»ç–—æ¡£æ¡ˆ' },
            'patient': { icon: 'ğŸ‘¤', title: 'æ‚£è€…ä¿¡æ¯' },
            'health': { icon: 'ğŸ“š', title: 'å¥åº·æ•™è‚²' }
        };

        function switchPage(pageName) {
            // æ›´æ–°èœå•çŠ¶æ€
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === pageName) {
                    item.classList.add('active');
                }
            });

            // æ›´æ–°é¡µé¢æ˜¾ç¤º
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('page-' + pageName).classList.add('active');

            // æ›´æ–°æ ‡é¢˜
            document.querySelector('.page-icon').textContent = pageInfo[pageName].icon;
            document.getElementById('page-title').textContent = pageInfo[pageName].title;
        }

        // é€šç”¨æµå¼è¯·æ±‚å‡½æ•°
        async function streamRequest(message, sessionId, contentDiv) {
            const resultBox = contentDiv.closest('.result-box') || contentDiv;
            resultBox.classList.add('show');
            contentDiv.innerHTML = '<p style="color:#888;">æ­£åœ¨å¤„ç†...</p>';

            let fullContent = '';
            let statusInfo = null;

            try {
                const response = await fetch(API_BASE + '/chat/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId,
                        user_id: 'web_user',
                        use_llm: true
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.trim() && line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));

                                // å¤„ç†ä¸åŒç±»å‹çš„äº‹ä»¶
                                if (data.type === 'query_rewrite') {
                                    // æŸ¥è¯¢é‡å†™ - æ˜¾ç¤ºæç¤º
                                    if (data.changed && !statusInfo) {
                                        statusInfo = document.createElement('div');
                                        statusInfo.style.cssText = 'margin: 8px 0; padding: 8px 12px; background: rgba(255,193,7,0.1); border-left: 3px solid #ffc107; border-radius: 4px; font-size: 0.85rem;';
                                        statusInfo.innerHTML = `
                                            <div style="color: #f57c00; font-weight: 600; margin-bottom: 4px;">
                                                <span style="font-size: 1.1em;">âœï¸</span> è¾“å…¥å·²ä¼˜åŒ–
                                            </div>
                                            <div style="color: #666;">
                                                <span style="text-decoration: line-through; opacity: 0.7;">"${data.original}"</span>
                                                <span style="margin: 0 6px;">â†’</span>
                                                <span style="color: #10b981; font-weight: 600;">"${data.rewritten}"</span>
                                            </div>
                                        `;
                                        contentDiv.innerHTML = '';
                                        contentDiv.appendChild(statusInfo);
                                    }
                                } else if (data.type === 'intent_recognition') {
                                    // æ„å›¾è¯†åˆ« - æ˜¾ç¤ºçŠ¶æ€
                                    if (!statusInfo) {
                                        statusInfo = document.createElement('div');
                                        statusInfo.style.cssText = 'margin: 8px 0; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; font-size: 0.85rem; color: #666;';
                                        contentDiv.innerHTML = '';
                                        contentDiv.appendChild(statusInfo);
                                    }
                                    const intentNames = {
                                        'symptom_inquiry': 'ç—‡çŠ¶å’¨è¯¢',
                                        'department_query': 'ç§‘å®¤æŸ¥è¯¢',
                                        'medication_consult': 'ç”¨è¯å’¨è¯¢',
                                        'appointment': 'é¢„çº¦æŒ‚å·',
                                        'health_education': 'å¥åº·æ•™è‚²',
                                        'greeting': 'é—®å€™',
                                        'unknown': 'æœªçŸ¥'
                                    };
                                    statusInfo.innerHTML = `ğŸ¯ è¯†åˆ«æ„å›¾: ${intentNames[data.intent] || data.intent} (ç½®ä¿¡åº¦: ${data.confidence_percent}%)`;
                                } else if (data.type === 'tool_call') {
                                    // å·¥å…·è°ƒç”¨
                                    if (statusInfo) {
                                        const toolNames = {
                                            'symptom-analyzer': 'ğŸ©º ç—‡çŠ¶åˆ†æå™¨',
                                            'department-recommender': 'ğŸ¥ ç§‘å®¤æ¨èå™¨',
                                            'medication-advisor': 'ğŸ’Š ç”¨è¯é¡¾é—®',
                                            'health-educator': 'ğŸ“š å¥åº·æ•™è‚²å¸ˆ',
                                            'greeting-handler': 'ğŸ‘‹ é—®å€™å¤„ç†',
                                            'appointment-service': 'ğŸ“… é¢„çº¦æœåŠ¡'
                                        };
                                        statusInfo.innerHTML += `<br>âš™ï¸ è°ƒç”¨å·¥å…·: ${toolNames[data.tool] || data.tool}`;
                                    }
                                } else if (data.type === 'thinking') {
                                    // AIæ€è€ƒè¿‡ç¨‹
                                    if (statusInfo) {
                                        statusInfo.innerHTML += `<br>ğŸ’­ ${data.content}`;
                                    }
                                } else if (data.type === 'content') {
                                    // å†…å®¹ç”Ÿæˆ
                                    fullContent += data.content;
                                    // ç§»é™¤çŠ¶æ€ä¿¡æ¯ï¼Œæ˜¾ç¤ºå®é™…å†…å®¹
                                    if (statusInfo && statusInfo.parentNode) {
                                        statusInfo.parentNode.removeChild(statusInfo);
                                        statusInfo = null;
                                    }
                                    contentDiv.innerHTML = formatContent(fullContent);
                                } else if (data.type === 'done') {
                                    // å®Œæˆ
                                    break;
                                } else if (data.type === 'error') {
                                    // é”™è¯¯
                                    contentDiv.innerHTML = '<p style="color:red;">é”™è¯¯: ' + data.content + '</p>';
                                    break;
                                }
                            } catch (e) {
                                console.error('Parse error:', e, line);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Stream request error:', error);
                contentDiv.innerHTML = '<p style="color:red;">ç½‘ç»œé”™è¯¯: ' + error.message + '</p>';
            }
        }

        function formatContent(text) {
            // å¤„ç†è¡¨æ ¼ - è½¬æ¢markdownè¡¨æ ¼ä¸ºHTMLè¡¨æ ¼
            text = text.replace(/(\|.+?\|\n)+/g, function(match) {
                const rows = match.trim().split('\n');
                if (rows.length < 2) return match;

                // è·³è¿‡åˆ†éš”è¡Œ
                const dataRows = rows.filter((row, i) => i !== 1 || !row.includes('---'));

                let tableHtml = '<table style="width:100%;border-collapse:collapse;margin:15px 0;background:white;border-radius:8px;overflow:hidden;">';

                dataRows.forEach((row, index) => {
                    const cells = row.split('|').filter(cell => cell.trim() !== '');
                    const isHeader = index === 0 || (index === 1 && rows[1].includes('---'));

                    tableHtml += '<tr>';
                    cells.forEach(cell => {
                        const tag = isHeader ? 'th' : 'td';
                        const style = isHeader
                            ? 'background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:12px;text-align:left;font-weight:600;'
                            : 'padding:12px;border-bottom:1px solid #eee;';
                        tableHtml += `<${tag} style="${style}">${cell.trim()}</${tag}>`;
                    });
                    tableHtml += '</tr>';
                });

                tableHtml += '</table>';
                return tableHtml;
            });

            // å¤„ç†å¤é€‰æ¡†åˆ—è¡¨
            text = text.replace(/^- \[x\] (.+)$/gmi, '<div class="checked-item">âœ… $1</div>');
            text = text.replace(/^- \[ \] (.+)$/gmi, '<div class="unchecked-item">â¬œ $1</div>');

            // å¤„ç†è­¦å‘Šæ¡†
            text = text.replace(/âš ï¸\s*(.+?)(?:\n|$)/g, '<div class="warning-box">âš ï¸ $1</div>');

            // å¤„ç†æˆåŠŸæç¤º
            text = text.replace(/âœ…\s*(.+?)(?:\n|$)/g, '<div class="success-item">âœ… $1</div>');

            // å¤„ç†æ ‡é¢˜
            text = text.replace(/^###\s+(.+)$/gm, '<h4 style="color:#667eea;margin-top:20px;margin-bottom:10px;">$1</h4>');
            text = text.replace(/^##\s+(.+)$/gm, '<h3 style="color:#333;margin-top:20px;margin-bottom:10px;">$1</h3>');
            text = text.replace(/^#\s+(.+)$/gm, '<h2 style="color:#333;margin-top:25px;margin-bottom:15px;">$1</h2>');

            // å¤„ç†ç²—ä½“
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong style="color:#333;">$1</strong>');

            // å¤„ç†æ™®é€šåˆ—è¡¨
            text = text.replace(/^- (.+)$/gm, '<li style="margin:8px 0;padding-left:10px;">$1</li>');
            text = text.replace(/(<li[^>]*>.*<\/li>)/s, '<ul style="list-style:none;padding-left:10px;">$1</ul>');

            // å¤„ç†å¼•ç”¨å—
            text = text.replace(/^> (.+)$/gm, '<blockquote style="border-left:4px solid #667eea;padding-left:15px;margin:15px 0;color:#666;font-style:italic;">$1</blockquote>');

            // å¤„ç†åˆ†éš”çº¿
            text = text.replace(/^---$/gm, '<hr style="border:none;border-top:2px solid #eee;margin:20px 0;">');

            // å¤„ç†æ¢è¡Œ
            text = text.replace(/\n/g, '<br>');

            return text;
        }

        // ============ èŠå¤©é¡µé¢ ============
        // è§¦å‘åŠŸèƒ½å¡ç‰‡ - ç‚¹å‡»å¡ç‰‡æ—¶è·³è½¬åˆ°å¯¹åº”é¡µé¢æˆ–è§¦å‘å¯¹è¯
        function triggerFeature(feature) {
            // éšè—å¿«æ·æœåŠ¡å¡ç‰‡ï¼Œä¸“æ³¨äºåŠŸèƒ½ä½¿ç”¨
            const featureCardsSection = document.querySelector('.feature-cards-section');

            const featureMessages = {
                'symptom': 'æˆ‘æƒ³å’¨è¯¢ç—‡çŠ¶é—®é¢˜',
                'department': 'æˆ‘æƒ³çŸ¥é“æŒ‚ä»€ä¹ˆç§‘',
                'medication': 'æˆ‘æƒ³å’¨è¯¢ç”¨è¯é—®é¢˜',
                'appointment': 'æˆ‘æƒ³æŒ‚å·',
                'my-appointment': 'æˆ‘æƒ³æŸ¥è¯¢æˆ‘çš„é¢„çº¦',
                'followup': 'æˆ‘æƒ³æŸ¥çœ‹éšè®¿æƒ…å†µ',
                'records': 'æˆ‘æƒ³æŸ¥çœ‹æˆ‘çš„å¥åº·æ¡£æ¡ˆ',
                'patient': 'æˆ‘æƒ³ç®¡ç†æ‚£è€…ä¿¡æ¯',
                'health': 'æˆ‘æƒ³äº†è§£å¥åº·çŸ¥è¯†'
            };

            const message = featureMessages[feature] || feature;
            document.getElementById('chat-input').value = message;
            sendChatMessage();
        }

        // æ‰‹æœºå·éªŒè¯
        function validatePhone(input) {
            // åªå…è®¸è¾“å…¥æ•°å­—
            input.value = input.value.replace(/\D/g, '');

            // é™åˆ¶æœ€å¤š11ä½
            if (input.value.length > 11) {
                input.value = input.value.slice(0, 11);
            }
        }

        // éªŒè¯æ‰‹æœºå·æ ¼å¼
        function isValidPhone(phone) {
            return /^1[3-9]\d{9}$/.test(phone);
        }

        // ä¼šè¯é¢„çº¦çŠ¶æ€è·Ÿè¸ª
        let appointmentChatState = {
            active: false,
            step: 0, // 0=æœªå¼€å§‹, 1=é—®ç§‘å®¤, 2=é—®æ—¶é—´, 3=é—®åŒ»ç”Ÿç±»å‹, 4=å®Œæˆ
            dept: null,
            date: null,
            time: null,
            doctorType: null,
            phone: null,  // æ–°å¢æ‰‹æœºå·
            sessionId: null
        };

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            addMessage('user', message);
            input.value = '';

            // æ£€æŸ¥æ˜¯å¦æ˜¯é¢„çº¦ä¼šè¯ä¸­çš„å›å¤
            if (appointmentChatState.active && appointmentChatState.step > 0) {
                handleAppointmentChatResponse(message);
                return;
            }

            // æ£€æŸ¥æ˜¯å¦è§¦å‘é¢„çº¦ä¼šè¯
            const appointmentKeywords = ['æˆ‘æƒ³æŒ‚å·', 'æˆ‘è¦æŒ‚å·', 'æƒ³æŒ‚å·', 'æŒ‚å·', 'é¢„çº¦', 'æˆ‘æƒ³é¢„çº¦', 'æˆ‘è¦é¢„çº¦', 'é¢„çº¦åŒ»ç”Ÿ', 'é¢„çº¦æŒ‚å·'];
            if (appointmentKeywords.some(kw => message.includes(kw))) {
                startAppointmentChat(message);
                return;
            }

            const messagesDiv = document.getElementById('chat-messages');
            const assistantMsg = document.createElement('div');
            assistantMsg.className = 'message assistant';
            assistantMsg.innerHTML = '<div class="process-container"><div class="process-title">ğŸ§  AIæ€è€ƒè¿‡ç¨‹</div><div class="process-item"><span class="process-icon">â³</span><span class="process-text">æ­£åœ¨åˆ†æ...</span></div></div><div class="message-content"></div>';
            messagesDiv.appendChild(assistantMsg);

            const contentDiv = assistantMsg.querySelector('.message-content');
            const processDiv = assistantMsg.querySelector('.process-container');

            streamRequestWithProcess(message, 'chat_session', contentDiv, processDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // å¼€å§‹é¢„çº¦ä¼šè¯
        function startAppointmentChat(message) {
            // åˆå§‹åŒ–é¢„çº¦ä¼šè¯çŠ¶æ€
            appointmentChatState = {
                active: true,
                step: 1,
                dept: null,
                date: null,
                time: null,
                doctorType: null,
                sessionId: 'appointment_chat_' + Date.now()
            };

            // å¦‚æœç”¨æˆ·æ¶ˆæ¯ä¸­åŒ…å«ç§‘å®¤ä¿¡æ¯ï¼Œå°è¯•æå–
            const deptKeywords = {
                'å†…ç§‘': ['å†…ç§‘', 'å¿ƒè„', 'å¿ƒè¡€ç®¡', 'æ¶ˆåŒ–', 'å‘¼å¸', 'å†…åˆ†æ³Œ'],
                'å¤–ç§‘': ['å¤–ç§‘', 'æ‰‹æœ¯', 'éª¨æŠ˜', 'æ‰­ä¼¤'],
                'å¦‡ç§‘': ['å¦‡ç§‘', 'äº§ç§‘', 'å¥³æ€§'],
                'å„¿ç§‘': ['å„¿ç§‘', 'å„¿ç«¥', 'å°å­©', 'å©´å„¿'],
                'éª¨ç§‘': ['éª¨ç§‘', 'éª¨', 'å…³èŠ‚', 'è„ŠæŸ±'],
                'çœ¼ç§‘': ['çœ¼ç§‘', 'çœ¼ç›', 'è§†åŠ›'],
                'è€³é¼»å–‰ç§‘': ['è€³é¼»å–‰', 'è€³æœµ', 'é¼»å­', 'å–‰å’™'],
                'ç¥ç»å†…ç§‘': ['ç¥ç»', 'å¤´ç—›', 'å¤´æ™•', 'å¤±çœ '],
                'çš®è‚¤ç§‘': ['çš®è‚¤', 'æ¹¿ç–¹', 'ç—¤ç–®', 'çš®ç‚'],
                'ä¸­åŒ»ç§‘': ['ä¸­åŒ»', 'ä¸­è¯', 'é’ˆç¸']
            };

            for (const [dept, keywords] of Object.entries(deptKeywords)) {
                if (keywords.some(kw => message.includes(kw))) {
                    appointmentChatState.dept = dept;
                    break;
                }
            }

            // æ˜¾ç¤ºAIå“åº”
            const messagesDiv = document.getElementById('chat-messages');
            const assistantMsg = document.createElement('div');
            assistantMsg.className = 'message assistant';
            assistantMsg.innerHTML = `
                <div class="process-container">
                    <div class="process-title">ğŸ§  AIæ€è€ƒè¿‡ç¨‹</div>
                </div>
                <div class="message-content"></div>
            `;
            messagesDiv.appendChild(assistantMsg);

            const contentDiv = assistantMsg.querySelector('.message-content');
            const processDiv = assistantMsg.querySelector('.process-container');

            // æ·»åŠ æ„å›¾è¯†åˆ«
            addProcessItem(processDiv, 'ğŸ¯', 'æ„å›¾è¯†åˆ«: é¢„çº¦æŒ‚å·', '99%', 'process-badge');
            addProcessItem(processDiv, 'ğŸ“…', 'å¯åŠ¨é¢„çº¦å¼•å¯¼æµç¨‹', '', 'process-status');

            // ç”Ÿæˆæ¬¢è¿æ¶ˆæ¯
            let welcomeMsg = `å¥½çš„ï¼å¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ ğŸ‘<br><br>ä¸ºäº†å¸®æ‚¨å¿«é€Ÿã€å‡†ç¡®åœ°å®Œæˆé¢„çº¦ï¼Œæˆ‘éœ€è¦äº†è§£å‡ ä¸ªå…³é”®ä¿¡æ¯ï¼š`;
            welcomeMsg += `<br><br><strong>ç¬¬1æ­¥ï¼šè¯·é—®æ‚¨æƒ³æŒ‚å“ªä¸ªç§‘å®¤ï¼Ÿ</strong>`;
            welcomeMsg += `<br><br>å¯é€‰ç§‘å®¤åŒ…æ‹¬ï¼šå†…ç§‘ã€å¤–ç§‘ã€å¦‡ç§‘ã€å„¿ç§‘ã€éª¨ç§‘ã€çœ¼ç§‘ã€è€³é¼»å–‰ç§‘ã€ç¥ç»å†…ç§‘ã€å¿ƒè¡€ç®¡å†…ç§‘ã€å‘¼å¸å†…ç§‘ã€æ¶ˆåŒ–å†…ç§‘ã€å†…åˆ†æ³Œç§‘ã€çš®è‚¤ç§‘ã€ä¸­åŒ»ç§‘`;

            if (appointmentChatState.dept) {
                welcomeMsg += `<br><br><em>æˆ‘æ³¨æ„åˆ°æ‚¨å¯èƒ½æƒ³æŒ‚ã€${appointmentChatState.dept}ã€‘ï¼Œè¯·ç¡®è®¤æˆ–å‘Šè¯‰æˆ‘å…¶ä»–ç§‘å®¤ã€‚</em>`;
            }

            contentDiv.innerHTML = welcomeMsg;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            setTimeout(() => {
                processDiv.classList.add('collapsed');
                processDiv.onclick = () => processDiv.classList.toggle('collapsed');
            }, 3000);
        }

        // å¤„ç†é¢„çº¦ä¼šè¯ä¸­çš„ç”¨æˆ·å›å¤
        async function handleAppointmentChatResponse(message) {
            const messagesDiv = document.getElementById('chat-messages');

            // æ ¹æ®å½“å‰æ­¥éª¤å¤„ç†ç”¨æˆ·è¾“å…¥
            switch (appointmentChatState.step) {
                case 1: // è¯¢é—®ç§‘å®¤
                    // æå–ç§‘å®¤
                    const deptMap = {
                        'å†…ç§‘': ['å†…ç§‘'],
                        'å¤–ç§‘': ['å¤–ç§‘'],
                        'å¦‡ç§‘': ['å¦‡ç§‘'],
                        'å„¿ç§‘': ['å„¿ç§‘'],
                        'éª¨ç§‘': ['éª¨ç§‘'],
                        'çœ¼ç§‘': ['çœ¼ç§‘'],
                        'è€³é¼»å–‰ç§‘': ['è€³é¼»å–‰', 'è€³é¼»å–‰ç§‘'],
                        'ç¥ç»å†…ç§‘': ['ç¥ç»'],
                        'å¿ƒè¡€ç®¡å†…ç§‘': ['å¿ƒè¡€ç®¡', 'å¿ƒè„'],
                        'å‘¼å¸å†…ç§‘': ['å‘¼å¸'],
                        'æ¶ˆåŒ–å†…ç§‘': ['æ¶ˆåŒ–'],
                        'å†…åˆ†æ³Œç§‘': ['å†…åˆ†æ³Œ'],
                        'çš®è‚¤ç§‘': ['çš®è‚¤'],
                        'ä¸­åŒ»ç§‘': ['ä¸­åŒ»']
                    };

                    let foundDept = null;
                    for (const [dept, keywords] of Object.entries(deptMap)) {
                        if (keywords.some(kw => message.includes(kw))) {
                            foundDept = dept;
                            break;
                        }
                    }

                    if (foundDept) {
                        appointmentChatState.dept = foundDept;
                        appointmentChatState.step = 2;

                        addAssistantMessage(`
                            âœ… å·²é€‰æ‹©ï¼š<strong>${foundDept}</strong><br><br>
                            <strong>ç¬¬2æ­¥ï¼šè¯·é—®æ‚¨å¸Œæœ›ä»€ä¹ˆæ—¶é—´å°±è¯Šï¼Ÿ</strong><br><br>
                            è¯·å‘Šè¯‰æˆ‘æ‚¨æ–¹ä¾¿çš„æ—¥æœŸï¼ˆå¦‚ï¼šæ˜å¤©ã€æœ¬å‘¨äº”ã€12æœˆ10æ—¥ï¼‰
                        `);
                    } else {
                        addAssistantMessage(`
                            âš ï¸ æŠ±æ­‰ï¼Œæˆ‘æ²¡æœ‰è¯†åˆ«åˆ°ç§‘å®¤ä¿¡æ¯ã€‚<br><br>
                            è¯·ä»ä»¥ä¸‹ç§‘å®¤ä¸­é€‰æ‹©ï¼š<br>
                            å†…ç§‘ã€å¤–ç§‘ã€å¦‡ç§‘ã€å„¿ç§‘ã€éª¨ç§‘ã€çœ¼ç§‘ã€è€³é¼»å–‰ç§‘ã€ç¥ç»å†…ç§‘ã€å¿ƒè¡€ç®¡å†…ç§‘ã€å‘¼å¸å†…ç§‘ã€æ¶ˆåŒ–å†…ç§‘ã€å†…åˆ†æ³Œç§‘ã€çš®è‚¤ç§‘ã€ä¸­åŒ»ç§‘
                        `);
                    }
                    break;

                case 2: // è¯¢é—®æ—¶é—´
                    // ç®€å•æå–æ—¥æœŸä¿¡æ¯
                    const dateMatch = message.match(/(\d{1,2})[æœˆ-](\d{1,2})/) ||
                                     message.match(/(\d{4})[å¹´-](\d{1,2})[æœˆ-](\d{1,2})/);
                    const today = new Date();
                    let targetDate = new Date();

                    if (message.includes('æ˜å¤©')) {
                        targetDate.setDate(today.getDate() + 1);
                    } else if (message.includes('åå¤©')) {
                        targetDate.setDate(today.getDate() + 2);
                    } else if (message.includes('å¤§åå¤©')) {
                        targetDate.setDate(today.getDate() + 3);
                    } else if (message.includes('ä¸‹å‘¨ä¸€') || message.includes('ä¸‹å‘¨ä¸€')) {
                        targetDate.setDate(today.getDate() + (1 + 7 - today.getDay()) % 7 + 7);
                    } else if (message.includes('ä¸‹å‘¨äº”') || message.includes('ä¸‹å‘¨äº”')) {
                        targetDate.setDate(today.getDate() + (5 + 7 - today.getDay()) % 7 + 7);
                    } else if (message.includes('å‘¨ä¸€') || message.includes('æ˜ŸæœŸä¸€')) {
                        targetDate.setDate(today.getDate() + (1 + 7 - today.getDay()) % 7);
                    } else if (message.includes('å‘¨äºŒ') || message.includes('æ˜ŸæœŸäºŒ')) {
                        targetDate.setDate(today.getDate() + (2 + 7 - today.getDay()) % 7);
                    } else if (message.includes('å‘¨ä¸‰') || message.includes('æ˜ŸæœŸä¸‰')) {
                        targetDate.setDate(today.getDate() + (3 + 7 - today.getDay()) % 7);
                    } else if (message.includes('å‘¨å››') || message.includes('æ˜ŸæœŸå››')) {
                        targetDate.setDate(today.getDate() + (4 + 7 - today.getDay()) % 7);
                    } else if (message.includes('å‘¨äº”') || message.includes('æ˜ŸæœŸäº”')) {
                        targetDate.setDate(today.getDate() + (5 + 7 - today.getDay()) % 7);
                    } else if (message.includes('å‘¨å…­') || message.includes('æ˜ŸæœŸå…­')) {
                        targetDate.setDate(today.getDate() + (6 + 7 - today.getDay()) % 7);
                    } else if (message.includes('å‘¨æ—¥') || message.includes('æ˜ŸæœŸæ—¥')) {
                        targetDate.setDate(today.getDate() + (7 + 7 - today.getDay()) % 7);
                    } else if (dateMatch) {
                        const month = parseInt(dateMatch[1]);
                        const day = parseInt(dateMatch[2]);
                        targetDate = new Date(today.getFullYear(), month - 1, day);
                    }

                    // å¦‚æœæ—¥æœŸåœ¨è¿‡å»ï¼ŒåŠ ä¸€å¹´
                    if (targetDate < today && !message.includes('ä»Šå¤©')) {
                        targetDate.setFullYear(targetDate.getFullYear() + 1);
                    }

                    appointmentChatState.date = targetDate.toISOString().split('T')[0];
                    appointmentChatState.step = 3;

                    const formattedDate = `${targetDate.getMonth() + 1}æœˆ${targetDate.getDate()}æ—¥`;

                    addAssistantMessage(`
                        âœ… å·²é€‰æ‹©ï¼š<strong>${formattedDate}</strong><br><br>
                        <strong>ç¬¬3æ­¥ï¼šè¯·é—®æ‚¨å¯¹åŒ»ç”Ÿæœ‰åå¥½å—ï¼Ÿ</strong><br><br>
                        <span style="padding:4px 12px;background:#667eea;color:white;border-radius:15px;margin-right:10px;cursor:pointer;" onclick="quickSelectDoctorType('æ™®é€š')">æ™®é€šé—¨è¯Š</span>
                        <span style="padding:4px 12px;background:#764ba2;color:white;border-radius:15px;cursor:pointer;" onclick="quickSelectDoctorType('ä¸“å®¶')">ä¸“å®¶é—¨è¯Š</span><br><br>
                        <small>ğŸ’¡ æ™®é€šé—¨è¯Šç”±ä¸»æ²»åŒ»å¸ˆåè¯Šï¼ŒæŒ‚å·è´¹15-25å…ƒï¼›ä¸“å®¶é—¨è¯Šç”±ä¸»ä»»åŒ»å¸ˆ/å‰¯ä¸»ä»»åŒ»å¸ˆåè¯Šï¼ŒæŒ‚å·è´¹40-60å…ƒ</small>
                    `);
                    break;

                case 3: // è¯¢é—®åŒ»ç”Ÿç±»å‹ï¼Œå®Œæˆåè·³è½¬åˆ°é¢„çº¦é¡µé¢
                    if (message.includes('æ™®é€š') || message.includes('ä¸“å®¶')) {
                        appointmentChatState.doctorType = message.includes('ä¸“å®¶') ? 'ä¸“å®¶' : 'æ™®é€š';
                    } else {
                        appointmentChatState.doctorType = 'æ™®é€š'; // é»˜è®¤æ™®é€š
                    }

                    appointmentChatState.step = 4;

                    addAssistantMessage(`
                        âœ… ä¿¡æ¯æ”¶é›†å®Œæˆï¼<br><br>
                        ğŸ“‹ <strong>é¢„çº¦ä¿¡æ¯æ±‡æ€»ï¼š</strong><br>
                        â€¢ ç§‘å®¤ï¼š${appointmentChatState.dept}<br>
                        â€¢ æ—¥æœŸï¼š${appointmentChatState.date}<br>
                        â€¢ ç±»å‹ï¼š${appointmentChatState.doctorType}é—¨è¯Š<br><br>
                        <span style="color:#667eea;">æ­£åœ¨è·³è½¬åˆ°é¢„çº¦é¡µé¢...</span>
                    `);

                    // å»¶è¿Ÿåè·³è½¬å¹¶é¢„å¡«å……è¡¨å•
                    setTimeout(() => {
                        goToAppointmentWithPreFill();
                    }, 1500);
                    break;
            }

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // å¿«é€Ÿé€‰æ‹©åŒ»ç”Ÿç±»å‹
        function quickSelectDoctorType(type) {
            const input = document.getElementById('chat-input');
            input.value = type + 'é—¨è¯Š';
            sendChatMessage();
        }

        // æ·»åŠ åŠ©æ‰‹æ¶ˆæ¯
        function addAssistantMessage(content) {
            const messagesDiv = document.getElementById('chat-messages');
            const assistantMsg = document.createElement('div');
            assistantMsg.className = 'message assistant';
            assistantMsg.innerHTML = `<div class="message-content">${content}</div>`;
            messagesDiv.appendChild(assistantMsg);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // è·³è½¬åˆ°é¢„çº¦é¡µé¢å¹¶é¢„å¡«å……
        function goToAppointmentWithPreFill() {
            // åˆ‡æ¢åˆ°é¢„çº¦é¡µé¢
            switchPage('appointment');

            // é¢„å¡«å……è¡¨å•
            if (appointmentChatState.dept) {
                document.getElementById('appoint-dept').value = appointmentChatState.dept;
            }
            if (appointmentChatState.doctorType) {
                document.getElementById('appoint-type').value = appointmentChatState.doctorType;
            }

            // æ›´æ–°é¢„çº¦æ•°æ®
            appointmentData.dept = appointmentChatState.dept;
            appointmentData.type = appointmentChatState.doctorType;

            // æ›´æ–°åŒ»ç”Ÿåˆ—è¡¨
            updateDoctorList();

            // å¦‚æœæœ‰æ—¥æœŸï¼Œä¹Ÿå¡«å……
            if (appointmentChatState.date) {
                document.getElementById('appoint-date').value = appointmentChatState.date;
            }

            // è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€æ­¥
            setTimeout(() => {
                nextStep(2);
            }, 500);

            // é‡ç½®ä¼šè¯çŠ¶æ€
            appointmentChatState.active = false;
            appointmentChatState.step = 0;

            // åœ¨èŠå¤©ä¸­æ·»åŠ æç¤ºæ¶ˆæ¯
            addAssistantMessage(`
                âœ… <strong>å·²ä¸ºæ‚¨è·³è½¬åˆ°é¢„çº¦é¡µé¢ï¼</strong><br><br>
                è¡¨å•å·²é¢„å¡«å……æ‚¨æä¾›çš„ä¿¡æ¯ï¼Œè¯·ï¼š<br>
                1. é€‰æ‹©æ‚¨å¿ƒä»ªçš„åŒ»ç”Ÿ<br>
                2. ç¡®è®¤æˆ–è°ƒæ•´å°±è¯Šæ—¶é—´<br>
                3. å®Œæˆé¢„çº¦æäº¤
            `);
        }

        async function streamRequestWithProcess(message, sessionId, contentDiv, processDiv) {
            let fullContent = '';
            let processItems = [];

            // å·¥å…·åç§°æ˜ å°„
            const toolNames = {
                'symptom-analyzer': 'ğŸ©º ç—‡çŠ¶åˆ†æå™¨',
                'department-recommender': 'ğŸ¥ ç§‘å®¤æ¨èå™¨',
                'medication-advisor': 'ğŸ’Š ç”¨è¯é¡¾é—®',
                'health-educator': 'ğŸ“š å¥åº·æ•™è‚²å¸ˆ',
                'greeting-handler': 'ğŸ‘‹ é—®å€™å¤„ç†',
                'appointment-service': 'ğŸ“… é¢„çº¦æœåŠ¡'
            };

            try {
                const response = await fetch(API_BASE + '/chat/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId,
                        user_id: 'web_user',
                        use_llm: true
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.slice(6));

                            // æ„å›¾è¯†åˆ«
                            if (data.type === 'intent_recognition') {
                                const intentNames = {
                                    'symptom_inquiry': 'ç—‡çŠ¶å’¨è¯¢',
                                    'department_query': 'ç§‘å®¤æŸ¥è¯¢',
                                    'medication_consult': 'ç”¨è¯å’¨è¯¢',
                                    'appointment': 'é¢„çº¦æŒ‚å·',
                                    'health_education': 'å¥åº·æ•™è‚²',
                                    'greeting': 'é—®å€™',
                                    'unknown': 'æœªçŸ¥'
                                };
                                addProcessItem(processDiv, 'ğŸ¯', `æ„å›¾è¯†åˆ«: ${intentNames[data.intent] || data.intent}`, `${data.confidence_percent}%`, 'process-badge');
                            }
                            // å·¥å…·è°ƒç”¨
                            else if (data.type === 'tool_call') {
                                addProcessItem(processDiv, 'âš™ï¸', `è°ƒç”¨å·¥å…·: ${toolNames[data.tool] || data.tool}`, 'è¿›è¡Œä¸­...', 'process-status');
                            }
                            // æ€è€ƒè¿‡ç¨‹
                            else if (data.type === 'thinking') {
                                addProcessItem(processDiv, 'ğŸ’­', data.content, '', '');
                            }
                            // å†…å®¹æµ
                            else if (data.type === 'content') {
                                fullContent += data.content;
                                contentDiv.innerHTML = formatContent(fullContent);
                                document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
                            }
                            // å®Œæˆ
                            else if (data.type === 'done') {
                                addProcessItem(processDiv, 'âœ…', 'å“åº”ç”Ÿæˆå®Œæˆ', '', 'process-status');
                            }
                        }
                    }
                }

                // ç¨åéšè—æ€è€ƒè¿‡ç¨‹
                setTimeout(() => {
                    processDiv.classList.add('collapsed');
                    processDiv.onclick = () => {
                        processDiv.classList.toggle('collapsed');
                    };
                }, 3000);

            } catch (error) {
                contentDiv.innerHTML = '<p style="color:red;">ç½‘ç»œé”™è¯¯</p>';
            }
        }

        // æ·»åŠ è¿‡ç¨‹é¡¹åˆ°æ€è€ƒå®¹å™¨
        function addProcessItem(container, icon, text, badge, extraClass) {
            const badgeHtml = badge ? `<span class="process-badge">${badge}</span>` : '';
            const extraClassHtml = extraClass ? ` class="${extraClass}"` : '';
            container.innerHTML += `
                <div class="process-item">
                    <span class="process-icon">${icon}</span>
                    <span class="process-text">${text}</span>${badgeHtml}
                    ${extraClass ? '<span class="process-status">âœ“</span>' : ''}
                </div>
            `;
        }

        function addMessage(type, content) {
            const messagesDiv = document.getElementById('chat-messages');
            const msg = document.createElement('div');
            msg.className = 'message ' + type;
            msg.innerHTML = '<div class="message-content">' + content + '</div>';
            messagesDiv.appendChild(msg);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendQuickMessage(msg) {
            document.getElementById('chat-input').value = msg;
            sendChatMessage();
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') sendChatMessage();
        }

        // ============ ç—‡çŠ¶å’¨è¯¢ ============
        function toggleSymptom(el) {
            el.classList.toggle('selected');
        }

        // ============ ç—‡çŠ¶åˆ†ææµå¼è¯·æ±‚å‡½æ•° ============
        async function streamSymptomAnalysis(symptomData, contentDiv) {
            const resultBox = contentDiv.closest('.result-box') || contentDiv;
            resultBox.classList.add('show');
            contentDiv.innerHTML = '<p style="color:#888;">ğŸ” æ­£åœ¨åˆ†ææ‚¨çš„ç—‡çŠ¶...</p>';

            let fullContent = '';
            let processDiv = null;
            let intentDisplayed = false;

            try {
                const response = await fetch(API_BASE + '/symptom/analyze/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symptoms: symptomData.symptoms,
                        description: symptomData.description,
                        duration: symptomData.duration,
                        severity: symptomData.severity,
                        session_id: 'symptom_page',
                        user_id: 'web_user'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // åˆ›å»ºå¤„ç†è¿›åº¦æ˜¾ç¤º
                processDiv = document.createElement('div');
                processDiv.className = 'process-indicator';
                processDiv.style.cssText = 'margin-bottom:15px;padding:12px;background:#f8f9fa;border-radius:8px;font-size:0.85rem;';
                contentDiv.innerHTML = '';
                contentDiv.appendChild(processDiv);

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.trim() && line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));

                                // æŸ¥è¯¢é‡å†™äº‹ä»¶
                                if (data.type === 'query_rewrite') {
                                    addProcessStep(processDiv, 'âœï¸', 'æŸ¥è¯¢ä¼˜åŒ–', `${data.original} â†’ ${data.rewritten}`, 'warning');
                                }
                                // æ„å›¾è¯†åˆ«äº‹ä»¶
                                else if (data.type === 'intent_recognition') {
                                    if (!intentDisplayed) {
                                        const intentNames = {
                                            'symptom_inquiry': 'ç—‡çŠ¶å’¨è¯¢',
                                            'department_query': 'ç§‘å®¤æŸ¥è¯¢',
                                            'medication_consult': 'ç”¨è¯å’¨è¯¢',
                                            'appointment': 'é¢„çº¦æŒ‚å·',
                                            'health_education': 'å¥åº·æ•™è‚²',
                                            'greeting': 'é—®å€™',
                                            'unknown': 'æœªçŸ¥'
                                        };
                                        addProcessStep(processDiv, 'ğŸ¯', 'æ„å›¾è¯†åˆ«', `${intentNames[data.intent] || data.intent} (ç½®ä¿¡åº¦: ${data.confidence_percent}%)`, 'success');
                                        intentDisplayed = true;
                                    }
                                }
                                // å·¥å…·è°ƒç”¨äº‹ä»¶
                                else if (data.type === 'tool_call') {
                                    const toolNames = {
                                        'symptom-analyzer': 'ğŸ©º ç—‡çŠ¶åˆ†æå™¨',
                                        'department-recommender': 'ğŸ¥ ç§‘å®¤æ¨èå™¨',
                                        'medication-advisor': 'ğŸ’Š ç”¨è¯é¡¾é—®',
                                        'health-educator': 'ğŸ“š å¥åº·æ•™è‚²å¸ˆ'
                                    };
                                    addProcessStep(processDiv, 'âš™ï¸', 'å·¥å…·è°ƒç”¨', toolNames[data.tool] || data.tool, 'info');
                                }
                                // æ€è€ƒè¿‡ç¨‹
                                else if (data.type === 'thinking') {
                                    addProcessStep(processDiv, 'ğŸ’­', 'AIåˆ†æ', data.content, 'info');
                                }
                                // å†…å®¹ç”Ÿæˆ
                                else if (data.type === 'content') {
                                    fullContent += data.content;
                                    // æ˜¾ç¤ºå†…å®¹é¢„è§ˆ
                                    const previewDiv = document.getElementById('symptom-content-preview');
                                    if (!previewDiv) {
                                        const contentPreview = document.createElement('div');
                                        contentPreview.id = 'symptom-content-preview';
                                        contentPreview.style.cssText = 'margin-top:15px;';
                                        contentDiv.appendChild(contentPreview);
                                    }
                                    document.getElementById('symptom-content-preview').innerHTML = formatContent(fullContent);
                                }
                                // å®Œæˆ
                                else if (data.type === 'done') {
                                    // ç§»é™¤è¿›åº¦æŒ‡ç¤ºå™¨ï¼Œåªä¿ç•™å†…å®¹
                                    if (processDiv && processDiv.parentNode) {
                                        processDiv.innerHTML = '<div style="color:#10b981;font-weight:600;">âœ… åˆ†æå®Œæˆ</div>' + processDiv.innerHTML;
                                    }
                                    break;
                                }
                                // é”™è¯¯
                                else if (data.type === 'error') {
                                    contentDiv.innerHTML = '<p style="color:red;">âŒ é”™è¯¯: ' + data.content + '</p>';
                                    break;
                                }
                            } catch (e) {
                                console.error('Parse error:', e, line);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Symptom analysis error:', error);
                contentDiv.innerHTML = '<p style="color:red;">âŒ ç½‘ç»œé”™è¯¯: ' + error.message + '</p>';
            }
        }

        // æ·»åŠ å¤„ç†æ­¥éª¤
        function addProcessStep(container, icon, title, content, type) {
            const colors = {
                success: '#10b981',
                warning: '#f59e0b',
                info: '#3b82f6',
                error: '#ef4444'
            };
            const color = colors[type] || colors.info;
            const step = document.createElement('div');
            step.style.cssText = `display:flex;align-items:center;padding:6px 0;border-bottom:1px solid #e5e7eb;`;
            step.innerHTML = `
                <span style="font-size:1.2em;margin-right:8px;">${icon}</span>
                <span style="font-weight:600;color:#374151;margin-right:8px;">${title}:</span>
                <span style="color:${color};">${content}</span>
            `;
            container.appendChild(step);
        }

        function analyzeSymptom() {
            const desc = document.getElementById('symptom-desc').value.trim();
            const tags = Array.from(document.querySelectorAll('.symptom-tag.selected')).map(el => el.textContent);
            const duration = document.getElementById('symptom-duration').value;
            const severity = document.getElementById('symptom-severity').value;

            // æ„å»ºç»“æ„åŒ–çš„ç—‡çŠ¶æ•°æ®
            const symptomData = {
                symptoms: tags,
                description: desc,
                duration: duration,
                severity: severity
            };

            if (tags.length === 0 && !desc) {
                alert('è¯·é€‰æ‹©ç—‡çŠ¶æ ‡ç­¾æˆ–æè¿°æ‚¨çš„ç—‡çŠ¶');
                return;
            }

            // ä½¿ç”¨ä¸“é—¨çš„ç—‡çŠ¶åˆ†ææµå¼è¯·æ±‚
            streamSymptomAnalysis(symptomData, document.getElementById('symptom-result-content'));
        }

        // ============ ç§‘å®¤æ¨è ============
        function selectDepartment(el, dept, symptoms) {
            document.querySelectorAll('.dept-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('dept-symptom').value = `æˆ‘æƒ³æŒ‚${dept}ï¼Œå› ä¸º${symptoms}`;
        }

        function recommendDepartment() {
            const symptom = document.getElementById('dept-symptom').value.trim();
            if (!symptom) {
                alert('è¯·é€‰æ‹©ç§‘å®¤æˆ–æè¿°ç—‡çŠ¶');
                return;
            }
            streamRequest(symptom, 'dept_page', document.getElementById('dept-result-content'));
        }

        // ============ ç”¨è¯å’¨è¯¢ ============
        let selectedQueryType = '';
        function selectQueryOption(el, type) {
            document.querySelectorAll('.query-option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            selectedQueryType = type;
        }

        function consultMedication() {
            const drug = document.getElementById('medication-name').value.trim();
            if (!drug) {
                alert('è¯·è¾“å…¥è¯å“åç§°');
                return;
            }

            let message = drug;
            if (selectedQueryType) {
                const typeMap = {
                    'æ€ä¹ˆåƒ': 'æ€ä¹ˆåƒ',
                    'å‰¯ä½œç”¨': 'å‰¯ä½œç”¨',
                    'ç¦å¿Œ': 'ç¦å¿Œç—‡',
                    'ç›¸äº’ä½œç”¨': 'è¯ç‰©ç›¸äº’ä½œç”¨'
                };
                message = drug + typeMap[selectedQueryType];
            }

            streamRequest(message, 'medication_page', document.getElementById('medication-result-content'));
        }

        // ============ é¢„çº¦æŒ‚å· ============
        // åŒ»ç”Ÿæ•°æ®åº“
        const doctorDatabase = {
            'ä¸“å®¶': {
                'å†…ç§‘': [
                    { name: 'å¼ å»ºå›½', title: 'ä¸»ä»»åŒ»å¸ˆ', experience: '35å¹´', tags: ['å¿ƒè¡€ç®¡', 'é«˜è¡€å‹', 'å† å¿ƒç—…'], price: '50å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' },
                    { name: 'ææ·‘èŠ¬', title: 'ä¸»ä»»åŒ»å¸ˆ', experience: '30å¹´', tags: ['å†…åˆ†æ³Œ', 'ç³–å°¿ç—…', 'ç”²çŠ¶è…º'], price: '50å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' },
                    { name: 'ç‹æ˜è¿œ', title: 'å‰¯ä¸»ä»»åŒ»å¸ˆ', experience: '25å¹´', tags: ['å‘¼å¸å†…ç§‘', 'æ…¢é˜»è‚º', 'å“®å–˜'], price: '40å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' }
                ],
                'å¿ƒè¡€ç®¡å†…ç§‘': [
                    { name: 'å¼ å»ºå›½', title: 'ä¸»ä»»åŒ»å¸ˆ', experience: '35å¹´', tags: ['å† å¿ƒç—…', 'å¿ƒå¾‹å¤±å¸¸', 'å¿ƒè¡°'], price: '60å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' },
                    { name: 'åˆ˜å¿ƒæ€¡', title: 'ä¸»ä»»åŒ»å¸ˆ', experience: '28å¹´', tags: ['é«˜è¡€å‹', 'å† å¿ƒç—…'], price: '60å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' }
                ],
                'ç¥ç»å†…ç§‘': [
                    { name: 'èµµå¿—å¼º', title: 'ä¸»ä»»åŒ»å¸ˆ', experience: '32å¹´', tags: ['å¤´ç—›', 'å¤±çœ ', 'ç™«ç—«'], price: '60å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' },
                    { name: 'å­™ä¸½å¨Ÿ', title: 'å‰¯ä¸»ä»»åŒ»å¸ˆ', experience: '20å¹´', tags: ['è„‘è¡€ç®¡ç—…', 'å¤´æ™•'], price: '50å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' }
                ],
                'æ¶ˆåŒ–å†…ç§‘': [
                    { name: 'é™ˆæµ·æ³¢', title: 'ä¸»ä»»åŒ»å¸ˆ', experience: '30å¹´', tags: ['èƒƒç‚', 'æºƒç–¡', 'è‚ç—…'], price: '60å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' },
                    { name: 'å‘¨ç¾ç²', title: 'å‰¯ä¸»ä»»åŒ»å¸ˆ', experience: '22å¹´', tags: ['è‚ ç‚', 'æ¶ˆåŒ–ä¸è‰¯'], price: '50å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' }
                ],
                'å‘¼å¸å†…ç§‘': [
                    { name: 'ç‹æ˜è¿œ', title: 'ä¸»ä»»åŒ»å¸ˆ', experience: '25å¹´', tags: ['æ…¢é˜»è‚º', 'å“®å–˜', 'è‚ºç‚'], price: '60å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' },
                    { name: 'å´èŠ³', title: 'å‰¯ä¸»ä»»åŒ»å¸ˆ', experience: '18å¹´', tags: ['æ”¯æ°”ç®¡ç‚', 'å’³å—½'], price: '50å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' }
                ],
                'å†…åˆ†æ³Œç§‘': [
                    { name: 'ææ·‘èŠ¬', title: 'ä¸»ä»»åŒ»å¸ˆ', experience: '30å¹´', tags: ['ç³–å°¿ç—…', 'ç”²çŠ¶è…º', 'ç—›é£'], price: '60å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' },
                    { name: 'éƒ‘ä¼Ÿ', title: 'å‰¯ä¸»ä»»åŒ»å¸ˆ', experience: '20å¹´', tags: ['ç³–å°¿ç—…', 'ä»£è°¢ç»¼åˆå¾'], price: '50å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' }
                ],
                'å¤–ç§‘': [
                    { name: 'é»„å¿—åˆš', title: 'ä¸»ä»»åŒ»å¸ˆ', experience: '28å¹´', tags: ['æ™®å¤–', 'èƒ†å›Š', 'é˜‘å°¾'], price: '60å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' },
                    { name: 'æ—æ™“å', title: 'å‰¯ä¸»ä»»åŒ»å¸ˆ', experience: '20å¹´', tags: ['ç”²çŠ¶è…ºæ‰‹æœ¯', 'ä¹³è…º'], price: '50å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' }
                ],
                'éª¨ç§‘': [
                    { name: 'é©¬å¼º', title: 'ä¸»ä»»åŒ»å¸ˆ', experience: '32å¹´', tags: ['è„ŠæŸ±', 'å…³èŠ‚', 'éª¨æŠ˜'], price: '60å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' },
                    { name: 'å§œå°ç‡•', title: 'å‰¯ä¸»ä»»åŒ»å¸ˆ', experience: '18å¹´', tags: ['è¿åŠ¨æŸä¼¤', 'å…³èŠ‚é•œ'], price: '50å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' }
                ],
                'å¦‡ç§‘': [
                    { name: 'æ¨ä¸½æ¢…', title: 'ä¸»ä»»åŒ»å¸ˆ', experience: '28å¹´', tags: ['å¦‡äº§ç§‘', 'ä¸å­•ä¸è‚²'], price: '50å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' },
                    { name: 'èµµé›…å›', title: 'å‰¯ä¸»ä»»åŒ»å¸ˆ', experience: '18å¹´', tags: ['å¦‡ç§‘ç‚ç—‡', 'æœˆç»ä¸è°ƒ'], price: '40å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' }
                ],
                'å„¿ç§‘': [
                    { name: 'é’±å¤šå¤š', title: 'ä¸»ä»»åŒ»å¸ˆ', experience: '30å¹´', tags: ['å°å„¿å‘¼å¸', 'å°å„¿æ¶ˆåŒ–'], price: '60å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' },
                    { name: 'å­™æµ©ç„¶', title: 'å‰¯ä¸»ä»»åŒ»å¸ˆ', experience: '15å¹´', tags: ['å°å„¿å‘çƒ­', 'ç”Ÿé•¿å‘è‚²'], price: '50å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' }
                ],
                'çœ¼ç§‘': [
                    { name: 'éƒ­æ˜äº®', title: 'ä¸»ä»»åŒ»å¸ˆ', experience: '25å¹´', tags: ['è¿‘è§†', 'ç™½å†…éšœ', 'é’å…‰çœ¼'], price: '50å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' },
                    { name: 'èŒƒå°ä¸½', title: 'å‰¯ä¸»ä»»åŒ»å¸ˆ', experience: '15å¹´', tags: ['ç»“è†œç‚', 'å¹²çœ¼ç—‡'], price: '40å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' }
                ],
                'è€³é¼»å–‰ç§‘': [
                    { name: 'æ¢ä¼Ÿ', title: 'ä¸»ä»»åŒ»å¸ˆ', experience: '22å¹´', tags: ['é¼»ç‚', 'ä¸­è€³ç‚'], price: '50å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' },
                    { name: 'æ–¹èŠ³', title: 'å‰¯ä¸»ä»»åŒ»å¸ˆ', experience: '12å¹´', tags: ['å’½ç‚', 'æ‰æ¡ƒä½“'], price: '40å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' }
                ],
                'çš®è‚¤ç§‘': [
                    { name: 'è®¸æ…§', title: 'ä¸»ä»»åŒ»å¸ˆ', experience: '20å¹´', tags: ['æ¹¿ç–¹', 'ç—¤ç–®', 'çš®ç‚'], price: '50å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' },
                    { name: 'è¢æ³¢', title: 'å‰¯ä¸»ä»»åŒ»å¸ˆ', experience: '12å¹´', tags: ['é“¶å±‘ç—…', 'è¨éº»ç–¹'], price: '40å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' }
                ],
                'ä¸­åŒ»ç§‘': [
                    { name: 'ç™½äº‘é£', title: 'ä¸»ä»»åŒ»å¸ˆ', experience: '40å¹´', tags: ['ä¸­åŒ»å†…ç§‘', 'é’ˆç¸', 'æ¨æ‹¿'], price: '40å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' },
                    { name: 'é™ˆå°é›¨', title: 'å‰¯ä¸»ä»»åŒ»å¸ˆ', experience: '20å¹´', tags: ['ä¸­åŒ»å¦‡ç§‘', 'ä¸­è¯è°ƒç†'], price: '30å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' }
                ]
            },
            'æ™®é€š': {
                'å†…ç§‘': [
                    { name: 'å‘¨ä¼Ÿ', title: 'ä¸»æ²»åŒ»å¸ˆ', experience: '8å¹´', tags: ['å¸¸è§å†…ç§‘', 'æ„Ÿå†’'], price: '20å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' },
                    { name: 'å´æ•', title: 'ä¸»æ²»åŒ»å¸ˆ', experience: '6å¹´', tags: ['æ¶ˆåŒ–', 'å‘¼å¸'], price: '20å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' },
                    { name: 'éƒ‘å¼º', title: 'ä½é™¢åŒ»å¸ˆ', experience: '3å¹´', tags: ['åˆè¯Š', 'ä½“æ£€'], price: '15å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' }
                ],
                'å¿ƒè¡€ç®¡å†…ç§‘': [
                    { name: 'å‘¨ä¼Ÿ', title: 'ä¸»æ²»åŒ»å¸ˆ', experience: '8å¹´', tags: ['é«˜è¡€å‹', 'å† å¿ƒç—…'], price: '25å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' },
                    { name: 'ç‹èŠ³', title: 'ä¸»æ²»åŒ»å¸ˆ', experience: '5å¹´', tags: ['å¿ƒå¾‹å¤±å¸¸'], price: '25å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' }
                ],
                'ç¥ç»å†…ç§‘': [
                    { name: 'ææ˜', title: 'ä¸»æ²»åŒ»å¸ˆ', experience: '7å¹´', tags: ['å¤´ç—›', 'å¤±çœ '], price: '25å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' },
                    { name: 'èµµé™', title: 'ä¸»æ²»åŒ»å¸ˆ', experience: '5å¹´', tags: ['è„‘è¡€ç®¡'], price: '25å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' }
                ],
                'æ¶ˆåŒ–å†…ç§‘': [
                    { name: 'å´æ•', title: 'ä¸»æ²»åŒ»å¸ˆ', experience: '6å¹´', tags: ['èƒƒç‚', 'è‚ ç‚'], price: '25å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' },
                    { name: 'å­™æ°', title: 'ä½é™¢åŒ»å¸ˆ', experience: '2å¹´', tags: ['æ¶ˆåŒ–ä¸è‰¯'], price: '20å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' }
                ],
                'å‘¼å¸å†…ç§‘': [
                    { name: 'éƒ‘å¼º', title: 'ä¸»æ²»åŒ»å¸ˆ', experience: '6å¹´', tags: ['æ”¯æ°”ç®¡ç‚', 'æ„Ÿå†’'], price: '25å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' },
                    { name: 'é’±ä¸½', title: 'ä¸»æ²»åŒ»å¸ˆ', experience: '4å¹´', tags: ['å“®å–˜'], price: '25å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' }
                ],
                'å†…åˆ†æ³Œç§‘': [
                    { name: 'é»„å°çº¢', title: 'ä¸»æ²»åŒ»å¸ˆ', experience: '7å¹´', tags: ['ç³–å°¿ç—…', 'ç”²çŠ¶è…º'], price: '25å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' },
                    { name: 'æ—æ¶›', title: 'ä½é™¢åŒ»å¸ˆ', experience: '3å¹´', tags: ['ä»£è°¢'], price: '20å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' }
                ],
                'å¤–ç§‘': [
                    { name: 'å¼ å‹‡', title: 'ä¸»æ²»åŒ»å¸ˆ', experience: '8å¹´', tags: ['æ™®å¤–', 'å¤–ä¼¤'], price: '25å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' },
                    { name: 'åˆ˜æµ·ç‡•', title: 'ä¸»æ²»åŒ»å¸ˆ', experience: '5å¹´', tags: ['é—¨è¯Šå°æ‰‹æœ¯'], price: '25å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' }
                ],
                'éª¨ç§‘': [
                    { name: 'ç‹å¤§åŠ›', title: 'ä¸»æ²»åŒ»å¸ˆ', experience: '7å¹´', tags: ['éª¨æŠ˜', 'æ‰­ä¼¤'], price: '25å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' },
                    { name: 'èµµä¸½', title: 'ä½é™¢åŒ»å¸ˆ', experience: '3å¹´', tags: ['è¿åŠ¨æŸä¼¤'], price: '20å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' }
                ],
                'å¦‡ç§‘': [
                    { name: 'ç”°é›ª', title: 'ä¸»æ²»åŒ»å¸ˆ', experience: '6å¹´', tags: ['å¦‡ç§‘ç‚ç—‡', 'æœˆç»ä¸è°ƒ'], price: '25å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' },
                    { name: 'å‘¨ä¸½å¨œ', title: 'ä½é™¢åŒ»å¸ˆ', experience: '2å¹´', tags: ['å­•äº§å’¨è¯¢'], price: '20å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' }
                ],
                'å„¿ç§‘': [
                    { name: 'æå°æ³¢', title: 'ä¸»æ²»åŒ»å¸ˆ', experience: '8å¹´', tags: ['å°å„¿æ„Ÿå†’', 'å‘è‚²'], price: '25å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' },
                    { name: 'é™ˆå°é›¨', title: 'ä½é™¢åŒ»å¸ˆ', experience: '3å¹´', tags: ['ç–«è‹—æ¥ç§'], price: '20å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' }
                ],
                'çœ¼ç§‘': [
                    { name: 'èµµæ˜', title: 'ä¸»æ²»åŒ»å¸ˆ', experience: '5å¹´', tags: ['ç»“è†œç‚', 'è¿‘è§†'], price: '25å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' },
                    { name: 'å­™å©·', title: 'ä½é™¢åŒ»å¸ˆ', experience: '2å¹´', tags: ['å¹²çœ¼ç—‡'], price: '20å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' }
                ],
                'è€³é¼»å–‰ç§‘': [
                    { name: 'æ¨å¸†', title: 'ä¸»æ²»åŒ»å¸ˆ', experience: '6å¹´', tags: ['é¼»ç‚', 'å’½ç‚'], price: '25å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' },
                    { name: 'èŒƒä¸½', title: 'ä½é™¢åŒ»å¸ˆ', experience: '2å¹´', tags: ['ä¸­è€³ç‚'], price: '20å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' }
                ],
                'çš®è‚¤ç§‘': [
                    { name: 'å‘¨æ´', title: 'ä¸»æ²»åŒ»å¸ˆ', experience: '5å¹´', tags: ['æ¹¿ç–¹', 'çš®ç‚'], price: '25å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' },
                    { name: 'å´æ¶›', title: 'ä½é™¢åŒ»å¸ˆ', experience: '2å¹´', tags: ['ç—¤ç–®'], price: '20å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' }
                ],
                'ä¸­åŒ»ç§‘': [
                    { name: 'åˆ˜å¤§å¤«', title: 'ä¸»æ²»åŒ»å¸ˆ', experience: '10å¹´', tags: ['ä¸­åŒ»è°ƒç†'], price: '20å…ƒ', avatar: 'ğŸ‘¨â€âš•ï¸' },
                    { name: 'é™ˆåŒ»å¸ˆ', title: 'ä½é™¢åŒ»å¸ˆ', experience: '3å¹´', tags: ['é’ˆç¸'], price: '15å…ƒ', avatar: 'ğŸ‘©â€âš•ï¸' }
                ]
            }
        };

        // æ›´æ–°åŒ»ç”Ÿåˆ—è¡¨
        function updateDoctorList() {
            const dept = document.getElementById('appoint-dept').value;
            const type = document.getElementById('appoint-type').value;
            const container = document.getElementById('doctor-list-container');

            if (!dept || !type) {
                container.innerHTML = '<div style="text-align:center;padding:30px;color:#999;">è¯·å…ˆé€‰æ‹©ç§‘å®¤å’Œé—¨è¯Šç±»å‹</div>';
                return;
            }

            const doctors = doctorDatabase[type][dept] || [];

            if (doctors.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:30px;color:#999;">è¯¥ç§‘å®¤æš‚æ— ' + type + 'åŒ»ç”Ÿï¼Œè¯·é€‰æ‹©å…¶ä»–ç§‘å®¤</div>';
                return;
            }

            let html = '<div class="doctor-list">';
            doctors.forEach(doc => {
                html += `
                    <div class="doctor-card" onclick="selectDoctor(this, '${doc.name}', '${doc.title}', '${doc.tags.join('ã€')}', '${doc.price}')">
                        <div class="doctor-avatar">${doc.avatar}</div>
                        <div class="doctor-info">
                            <div class="doctor-name">${doc.name}</div>
                            <div class="doctor-title">${doc.title} Â· ${doc.experience}</div>
                            <div class="doctor-tags">
                                ${doc.tags.map(tag => `<span class="doctor-tag">${tag}</span>`).join('')}
                            </div>
                            <div style="margin-top:5px;color:#ff6b35;font-weight:600;">${doc.price}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function nextStep(step) {
            if (step === 2) {
                const dept = document.getElementById('appoint-dept').value;
                const type = document.getElementById('appoint-type').value;
                if (!dept) {
                    alert('è¯·é€‰æ‹©ç§‘å®¤');
                    return;
                }
                appointmentData.dept = dept;
                appointmentData.type = type;
            } else if (step === 3) {
                if (!appointmentData.doctor) {
                    alert('è¯·é€‰æ‹©åŒ»ç”Ÿ');
                    return;
                }
            } else if (step === 4) {
                const date = document.getElementById('appoint-date').value;
                if (!date) {
                    alert('è¯·é€‰æ‹©æ—¥æœŸ');
                    return;
                }
                if (!appointmentData.time) {
                    alert('è¯·é€‰æ‹©æ—¶é—´');
                    return;
                }
                appointmentData.date = date;

                // æ˜¾ç¤ºç¡®è®¤ä¿¡æ¯
                document.getElementById('confirm-dept').textContent = appointmentData.dept;
                document.getElementById('confirm-doctor').textContent = appointmentData.doctor;
                document.getElementById('confirm-title').textContent = '(' + appointmentData.doctorTitle + ')';
                document.getElementById('confirm-type').textContent = appointmentData.type + 'é—¨è¯Š';
                document.getElementById('confirm-date').textContent = appointmentData.date;
                document.getElementById('confirm-time').textContent = appointmentData.time;
                document.getElementById('confirm-price').textContent = appointmentData.price || 'å¾…å®š';
            }

            document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');

            document.querySelectorAll('.step').forEach((s, i) => {
                s.classList.remove('active', 'completed');
                if (i + 1 < step) s.classList.add('completed');
                if (i + 1 === step) s.classList.add('active');
            });

            currentStep = step;
        }

        function prevStep(step) {
            document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');

            document.querySelectorAll('.step').forEach((s, i) => {
                s.classList.remove('active', 'completed');
                if (i + 1 < step) s.classList.add('completed');
                if (i + 1 === step) s.classList.add('active');
            });

            currentStep = step;
        }

        function selectDoctor(el, name, title, specialty, price) {
            document.querySelectorAll('.doctor-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            appointmentData.doctor = name;
            appointmentData.doctorTitle = title;
            appointmentData.price = price;
        }

        function selectTime(el, time) {
            if (el.classList.contains('disabled')) return;
            document.querySelectorAll('.time-slot').forEach(t => t.classList.remove('selected'));
            el.classList.add('selected');
            appointmentData.time = time;
        }

        function submitAppointment() {
            // è·å–å¹¶éªŒè¯æ‰‹æœºå·
            const phoneInput = document.getElementById('appoint-phone');
            const phone = phoneInput.value.trim();

            if (!phone) {
                alert('è¯·è¾“å…¥è”ç³»æ‰‹æœºå·');
                phoneInput.focus();
                return;
            }

            if (!isValidPhone(phone)) {
                alert('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·ç ');
                phoneInput.focus();
                return;
            }

            // ä¿å­˜æ‰‹æœºå·åˆ°é¢„çº¦æ•°æ®
            appointmentData.phone = phone;

            // ç”Ÿæˆé¢„çº¦ç¼–å·
            const today = new Date();
            const dateStr = today.getFullYear().toString() +
                          String(today.getMonth() + 1).padStart(2, '0') +
                          String(today.getDate()).padStart(2, '0');
            const randomNum = String(Math.floor(Math.random() * 10000)).padStart(4, '0');
            const bookingNo = 'YY' + dateStr + randomNum;

            // å…ˆä¿å­˜é¢„çº¦æ•°æ®
            saveNewAppointment(bookingNo);

            const message = `æˆ‘æƒ³é¢„çº¦${appointmentData.dept}${appointmentData.type}é—¨è¯Šï¼ŒåŒ»ç”Ÿï¼š${appointmentData.doctor}ï¼Œæ—¶é—´ï¼š${appointmentData.date} ${appointmentData.time}`;
            streamRequest(message, 'appointment_page', document.getElementById('appointment-result-content'));

            // æ˜¾ç¤ºæˆåŠŸå¡ç‰‡
            setTimeout(() => {
                const resultDiv = document.getElementById('appointment-result-content');
                const successHtml = `
                    <div style="background:#d4edda;border:1px solid #c3e6cb;border-radius:12px;padding:25px;text-align:center;margin-top:20px;">
                        <div style="font-size:48px;margin-bottom:10px;">âœ…</div>
                        <h3 style="color:#155724;margin-bottom:15px;">é¢„çº¦æˆåŠŸ</h3>
                        <div style="background:white;border-radius:10px;padding:15px;margin:15px 0;text-align:left;">
                            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;">
                                <span style="color:#666;">é¢„çº¦ç¼–å·</span>
                                <strong style="color:#333;">${bookingNo}</strong>
                            </div>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;">
                                <span style="color:#666;">å°±è¯Šç§‘å®¤</span>
                                <strong style="color:#333;">${appointmentData.dept}</strong>
                            </div>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;">
                                <span style="color:#666;">åŒ»ç”Ÿ</span>
                                <strong style="color:#333;">${appointmentData.doctor} (${appointmentData.doctorTitle})</strong>
                            </div>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;">
                                <span style="color:#666;">é—¨è¯Šç±»å‹</span>
                                <strong style="color:#333;">${appointmentData.type}é—¨è¯Š</strong>
                            </div>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;">
                                <span style="color:#666;">å°±è¯Šæ—¶é—´</span>
                                <strong style="color:#333;">${appointmentData.date} ${appointmentData.time}</strong>
                            </div>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;">
                                <span style="color:#666;">è”ç³»ç”µè¯</span>
                                <strong style="color:#333;">${phone}</strong>
                            </div>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;">
                                <span style="color:#666;">æŒ‚å·è´¹</span>
                                <strong style="color:#ff6b35;font-size:16px;">${appointmentData.price}</strong>
                            </div>
                        </div>
                        <p style="margin-top:15px;color:#155724;font-size:13px;">ğŸ“± è¯·æˆªå›¾ä¿å­˜é¢„çº¦ä¿¡æ¯ï¼Œå°±è¯Šæ—¶è¯·å‡ºç¤ºé¢„çº¦ç¼–å·</p>
                        <p style="margin-top:10px;color:#666;font-size:12px;">ğŸ’¡ æ‚¨å¯ä»¥åœ¨"é¢„çº¦æŸ¥è¯¢"é¡µé¢é€šè¿‡æ‰‹æœºå·æŸ¥è¯¢å’Œç®¡ç†æ‚¨çš„é¢„çº¦</p>
                    </div>
                `;
                resultDiv.innerHTML = successHtml;

                // æ¸…ç©ºæ‰‹æœºå·è¾“å…¥æ¡†ï¼Œæ–¹ä¾¿ä¸‹æ¬¡é¢„çº¦
                phoneInput.value = '';
            }, 2000);
        }

        // ============ é¢„çº¦æŸ¥è¯¢ ============
        // ä»localStorageåŠ è½½é¢„çº¦
        function loadAppointments() {
            const stored = localStorage.getItem('medical_appointments');
            return stored ? JSON.parse(stored) : [];
        }

        // ä¿å­˜é¢„çº¦åˆ°localStorage
        function saveAppointment(appointment) {
            const appointments = loadAppointments();
            appointments.push(appointment);
            localStorage.setItem('medical_appointments', JSON.stringify(appointments));
        }

        // æŸ¥è¯¢é¢„çº¦
        function queryAppointment() {
            const query = document.getElementById('query-input').value.trim();
            if (!query) {
                alert('è¯·è¾“å…¥é¢„çº¦ç¼–å·æˆ–æ‰‹æœºå·');
                return;
            }

            const appointments = loadAppointments();
            const results = appointments.filter(apt => {
                return apt.bookingNo.includes(query) || apt.phone.includes(query);
            });

            const listDiv = document.getElementById('appointment-list');
            const detailDiv = document.getElementById('appointment-detail');

            if (results.length === 0) {
                listDiv.innerHTML = `
                    <div style="text-align:center;padding:40px;color:#999;">
                        <div style="font-size:48px;margin-bottom:15px;">ğŸ“­</div>
                        <p>æœªæ‰¾åˆ°é¢„çº¦è®°å½•</p>
                        <p style="font-size:13px;margin-top:10px;">è¯·æ£€æŸ¥é¢„çº¦ç¼–å·æˆ–æ‰‹æœºå·æ˜¯å¦æ­£ç¡®</p>
                    </div>
                `;
                detailDiv.style.display = 'none';
            } else {
                let html = '<h4 style="margin:20px 0;">æŸ¥è¯¢ç»“æœ (' + results.length + 'æ¡)</h4>';
                results.forEach((apt, index) => {
                    const statusClass = apt.status === 'å·²å°±è¯Š' ? 'completed' : (apt.status === 'å·²å–æ¶ˆ' ? 'cancelled' : 'pending');
                    const statusStyle = {
                        'pending': 'background:#fff3cd;color:#856404;',
                        'completed': 'background:#d4edda;color:#155724;',
                        'cancelled': 'background:#f8d7da;color:#721c24;'
                    };
                    html += `
                        <div class="appointment-item" onclick="showAppointmentDetail('${apt.bookingNo}')" style="background:white;border:1px solid #eee;border-radius:12px;padding:15px;margin-bottom:15px;cursor:pointer;transition:all 0.2s;display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <div style="font-weight:600;color:#333;margin-bottom:5px;">${apt.dept} - ${apt.doctor}</div>
                                <div style="color:#666;font-size:13px;">${apt.date} ${apt.time}</div>
                                <div style="font-size:12px;color:#999;">é¢„çº¦ç¼–å·ï¼š${apt.bookingNo}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;${statusStyle[statusClass]}">${apt.status}</div>
                                <div style="color:#ff6b35;font-weight:600;margin-top:5px;">${apt.price}</div>
                            </div>
                        </div>
                    `;
                });
                listDiv.innerHTML = html;
                detailDiv.style.display = 'none';
            }
        }

        // æ˜¾ç¤ºé¢„çº¦è¯¦æƒ…
        function showAppointmentDetail(bookingNo) {
            const appointments = loadAppointments();
            const apt = appointments.find(a => a.bookingNo === bookingNo);

            if (!apt) return;

            const detailDiv = document.getElementById('appointment-detail');
            const statusClass = apt.status === 'å·²å°±è¯Š' ? 'completed' : (apt.status === 'å·²å–æ¶ˆ' ? 'cancelled' : 'pending');
            const statusStyle = {
                'pending': 'background:#fff3cd;color:#856404;',
                'completed': 'background:#d4edda;color:#155724;',
                'cancelled': 'background:#f8d7da;color:#721c24;'
            };

            detailDiv.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;margin-top:20px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h4>é¢„çº¦è¯¦æƒ…</h4>
                        <span style="padding:6px 16px;border-radius:20px;font-size:13px;font-weight:600;${statusStyle[statusClass]}">${apt.status}</span>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;">
                        <div><span style="color:#999;">é¢„çº¦ç¼–å·</span><br><strong>${apt.bookingNo}</strong></div>
                        <div><span style="color:#999;">å°±è¯Šç§‘å®¤</span><br><strong>${apt.dept}</strong></div>
                        <div><span style="color:#999;">åŒ»ç”Ÿ</span><br><strong>${apt.doctor}</strong></div>
                        <div><span style="color:#999;">åŒ»ç”ŸèŒç§°</span><br><strong>${apt.doctorTitle}</strong></div>
                        <div><span style="color:#999;">é—¨è¯Šç±»å‹</span><br><strong>${apt.type}é—¨è¯Š</strong></div>
                        <div><span style="color:#999;">æŒ‚å·è´¹</span><br><strong style="color:#ff6b35;">${apt.price}</strong></div>
                        <div><span style="color:#999;">å°±è¯Šæ—¥æœŸ</span><br><strong>${apt.date}</strong></div>
                        <div><span style="color:#999;">å°±è¯Šæ—¶é—´</span><br><strong>${apt.time}</strong></div>
                        <div style="grid-column:1/span 2;"><span style="color:#999;">é¢„çº¦æ—¶é—´</span><br><strong>${apt.createdAt}</strong></div>
                    </div>
                    ${apt.status === 'å¾…å°±è¯Š' ? `
                        <div style="margin-top:20px;display:flex;gap:10px;">
                            <button class="btn-primary" style="background:#28a745;" onclick="cancelAppointment('${apt.bookingNo}')">å–æ¶ˆé¢„çº¦</button>
                            <button class="btn-primary" style="background:#17a2b8;" onclick="rescheduleAppointment('${apt.bookingNo}')">æ”¹æœŸé¢„çº¦</button>
                        </div>
                    ` : ''}
                    <button class="btn-primary" style="background:#999;margin-top:15px;" onclick="document.getElementById('appointment-detail').style.display='none'">è¿”å›åˆ—è¡¨</button>
                </div>
            `;
            detailDiv.style.display = 'block';
        }

        // å–æ¶ˆé¢„çº¦
        function cancelAppointment(bookingNo) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆé¢„çº¦å—ï¼Ÿ')) return;

            const appointments = loadAppointments();
            const index = appointments.findIndex(a => a.bookingNo === bookingNo);
            if (index !== -1) {
                appointments[index].status = 'å·²å–æ¶ˆ';
                localStorage.setItem('medical_appointments', JSON.stringify(appointments));
                alert('é¢„çº¦å·²å–æ¶ˆ');
                queryAppointment(); // åˆ·æ–°åˆ—è¡¨
            }
        }

        // ============ é¢„çº¦æ•°æ®å­˜å‚¨å’Œæäº¤ ============
        function saveNewAppointment(bookingNo) {
            const appointment = {
                bookingNo: bookingNo,
                dept: appointmentData.dept,
                doctor: appointmentData.doctor,
                doctorTitle: appointmentData.doctorTitle,
                type: appointmentData.type,
                date: appointmentData.date,
                time: appointmentData.time,
                price: appointmentData.price,
                status: 'å¾…å°±è¯Š',
                createdAt: new Date().toLocaleString('zh-CN'),
                phone: appointmentData.phone || '138****' + Math.floor(Math.random() * 10000) // ä½¿ç”¨çœŸå®æ‰‹æœºå·
            };
            saveAppointment(appointment);

            // åŒæ—¶åˆ›å»ºæˆ–æ›´æ–°æ‚£è€…åŸºæœ¬ä¿¡æ¯æ¡£æ¡ˆ
            getOrCreatePatient(appointment.phone);

            // åŒæ—¶åˆ›å»ºæˆ–æ›´æ–°æ‚£è€…å¥åº·æ¡£æ¡ˆ
            const records = loadMedicalRecordsFromStorage();
            const existingIndex = records.findIndex(r => r.phone === appointment.phone);

            const medicalRecord = existingIndex !== -1 ? records[existingIndex] : {
                phone: appointment.phone,
                createdAt: new Date().toLocaleString('zh-CN')
            };

            // æ›´æ–°é¦–æ¬¡å°±è¯Šæ—¶é—´
            if (!medicalRecord.firstVisit) {
                medicalRecord.firstVisit = appointment.date;
            }

            // æ›´æ–°æœ€è¿‘å°±è¯Šæ—¶é—´
            medicalRecord.lastVisit = appointment.date;
            medicalRecord.lastVisitType = `${appointment.dept} - ${appointment.doctor}`;

            // æ›´æ–°å°±è¯Šç§‘å®¤ç»Ÿè®¡
            if (!medicalRecord.departments) {
                medicalRecord.departments = {};
            }
            const deptKey = appointment.dept;
            if (!medicalRecord.departments[deptKey]) {
                medicalRecord.departments[deptKey] = 0;
            }
            medicalRecord.departments[deptKey]++;

            if (existingIndex !== -1) {
                records[existingIndex] = medicalRecord;
            } else {
                records.push(medicalRecord);
            }
            localStorage.setItem('medical_records', JSON.stringify(records));
        }

        // ============ å¥åº·æ•™è‚² ============
        function getHealthInfo(topic) {
            document.getElementById('health-query').value = `è¯·å‘Šè¯‰æˆ‘å…³äº${topic}çš„å»ºè®®`;
            searchHealth();
        }

        function searchHealth() {
            const query = document.getElementById('health-query').value.trim();
            if (!query) {
                alert('è¯·è¾“å…¥å¥åº·é—®é¢˜');
                return;
            }
            streamRequest(query, 'health_page', document.getElementById('health-result-content'));
        }

        // ============ é¢„çº¦éšè®¿åŠŸèƒ½ ============
        // ä»localStorageåŠ è½½éšè®¿è®°å½•
        function loadFollowupsFromStorage() {
            const stored = localStorage.getItem('medical_followups');
            return stored ? JSON.parse(stored) : [];
        }

        // ä¿å­˜éšè®¿è®°å½•åˆ°localStorage
        function saveFollowupToStorage(followup) {
            const followups = loadFollowupsFromStorage();
            followups.push(followup);
            localStorage.setItem('medical_followups', JSON.stringify(followups));
        }

        // æ ¹æ®æ‰‹æœºå·åŠ è½½éšè®¿è®°å½•
        function loadFollowups() {
            const phone = document.getElementById('followup-phone').value.trim();
            if (!phone) {
                alert('è¯·è¾“å…¥æ‰‹æœºå·');
                return;
            }

            if (!isValidPhone(phone)) {
                alert('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·ç ');
                return;
            }

            const followups = loadFollowupsFromStorage();
            const userFollowups = followups.filter(f => f.phone === phone);

            const container = document.getElementById('followup-list-container');

            if (userFollowups.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:30px;color:#999;background:#f8f9fa;border-radius:12px;">
                        <div style="font-size:48px;margin-bottom:10px;">ğŸ””</div>
                        <p>æš‚æ— éšè®¿è®°å½•</p>
                        <p style="font-size:13px;margin-top:10px;">æ·»åŠ éšè®¿è®°å½•åå¯åœ¨æ­¤æŸ¥çœ‹</p>
                    </div>
                `;
            } else {
                let html = '<h4 style="margin:20px 0;">éšè®¿è®°å½• (' + userFollowups.length + 'æ¡)</h4>';
                userFollowups.forEach(f => {
                    const ratingColors = {
                        'æ˜æ˜¾å¥½è½¬': '#28a745',
                        'æœ‰æ‰€æ”¹å–„': '#82c91e',
                        'ç»´æŒç°çŠ¶': '#ffc107',
                        'æœ‰æ‰€åŠ é‡': '#dc3545'
                    };
                    html += `
                        <div style="background:white;border:1px solid #eee;border-radius:12px;padding:15px;margin-bottom:15px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                                <div>
                                    <div style="font-weight:600;color:#333;">${f.followupType}</div>
                                    <div style="font-size:12px;color:#888;">${f.followupDate}</div>
                                </div>
                                <div style="padding:4px 12px;border-radius:15px;font-size:12px;font-weight:600;background:${ratingColors[f.rating]||'#999'};color:white;">${f.rating}</div>
                            </div>
                            <div style="font-size:13px;color:#666;line-height:1.6;">${f.content}</div>
                            ${f.nextDate ? `<div style="font-size:12px;color:#667eea;margin-top:10px;">ğŸ“… ä¸‹æ¬¡éšè®¿ï¼š${f.nextDate}</div>` : ''}
                        </div>
                    `;
                });
                container.innerHTML = html;

                // åŒæ—¶åŠ è½½é¢„çº¦è®°å½•åˆ°ä¸‹æ‹‰æ¡†
                updateFollowupAppointmentSelect(phone);
            }
        }

        // æ›´æ–°éšè®¿å…³è”é¢„çº¦ä¸‹æ‹‰æ¡†
        function updateFollowupAppointmentSelect(phone) {
            const appointments = loadAppointments();
            const userAppointments = appointments.filter(a => a.phone === phone && a.status === 'å¾…å°±è¯Š');
            const select = document.getElementById('followup-appointment');

            select.innerHTML = '<option value="">è¯·é€‰æ‹©å…³è”é¢„çº¦</option>';
            userAppointments.forEach(apt => {
                select.innerHTML += `<option value="${apt.bookingNo}">${apt.dept} - ${apt.doctor} - ${apt.date}</option>`;
            });
        }

        // æ·»åŠ éšè®¿è®°å½•
        function addFollowup() {
            const phone = document.getElementById('followup-phone').value.trim();
            const appointmentId = document.getElementById('followup-appointment').value;
            const followupDate = document.getElementById('followup-date').value;
            const followupType = document.getElementById('followup-type').value;
            const content = document.getElementById('followup-content').value.trim();
            const ratingInput = document.querySelector('input[name="rating"]:checked');
            const nextDate = document.getElementById('followup-next-date').value;

            if (!phone) {
                alert('è¯·è¾“å…¥æ‰‹æœºå·');
                return;
            }
            if (!isValidPhone(phone)) {
                alert('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·ç ');
                return;
            }
            if (!followupDate) {
                alert('è¯·é€‰æ‹©éšè®¿æ—¥æœŸ');
                return;
            }
            if (!followupType) {
                alert('è¯·é€‰æ‹©éšè®¿ç±»å‹');
                return;
            }
            if (!content) {
                alert('è¯·å¡«å†™éšè®¿å†…å®¹');
                return;
            }
            if (!ratingInput) {
                alert('è¯·é€‰æ‹©åº·å¤è¯„ä¼°');
                return;
            }

            // ç¡®ä¿æ‚£è€…æ¡£æ¡ˆå­˜åœ¨
            getOrCreatePatient(phone);

            const followup = {
                id: 'FU' + Date.now(),
                phone: phone,
                appointmentId: appointmentId,
                followupDate: followupDate,
                followupType: followupType,
                content: content,
                rating: ratingInput.value,
                nextDate: nextDate,
                createdAt: new Date().toLocaleString('zh-CN')
            };

            saveFollowupToStorage(followup);

            // æ¸…ç©ºè¡¨å•
            document.getElementById('followup-content').value = '';
            document.querySelector('input[name="rating"]:checked').checked = false;
            document.getElementById('followup-next-date').value = '';

            alert('éšè®¿è®°å½•å·²ä¿å­˜');
            loadFollowups(); // é‡æ–°åŠ è½½åˆ—è¡¨
        }

        // ============ æ‚£è€…ä¿¡æ¯ç®¡ç†åŠŸèƒ½ ============
        // ä»localStorageåŠ è½½æ‚£è€…æ•°æ®
        function loadPatientsFromStorage() {
            const stored = localStorage.getItem('medical_patients');
            return stored ? JSON.parse(stored) : [];
        }

        // ä¿å­˜æ‚£è€…æ•°æ®åˆ°localStorage
        function savePatientsToStorage(patients) {
            localStorage.setItem('medical_patients', JSON.stringify(patients));
        }

        // æ ¹æ®æ‰‹æœºå·è·å–æ‚£è€…ä¿¡æ¯
        function getPatientByPhone(phone) {
            const patients = loadPatientsFromStorage();
            return patients.find(p => p.phone === phone);
        }

        // ä¿å­˜æˆ–æ›´æ–°æ‚£è€…ä¿¡æ¯
        function savePatientData(patient) {
            const patients = loadPatientsFromStorage();
            const existingIndex = patients.findIndex(p => p.phone === patient.phone);
            patient.updatedAt = new Date().toLocaleString('zh-CN');
            if (existingIndex !== -1) {
                patients[existingIndex] = { ...patients[existingIndex], ...patient };
            } else {
                patient.createdAt = new Date().toLocaleString('zh-CN');
                patients.push(patient);
            }
            savePatientsToStorage(patients);
            return patient;
        }

        // æœç´¢æ‚£è€…
        function searchPatient() {
            const phone = document.getElementById('patient-search-phone').value.trim();
            if (!phone) {
                alert('è¯·è¾“å…¥æ‰‹æœºå·');
                return;
            }
            if (!isValidPhone(phone)) {
                alert('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·ç ');
                return;
            }

            const patient = getPatientByPhone(phone);
            const displayArea = document.getElementById('patient-display-area');
            const formArea = document.getElementById('patient-form-area');

            if (!patient) {
                // æ‚£è€…ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºæ–°å»ºæç¤º
                displayArea.innerHTML = `
                    <div class="form-card">
                        <div style="text-align:center;padding:30px;background:#fff3cd;border-radius:12px;">
                            <div style="font-size:48px;margin-bottom:10px;">ğŸ‘¤</div>
                            <h4 style="color:#856404;margin-bottom:10px;">æœªæ‰¾åˆ°è¯¥æ‚£è€…</h4>
                            <p style="color:#856404;">æ‰‹æœºå· ${phone} å¯¹åº”çš„æ‚£è€…æ¡£æ¡ˆä¸å­˜åœ¨</p>
                            <button class="btn-primary" style="background:#28a745;margin-top:15px;" onclick="createNewPatient('${phone}')">
                                â• åˆ›å»ºæ‚£è€…æ¡£æ¡ˆ
                            </button>
                        </div>
                    </div>
                `;
                formArea.style.display = 'none';
            } else {
                // æ˜¾ç¤ºæ‚£è€…ä¿¡æ¯
                displayPatientInfo(patient);
                formArea.style.display = 'none';
            }
        }

        // æ˜¾ç¤ºæ‚£è€…ä¿¡æ¯
        function displayPatientInfo(patient) {
            const displayArea = document.getElementById('patient-display-area');

            // è·å–å…³è”æ•°æ®
            const appointments = loadAppointments().filter(a => a.phone === patient.phone);
            const followups = loadFollowupsFromStorage().filter(f => f.phone === patient.phone);
            const records = loadMedicalRecordsFromStorage().find(r => r.phone === patient.phone);

            // è®¡ç®—å¹´é¾„
            let age = 'æœªçŸ¥';
            if (patient.birthday) {
                const birthDate = new Date(patient.birthday);
                const today = new Date();
                age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                age += 'å²';
            }

            displayArea.innerHTML = `
                <div class="patient-info-card">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <h4>ğŸ‘¤ æ‚£è€…æ¡£æ¡ˆ</h4>
                        <button class="btn-primary" style="background:white;color:#667eea;padding:8px 20px;" onclick="editPatient('${patient.phone}')">
                            âœï¸ ç¼–è¾‘
                        </button>
                    </div>
                    <div class="patient-info-grid">
                        <div class="patient-info-item">
                            <label>æ‰‹æœºå·ï¼ˆå”¯ä¸€IDï¼‰</label>
                            <span>${patient.phone}</span>
                        </div>
                        <div class="patient-info-item">
                            <label>å§“å</label>
                            <span>${patient.name || 'æœªå¡«å†™'}</span>
                        </div>
                        <div class="patient-info-item">
                            <label>æ€§åˆ«</label>
                            <span>${patient.gender || 'æœªçŸ¥'}</span>
                        </div>
                        <div class="patient-info-item">
                            <label>å¹´é¾„</label>
                            <span>${age}</span>
                        </div>
                        <div class="patient-info-item">
                            <label>è¡€å‹</label>
                            <span>${patient.blood || 'æœªçŸ¥'}</span>
                        </div>
                        <div class="patient-info-item">
                            <label>èº«ä»½è¯å·</label>
                            <span>${patient.idcard || 'æœªå¡«å†™'}</span>
                        </div>
                    </div>
                    ${patient.allergies && patient.allergies !== 'æ— ' ? `
                        <div style="margin-top:15px;padding:12px;background:rgba(255,255,255,0.2);border-radius:10px;">
                            <label style="font-size:12px;">âš ï¸ è¿‡æ•å²</label>
                            <div style="font-weight:600;margin-top:5px;">${patient.allergies}</div>
                        </div>
                    ` : ''}
                    ${patient.history && patient.history !== 'æ— ' ? `
                        <div style="margin-top:15px;padding:12px;background:rgba(255,255,255,0.2);border-radius:10px;">
                            <label style="font-size:12px;">ğŸ¥ æ—¢å¾€ç—…å²</label>
                            <div style="font-weight:600;margin-top:5px;">${patient.history}</div>
                        </div>
                    ` : ''}
                </div>

                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px;">
                    <div class="form-card" style="text-align:center;padding:20px;">
                        <div style="font-size:36px;margin-bottom:10px;">ğŸ“…</div>
                        <div style="font-size:24px;font-weight:600;color:#667eea;">${appointments.length}</div>
                        <div style="color:#666;">é¢„çº¦æ¬¡æ•°</div>
                    </div>
                    <div class="form-card" style="text-align:center;padding:20px;">
                        <div style="font-size:36px;margin-bottom:10px;">ğŸ””</div>
                        <div style="font-size:24px;font-weight:600;color:#667eea;">${followups.length}</div>
                        <div style="color:#666;">éšè®¿æ¬¡æ•°</div>
                    </div>
                    <div class="form-card" style="text-align:center;padding:20px;">
                        <div style="font-size:36px;margin-bottom:10px;">ğŸ¥</div>
                        <div style="font-size:24px;font-weight:600;color:#667eea;">${records && records.departments ? Object.keys(records.departments).length : 0}</div>
                        <div style="color:#666;">å°±è¯Šç§‘å®¤</div>
                    </div>
                </div>

                <div class="form-card">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                        <h4>ğŸ“± è”ç³»ä¿¡æ¯</h4>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;">
                        <div style="padding:15px;background:#f8f9fa;border-radius:10px;">
                            <label style="color:#888;font-size:12px;">ğŸ  è”ç³»åœ°å€</label>
                            <div style="font-weight:600;margin-top:5px;">${patient.address || 'æœªå¡«å†™'}</div>
                        </div>
                        <div style="padding:15px;background:#f8f9fa;border-radius:10px;">
                            <label style="color:#888;font-size:12px;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ç´§æ€¥è”ç³»äºº</label>
                            <div style="font-weight:600;margin-top:5px;">${patient.emergencyName || 'æœªå¡«å†™'} ${patient.emergencyPhone ? '(' + patient.emergencyPhone + ')' : ''}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // æ–°å»ºæ‚£è€…
        function showNewPatientForm() {
            const phone = document.getElementById('patient-search-phone').value.trim();
            if (!phone) {
                alert('è¯·å…ˆè¾“å…¥æ‰‹æœºå·');
                return;
            }
            if (!isValidPhone(phone)) {
                alert('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·ç ');
                return;
            }
            createNewPatient(phone);
        }

        function createNewPatient(phone) {
            const displayArea = document.getElementById('patient-display-area');
            const formArea = document.getElementById('patient-form-area');

            // æ¸…ç©ºè¡¨å•
            document.getElementById('patient-phone').value = phone;
            document.getElementById('patient-name').value = '';
            document.getElementById('patient-idcard').value = '';
            document.getElementById('patient-birthday').value = '';
            document.getElementById('patient-gender').value = '';
            document.getElementById('patient-blood').value = '';
            document.getElementById('patient-address').value = '';
            document.getElementById('patient-emergency-name').value = '';
            document.getElementById('patient-emergency-phone').value = '';
            document.getElementById('patient-allergies').value = '';
            document.getElementById('patient-history').value = '';

            displayArea.innerHTML = '';
            formArea.style.display = 'block';
        }

        // ç¼–è¾‘æ‚£è€…
        function editPatient(phone) {
            const patient = getPatientByPhone(phone);
            if (!patient) {
                alert('æ‚£è€…ä¸å­˜åœ¨');
                return;
            }

            // å¡«å……è¡¨å•
            document.getElementById('patient-phone').value = patient.phone || '';
            document.getElementById('patient-name').value = patient.name || '';
            document.getElementById('patient-idcard').value = patient.idcard || '';
            document.getElementById('patient-birthday').value = patient.birthday || '';
            document.getElementById('patient-gender').value = patient.gender || '';
            document.getElementById('patient-blood').value = patient.blood || '';
            document.getElementById('patient-address').value = patient.address || '';
            document.getElementById('patient-emergency-name').value = patient.emergencyName || '';
            document.getElementById('patient-emergency-phone').value = patient.emergencyPhone || '';
            document.getElementById('patient-allergies').value = patient.allergies || '';
            document.getElementById('patient-history').value = patient.history || '';

            document.getElementById('patient-display-area').innerHTML = '';
            document.getElementById('patient-form-area').style.display = 'block';
        }

        // ä¿å­˜æ‚£è€…ä¿¡æ¯
        function savePatientInfo() {
            const phone = document.getElementById('patient-phone').value.trim();
            const name = document.getElementById('patient-name').value.trim();

            if (!phone) {
                alert('æ‰‹æœºå·ä¸èƒ½ä¸ºç©º');
                return;
            }
            if (!isValidPhone(phone)) {
                alert('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·ç ');
                return;
            }
            if (!name) {
                alert('è¯·è¾“å…¥æ‚£è€…å§“å');
                return;
            }

            const patient = {
                phone: phone,
                name: name,
                idcard: document.getElementById('patient-idcard').value.trim(),
                birthday: document.getElementById('patient-birthday').value,
                gender: document.getElementById('patient-gender').value,
                blood: document.getElementById('patient-blood').value,
                address: document.getElementById('patient-address').value.trim(),
                emergencyName: document.getElementById('patient-emergency-name').value.trim(),
                emergencyPhone: document.getElementById('patient-emergency-phone').value.trim(),
                allergies: document.getElementById('patient-allergies').value.trim() || 'æ— ',
                history: document.getElementById('patient-history').value.trim() || 'æ— '
            };

            savePatientData(patient);
            alert('æ‚£è€…ä¿¡æ¯å·²ä¿å­˜');
            searchPatient(); // åˆ·æ–°æ˜¾ç¤º
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelPatientEdit() {
            document.getElementById('patient-form-area').style.display = 'none';
            const phone = document.getElementById('patient-phone').value;
            if (phone) {
                document.getElementById('patient-search-phone').value = phone;
                searchPatient();
            }
        }

        // åˆ é™¤æ‚£è€…ä¿¡æ¯
        function deletePatientInfo() {
            const phone = document.getElementById('patient-phone').value;
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥æ‚£è€…æ¡£æ¡ˆå—ï¼Ÿ\n\næ³¨æ„ï¼šåˆ é™¤åï¼Œè¯¥æ‰‹æœºå·çš„æ‰€æœ‰é¢„çº¦ã€éšè®¿å’Œæ¡£æ¡ˆè®°å½•å°†å¤±å»æ‚£è€…åŸºæœ¬ä¿¡æ¯å…³è”ã€‚')) {
                return;
            }

            const patients = loadPatientsFromStorage();
            const index = patients.findIndex(p => p.phone === phone);
            if (index !== -1) {
                patients.splice(index, 1);
                savePatientsToStorage(patients);
            }

            alert('æ‚£è€…æ¡£æ¡ˆå·²åˆ é™¤');
            document.getElementById('patient-form-area').style.display = 'none';
            document.getElementById('patient-search-phone').value = '';
            document.getElementById('patient-display-area').innerHTML = `
                <div style="text-align:center;padding:40px;color:#999;background:#f8f9fa;border-radius:12px;">
                    <div style="font-size:48px;margin-bottom:10px;">ğŸ‘¤</div>
                    <p>è¯·è¾“å…¥æ‰‹æœºå·æœç´¢æˆ–æ–°å»ºæ‚£è€…æ¡£æ¡ˆ</p>
                </div>
            `;
        }

        // è·å–æˆ–åˆ›å»ºæ‚£è€…ï¼ˆç”¨äºé¢„çº¦æ—¶è‡ªåŠ¨åˆ›å»ºï¼‰
        function getOrCreatePatient(phone) {
            let patient = getPatientByPhone(phone);
            if (!patient) {
                // è‡ªåŠ¨åˆ›å»ºåŸºç¡€æ‚£è€…æ¡£æ¡ˆ
                patient = {
                    phone: phone,
                    name: '',
                    idcard: '',
                    birthday: '',
                    gender: '',
                    blood: '',
                    address: '',
                    emergencyName: '',
                    emergencyPhone: '',
                    allergies: 'æ— ',
                    history: 'æ— ',
                    createdAt: new Date().toLocaleString('zh-CN'),
                    updatedAt: new Date().toLocaleString('zh-CN')
                };
                savePatientData(patient);
            }
            return patient;
        }

        // ============ æ²»ç–—æ¡£æ¡ˆåŠŸèƒ½ ============
        // ä»localStorageåŠ è½½æ²»ç–—æ¡£æ¡ˆ
        function loadMedicalRecordsFromStorage() {
            const stored = localStorage.getItem('medical_records');
            return stored ? JSON.parse(stored) : [];
        }

        // ä¿å­˜æ²»ç–—æ¡£æ¡ˆåˆ°localStorage
        function saveMedicalRecordToStorage(record) {
            const records = loadMedicalRecordsFromStorage();
            // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨è¯¥æ‰‹æœºå·çš„è®°å½•
            const existingIndex = records.findIndex(r => r.phone === record.phone);
            if (existingIndex !== -1) {
                // æ›´æ–°ç°æœ‰è®°å½•
                records[existingIndex] = { ...records[existingIndex], ...record, updatedAt: new Date().toLocaleString('zh-CN') };
            } else {
                // æ·»åŠ æ–°è®°å½•
                records.push(record);
            }
            localStorage.setItem('medical_records', JSON.stringify(records));
        }

        // æ ¹æ®æ‰‹æœºå·åŠ è½½å¥åº·æ¡£æ¡ˆ
        function loadMedicalRecords() {
            const phone = document.getElementById('record-phone').value.trim();
            if (!phone) {
                alert('è¯·è¾“å…¥æ‰‹æœºå·');
                return;
            }

            if (!isValidPhone(phone)) {
                alert('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·ç ');
                return;
            }

            const records = loadMedicalRecordsFromStorage();
            const userRecord = records.find(r => r.phone === phone);
            const patient = getPatientByPhone(phone);
            const displayArea = document.getElementById('record-display-area');

            // åŒæ—¶åŠ è½½è¯¥æ‚£è€…çš„é¢„çº¦å’Œéšè®¿è®°å½•
            const appointments = loadAppointments();
            const userAppointments = appointments.filter(a => a.phone === phone);
            const followups = loadFollowupsFromStorage();
            const userFollowups = followups.filter(f => f.phone === phone);

            if (!userRecord && !patient) {
                displayArea.innerHTML = `
                    <div class="form-card">
                        <div style="text-align:center;padding:30px;color:#999;">
                            <div style="font-size:48px;margin-bottom:10px;">ğŸ“‚</div>
                            <p>æœªæ‰¾åˆ°è¯¥æ‰‹æœºå·çš„å¥åº·æ¡£æ¡ˆ</p>
                            <p style="font-size:13px;margin-top:10px;">æ‚¨å¯ä»¥å…ˆè¿›è¡Œé¢„çº¦æŒ‚å·ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å»ºç«‹æ¡£æ¡ˆ</p>
                        </div>
                    </div>
                `;
                return;
            }

            // è®¡ç®—å¹´é¾„
            let age = 'æœªçŸ¥';
            if (patient && patient.birthday) {
                const birthDate = new Date(patient.birthday);
                const today = new Date();
                age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                age += 'å²';
            }

            // æ˜¾ç¤ºæ‚£è€…åŸºæœ¬ä¿¡æ¯ï¼ˆæ•´åˆæ‚£è€…æ¡£æ¡ˆå’Œå°±è¯Šè®°å½•ï¼‰
            let html = `
                <div class="patient-info-card">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <h4>ğŸ‘¤ æ‚£è€…ä¿¡æ¯</h4>
                        ${patient ? `<button class="btn-primary" style="background:white;color:#667eea;padding:6px 15px;font-size:13px;" onclick="document.getElementById('patient-search-phone').value='${phone}';document.querySelector('[data-page=\"patient\"]').click();searchPatient();">æŸ¥çœ‹å®Œæ•´æ¡£æ¡ˆ</button>` : '<button class="btn-primary" style="background:white;color:#667eea;padding:6px 15px;font-size:13px;" onclick="document.getElementById(\'patient-search-phone\').value=\''+phone+'\';document.querySelector(\'[data-page=\"patient\"]\').click();createNewPatient(\''+phone+'\');">å®Œå–„æ‚£è€…ä¿¡æ¯</button>'}
                    </div>
                    <div class="patient-info-grid">
                        <div class="patient-info-item">
                            <label>æ‰‹æœºå·ï¼ˆå”¯ä¸€IDï¼‰</label>
                            <span>${phone}</span>
                        </div>
                        <div class="patient-info-item">
                            <label>å§“å</label>
                            <span>${patient ? (patient.name || 'æœªå¡«å†™') : 'æœªå¡«å†™'}</span>
                        </div>
                        <div class="patient-info-item">
                            <label>æ€§åˆ«</label>
                            <span>${patient ? (patient.gender || 'æœªçŸ¥') : 'æœªçŸ¥'}</span>
                        </div>
                        <div class="patient-info-item">
                            <label>å¹´é¾„</label>
                            <span>${age}</span>
                        </div>
                        <div class="patient-info-item">
                            <label>é¦–æ¬¡å°±è¯Š</label>
                            <span>${userRecord ? (userRecord.firstVisit || 'æœ€è¿‘') : 'æ— è®°å½•'}</span>
                        </div>
                        <div class="patient-info-item">
                            <label>æœ€è¿‘å°±è¯Š</label>
                            <span>${userRecord ? (userRecord.lastVisit || 'æ— ') : 'æ— è®°å½•'}</span>
                        </div>
                        <div class="patient-info-item">
                            <label>é¢„çº¦æ¬¡æ•°</label>
                            <span>${userAppointments.length}æ¬¡</span>
                        </div>
                        <div class="patient-info-item">
                            <label>éšè®¿æ¬¡æ•°</label>
                            <span>${userFollowups.length}æ¬¡</span>
                        </div>
                    </div>
                    ${patient && patient.allergies && patient.allergies !== 'æ— ' ? `
                        <div style="margin-top:15px;padding:12px;background:rgba(255,255,255,0.2);border-radius:10px;">
                            <label style="font-size:12px;">âš ï¸ è¿‡æ•å²</label>
                            <div style="font-weight:600;margin-top:5px;">${patient.allergies}</div>
                        </div>
                    ` : ''}
                </div>

                <div class="form-card">
                    <h4>ğŸ“‹ é¢„çº¦è®°å½•</h4>
            `;

            if (userAppointments.length === 0) {
                html += `<p style="color:#999;padding:20px 0;">æš‚æ— é¢„çº¦è®°å½•</p>`;
            } else {
                userAppointments.forEach(apt => {
                    const statusClass = apt.status === 'å·²å°±è¯Š' ? 'completed' : (apt.status === 'å·²å–æ¶ˆ' ? 'cancelled' : 'pending');
                    const statusStyle = {
                        'pending': 'background:#fff3cd;color:#856404;',
                        'completed': 'background:#d4edda;color:#155724;',
                        'cancelled': 'background:#f8d7da;color:#721c24;'
                    };
                    html += `
                        <div style="background:white;border:1px solid #eee;border-radius:10px;padding:12px;margin-bottom:10px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <div>
                                    <div style="font-weight:600;color:#333;">${apt.dept} - ${apt.doctor}</div>
                                    <div style="font-size:12px;color:#888;">${apt.date} ${apt.time}</div>
                                </div>
                                <span style="padding:4px 12px;border-radius:15px;font-size:12px;font-weight:600;${statusStyle[statusClass]}">${apt.status}</span>
                            </div>
                        </div>
                    `;
                });
            }

            html += `</div><div class="form-card"><h4>ğŸ”” éšè®¿è®°å½•</h4>`;

            if (userFollowups.length === 0) {
                html += `<p style="color:#999;padding:20px 0;">æš‚æ— éšè®¿è®°å½•</p>`;
            } else {
                userFollowups.forEach(f => {
                    const ratingColors = {
                        'æ˜æ˜¾å¥½è½¬': '#28a745',
                        'æœ‰æ‰€æ”¹å–„': '#82c91e',
                        'ç»´æŒç°çŠ¶': '#ffc107',
                        'æœ‰æ‰€åŠ é‡': '#dc3545'
                    };
                    html += `
                        <div style="background:white;border:1px solid #eee;border-radius:10px;padding:12px;margin-bottom:10px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                                <div>
                                    <div style="font-weight:600;color:#333;">${f.followupType}</div>
                                    <div style="font-size:12px;color:#888;">${f.followupDate}</div>
                                </div>
                                <span style="padding:4px 12px;border-radius:15px;font-size:12px;font-weight:600;background:${ratingColors[f.rating]||'#999'};color:white;">${f.rating}</span>
                            </div>
                            <div style="font-size:13px;color:#666;">${f.content}</div>
                        </div>
                    `;
                });
            }

            html += `</div>`;
            displayArea.innerHTML = html;
        }

        // è®¾ç½®æ—¥æœŸèŒƒå›´å’ŒåŠ è½½é¢„çº¦
        document.addEventListener('DOMContentLoaded', () => {
            // è®¾ç½®é¢„çº¦æ—¥æœŸèŒƒå›´ï¼ˆä»Šå¤©èµ·30å¤©å†…ï¼‰
            const today = new Date();
            const maxDate = new Date();
            maxDate.setDate(today.getDate() + 30);

            const todayStr = today.toISOString().split('T')[0];
            const maxDateStr = maxDate.toISOString().split('T')[0];

            const dateInput = document.getElementById('appoint-date');
            if (dateInput) {
                dateInput.min = todayStr;
                dateInput.max = maxDateStr;
            }

            // é¡µé¢åˆ‡æ¢æ—¶åŠ è½½é¢„çº¦åˆ—è¡¨
            document.querySelector('[data-page="my-appointment"]').addEventListener('click', () => {
                const appointments = loadAppointments();
                const listDiv = document.getElementById('appointment-list');
                if (appointments.length === 0) {
                    listDiv.innerHTML = `
                        <div style="text-align:center;padding:40px;color:#999;">
                            <div style="font-size:48px;margin-bottom:15px;">ğŸ“‹</div>
                            <p>æš‚æ— é¢„çº¦è®°å½•</p>
                            <p style="font-size:13px;margin-top:10px;">æ‚¨å¯ä»¥é€šè¿‡"é¢„çº¦æŒ‚å·"åŠŸèƒ½è¿›è¡Œé¢„çº¦</p>
                        </div>
                    `;
                } else {
                    // æ˜¾ç¤ºæœ€è¿‘çš„é¢„çº¦
                    let html = '<h4 style="margin:20px 0;">æˆ‘çš„é¢„çº¦ (' + appointments.length + 'æ¡)</h4>';
                    appointments.forEach(apt => {
                        const statusClass = apt.status === 'å·²å°±è¯Š' ? 'completed' : (apt.status === 'å·²å–æ¶ˆ' ? 'cancelled' : 'pending');
                        const statusStyle = {
                            'pending': 'background:#fff3cd;color:#856404;',
                            'completed': 'background:#d4edda;color:#155724;',
                            'cancelled': 'background:#f8d7da;color:#721c24;'
                        };
                        html += `
                            <div class="appointment-item" onclick="showAppointmentDetail('${apt.bookingNo}')" style="background:white;border:1px solid #eee;border-radius:12px;padding:15px;margin-bottom:15px;cursor:pointer;transition:all 0.2s;display:flex;justify-content:space-between;align-items:center;">
                                <div>
                                    <div style="font-weight:600;color:#333;margin-bottom:5px;">${apt.dept} - ${apt.doctor}</div>
                                    <div style="color:#666;font-size:13px;">${apt.date} ${apt.time}</div>
                                    <div style="font-size:12px;color:#999;">é¢„çº¦ç¼–å·ï¼š${apt.bookingNo}</div>
                                </div>
                                <div style="text-align:right;">
                                    <div style="padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;${statusStyle[statusClass]}">${apt.status}</div>
                                    <div style="color:#ff6b35;font-weight:600;margin-top:5px;">${apt.price}</div>
                                </div>
                            </div>
                        `;
                    });
                    listDiv.innerHTML = html;
                }
            });
        });
    </script>
</body>
</html>

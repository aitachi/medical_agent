# 医疗智能助手产品文档

## 版本信息

| 项目 | 内容 |
|------|------|
| 产品名称 | 医疗智能助手 (Medical AI Assistant) |
| 版本号 | v1.0.0 |
| 文档日期 | 2026-01-27 |
| 产品定位 | 基于Agent架构的医疗场景智能对话助手 |

---

## 1. 产品概述

### 1.1 产品简介

医疗智能助手是一个基于多Agent架构的医疗场景对话系统，通过意图识别、实体抽取、槽位填充等技术，实现智能问诊、症状分析、健康咨询等功能。

### 1.2 核心价值

- **智能分诊**：根据患者描述自动识别科室
- **症状分析**：结构化提取症状信息，辅助医生问诊
- **健康咨询**：提供常见健康问题的解答
- **可扩展架构**：基于MCP协议的工具整合机制

### 1.3 应用场景

| 场景 | 描述 |
|------|------|
| 线上问诊预检 | 用户就诊前收集症状信息，提高问诊效率 |
| 健康咨询 | 常见疾病、用药、检查等健康问题解答 |
| 挂号导诊 | 根据症状推荐挂号科室 |
| 用药提醒 | 处方药用药指导与提醒服务 |

---

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           用户输入层                                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐                │
│  │  文本    │  │  语音    │  │   图片   │  │  文件    │                │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘                │
└───────┼────────────┼────────────┼────────────┼─────────────────────────┘
        │            │            │            │
        └────────────┴────────────┴────────────┘
                             │
┌─────────────────────────────────────────────────────────────────────────┐
│                        Agent 处理层                                      │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    Agent Dispatcher (调度器)                     │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │    │
│  │  │ 意图识别器   │  │ 对话管理器   │  │ 响应生成器   │              │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘              │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                              │                                           │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    Agent Pipeline (处理管道)                     │    │
│  │                                                                   │    │
│  │  输入 ─→ [预处理] ─→ [意图识别] ─→ [实体抽取] ─→ [槽位填充]        │    │
│  │         ↓         ↓           ↓            ↓                     │    │
│  │      [Hooks]   [Hooks]     [Hooks]      [Hooks]                  │    │
│  │         ↓         ↓           ↓            ↓                     │    │
│  │      [验证]    [路由]      [解析]       [补全]                   │    │
│  │         ↓         ↓           ↓            ↓                     │    │
│  │        └─────────┴───────────┴────────────┘                     │    │
│  │                         ↓                                        │    │
│  │                   [决策分发]                                      │    │
│  └─────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────────────┐
│                         Skill 调用层                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                 │
│  │ 症状分析Skill │  │ 科室推荐Skill │  │ 用药咨询Skill │                 │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘                 │
│         │                 │                 │                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                 │
│  │ 挂号服务Skill │  │ 健康问答Skill │  │ 报告解读Skill │                 │
│  └──────────────┘  └──────────────┘  └──────────────┘                 │
└─────────────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────────────┐
│                         MCP 工具层                                       │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                        MCP Server Manager                        │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │    │
│  │  │ 医疗知识库   │  │ 医院信息系统 │  │ 检验检查库   │              │    │
│  │  │ MCP Server  │  │ MCP Server  │  │ MCP Server  │              │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘              │    │
│  │                                                                   │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │    │
│  │  │ 药品数据库   │  │ 挂号系统     │  │ 报告生成器   │              │    │
│  │  │ MCP Server  │  │ MCP Server  │  │ MCP Server  │              │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘              │    │
│  └─────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────────────┐
│                         数据存储层                                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐                │
│  │ 用户数据  │  │ 对话历史  │  │ 医疗知识  │  │ 系统配置  │                │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘                │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Agent 处理框架

### 3.1 Agent 处理流程

```
                    ┌─────────────────┐
                    │   用户输入       │
                    │  "我头痛三天了"  │
                    └────────┬────────┘
                             │
                             ▼
        ┌──────────────────────────────────────┐
        │         1. 输入预处理 (Preprocess)     │
        │  - 文本清洗                           │
        │  - 格式统一                           │
        │  - 语言检测                           │
        │  - @ Hook: before_preprocess          │
        └──────────────────┬───────────────────┘
                           │
                           ▼
        ┌──────────────────────────────────────┐
        │         2. 意图识别 (Intent Detect)    │
        │  - 分类模型预测                       │
        │  - 意图置信度计算                     │
        │  - @ Hook: before_intent              │
        │  - @ Hook: after_intent               │
        │  - @ Hook: intent_fallback            │
        │                                       │
        │  意图类型:                            │
        │  · SYMPTOM_INQUIRY     症状咨询       │
        │  · DEPARTMENT_QUERY    科室查询       │
        │  · MEDICATION_CONSULT  用药咨询       │
        │  · APPOINTMENT_BOOK    挂号预约       │
        │  · REPORT_INTERPRET    报告解读       │
        │  · HEALTH_EDU          健康教育       │
        │  · CHITCHAT            闲聊           │
        │  · UNKNOWN             未知意图       │
        └──────────────────┬───────────────────┘
                           │
                           ▼
        ┌──────────────────────────────────────┐
        │         3. 实体抽取 (Entity Extract)   │
        │  - 医学实体NER                       │
        │  - 时间/数值抽取                      │
        │  - @ Hook: before_extract             │
        │  - @ Hook: after_extract              │
        │  - @ Hook: entity_normalize           │
        │                                       │
        │  实体类型:                            │
        │  · BODY_PART       身体部位           │
        │  · SYMPTOM         症状               │
        │  · DISEASE         疾病               │
        │  · MEDICINE        药物               │
        │  · TIME_DURATION   时间时长           │
        │  · SEVERITY        严重程度           │
        │  · AGE             年龄               │
        │  · GENDER          性别               │
        └──────────────────┬───────────────────┘
                           │
                           ▼
        ┌──────────────────────────────────────┐
        │         4. 槽位填充 (Slot Filling)     │
        │  - 必填槽位检查                       │
        │  - 缺失槽位识别                       │
        │  - 多轮对话收集                       │
        │  - @ Hook: before_fill                │
        │  - @ Hook: slot_required              │
        │  - @ Hook: slot_conflict              │
        │  - @ Hook: after_fill                 │
        │                                       │
        │  示例槽位模板:                        │
        │  symptom_inquiry_slots: {             │
        │    body_part: "头部",                 │
        │    symptom: "疼痛",                   │
        │    duration: "3天",                   │
        │    severity: null,      # 需追问     │
        │    accompanying: null  # 需追问     │
        │  }                                    │
        └──────────────────┬───────────────────┘
                           │
                           ▼
        ┌──────────────────────────────────────┐
        │         5. 决策分发 (Decision Dispatch)│
        │  - 意图-Skill映射                     │
        │  - 参数完整性校验                     │
        │  - @ Hook: before_dispatch            │
        │  - @ Hook: skill_select               │
        │  - @ Hook: after_dispatch             │
        └──────────────────┬───────────────────┘
                           │
                           ▼
        ┌──────────────────────────────────────┐
        │         6. Skill 执行                 │
        │  - 调用对应Skill                      │
        │  - MCP工具调用                        │
        │  - 结果聚合                           │
        │  - @ Hook: before_execute             │
        │  - @ Hook: after_execute              │
        │  - @ Hook: on_error                   │
        └──────────────────┬───────────────────┘
                           │
                           ▼
        ┌──────────────────────────────────────┐
        │         7. 响应生成 (Response Gen)     │
        │  - 模板填充                           │
        │  - 自然语言生成                       │
        │  - @ Hook: before_response            │
        │  - @ Hook: format_response            │
        │  - @ Hook: after_response             │
        └──────────────────┬───────────────────┘
                           │
                           ▼
                    ┌─────────────────┐
                    │   用户输出       │
                    │  "请问头痛是..." │
                    └─────────────────┘
```

### 3.2 意图识别 (Intent Detection)

#### 3.2.1 意图定义

```yaml
intents:
  SYMPTOM_INQUIRY:
    description: "用户咨询症状相关问题"
    examples:
      - "我头疼好几天了"
      - "最近总是咳嗽"
      - "肚子疼是怎么回事"
    priority: 1
    confidence_threshold: 0.75

  DEPARTMENT_QUERY:
    description: "用户询问应该挂哪个科室"
    examples:
      - "头疼应该挂什么科"
      - "看皮肤病去哪个科室"
      - "骨科在哪里"
    priority: 2
    confidence_threshold: 0.75

  MEDICATION_CONSULT:
    description: "用户咨询用药相关问题"
    examples:
      - "阿莫西林怎么吃"
      - "这个药有什么副作用"
      - "感冒了吃什么药好"
    priority: 3
    confidence_threshold: 0.70

  APPOINTMENT_BOOK:
    description: "用户要挂号或预约"
    examples:
      - "我想挂个号"
      - "预约明天的门诊"
      - "帮我挂号"
    priority: 4
    confidence_threshold: 0.80

  REPORT_INTERPRET:
    description: "用户要求解读检查报告"
    examples:
      - "帮我看看这个报告"
      - "血常规结果正常吗"
      - "这个指标偏高是什么意思"
    priority: 5
    confidence_threshold: 0.70

  HEALTH_EDU:
    description: "健康知识科普"
    examples:
      - "怎么预防高血压"
      - "糖尿病不能吃什么"
      - "怎么保持健康"
    priority: 6
    confidence_threshold: 0.65

  CHITCHAT:
    description: "日常闲聊"
    examples:
      - "你好"
      - "谢谢"
      - "今天天气怎么样"
    priority: 99
    confidence_threshold: 0.60

  UNKNOWN:
    description: "无法识别的意图"
    default_action: "clarification"
```

#### 3.2.2 意图识别接口

```python
class IntentDetector:
    """意图识别器"""

    async def detect(
        self,
        text: str,
        context: DialogueContext
    ) -> IntentResult:
        """
        识别用户意图

        Args:
            text: 用户输入文本
            context: 对话上下文

        Returns:
            IntentResult: 意图识别结果
        """
        pass
```

### 3.3 实体抽取 (Entity Extraction)

#### 3.3.1 医学实体定义

```yaml
entities:
  BODY_PART:
    description: "身体部位"
    extraction_method: "ner"
    values:
      - 头部、颈部、胸部、腹部、背部、四肢
      - 眼、耳、鼻、喉、口
      - 心脏、肝脏、肾脏等器官

  SYMPTOM:
    description: "症状描述"
    extraction_method: "ner"
    values:
      - 疼痛、发热、咳嗽、恶心、呕吐
      - 头晕、乏力、失眠、食欲不振

  DISEASE:
    description: "疾病名称"
    extraction_method: "ner + knowledge_base"
    values: [从医学知识库动态加载]

  MEDICINE:
    description: "药物名称"
    extraction_method: "ner + drug_database"
    values: [从药品数据库动态加载]

  TIME_DURATION:
    description: "时间时长"
    extraction_method: "rule + regex"
    patterns:
      - "X天"
      - "X周"
      - "X个月"
      - "从X开始"
      - "持续X"

  SEVERITY:
    description: "严重程度"
    extraction_method: "classification"
    values:
      - mild: 轻微、有点、稍微
      - moderate: 比较严重、挺疼
      - severe: 非常、剧烈、受不了

  VITAL_SIGN:
    description: "生命体征"
    extraction_method: "regex"
    patterns:
      - temperature: "体温\\s*[:：]?\\s*(\\d+(\\.\\d+)?)°?(C|F)?"
      - blood_pressure: "(血压|BP)\\s*[:：]?\\s*(\\d+)/(\\d+)"
      - heart_rate: "(心率|脉搏)\\s*[:：]?\\s*(\\d+)"
```

#### 3.3.2 实体抽取接口

```python
class EntityExtractor:
    """实体抽取器"""

    async def extract(
        self,
        text: str,
        intent: Intent,
        context: DialogueContext
    ) -> EntityResult:
        """
        抽取文本中的实体

        Args:
            text: 用户输入文本
            intent: 已识别的意图
            context: 对话上下文

        Returns:
            EntityResult: 实体抽取结果
        """
        pass
```

### 3.4 槽位填充 (Slot Filling)

#### 3.4.1 槽位模板定义

```python
# 症状咨询槽位模板
SYMPTOM_INQUIRY_SLOTS = {
    "required": {
        "body_part": {
            "type": "BODY_PART",
            "description": "不适部位",
            "prompt": "请问您哪里不舒服？"
        },
        "symptom": {
            "type": "SYMPTOM",
            "description": "具体症状",
            "prompt": "请问具体是什么感觉？比如疼痛、发热等？"
        }
    },
    "optional": {
        "duration": {
            "type": "TIME_DURATION",
            "description": "持续时间",
            "prompt": "请问这种情况持续多久了？"
        },
        "severity": {
            "type": "SEVERITY",
            "description": "严重程度",
            "prompt": "请问严重程度如何？轻微/中等/严重？"
        },
        "accompanying": {
            "type": "list[SYMPTOM]",
            "description": "伴随症状",
            "prompt": "还有其他不适吗？"
        },
        "aggravating": {
            "type": "str",
            "description": "加重因素",
            "prompt": "有什么情况下会加重吗？"
        },
        "relieving": {
            "type": "str",
            "description": "缓解因素",
            "prompt": "有什么情况能缓解吗？"
        },
        "medical_history": {
            "type": "list[DISEASE]",
            "description": "既往病史",
            "prompt": "之前有类似情况吗？有什么病史吗？"
        }
    }
}

# 科室查询槽位模板
DEPARTMENT_QUERY_SLOTS = {
    "required": {
        "symptom_or_disease": {
            "type": "str",
            "description": "症状或疾病",
            "prompt": "请问您有什么不适或想看什么病？"
        }
    },
    "optional": {
        "preferred_hospital": {
            "type": "str",
            "description": "偏好医院",
            "prompt": "有偏好的医院吗？"
        },
        "preferred_doctor": {
            "type": "str",
            "description": "偏好医生",
            "prompt": "有指定医生吗？"
        },
        "time_preference": {
            "type": "TIME",
            "description": "时间偏好",
            "prompt": "希望什么时间就诊？"
        }
    }
}

# 用药咨询槽位模板
MEDICATION_CONSULT_SLOTS = {
    "required": {
        "medicine": {
            "type": "MEDICINE",
            "description": "药物名称",
            "prompt": "请问您咨询哪种药物？"
        }
    },
    "optional": {
        "consult_type": {
            "type": "enum",
            "values": ["dosage", "side_effect", "interaction", "contraindication"],
            "description": "咨询类型",
            "prompt": "您想了解用药方法、副作用还是其他？"
        },
        "patient_age": {
            "type": "int",
            "description": "患者年龄",
            "prompt": "患者年龄是多少？"
        },
        "patient_condition": {
            "type": "str",
            "description": "患者情况",
            "prompt": "患者有什么特殊情况吗？如怀孕、过敏等。"
        }
    }
}

# 挂号预约槽位模板
APPOINTMENT_BOOK_SLOTS = {
    "required": {
        "department": {
            "type": "str",
            "description": "挂号科室",
            "prompt": "请问想挂哪个科室？"
        },
        "appointment_time": {
            "type": "TIME",
            "description": "预约时间",
            "prompt": "请问想预约什么时间？"
        }
    },
    "optional": {
        "doctor": {
            "type": "str",
            "description": "指定医生",
            "prompt": "有指定医生吗？"
        },
        "patient_name": {
            "type": "str",
            "description": "患者姓名",
            "prompt": "请提供患者姓名"
        },
        "patient_id": {
            "type": "str",
            "description": "患者ID",
            "prompt": "请提供患者ID或医保卡号"
        }
    }
}
```

#### 3.4.2 槽位填充状态机

```python
class SlotFillingState:
    """槽位填充状态机"""

    def __init__(self, slot_template: dict):
        self.template = slot_template
        self.filled_slots = {}
        self.pending_slot = None
        self.state = "COLLECTING"  # COLLECTING, COMPLETE, FAILED

    async def fill(
        self,
        entities: dict,
        context: DialogueContext
    ) -> SlotFillingResult:
        """
        填充槽位

        Args:
            entities: 抽取到的实体
            context: 对话上下文

        Returns:
            SlotFillingResult: 填充结果
        """
        # 1. 将实体映射到槽位
        for slot_name, slot_config in self.template.items():
            if slot_config["type"] in entities:
                self.filled_slots[slot_name] = entities[slot_config["type"]]

        # 2. 检查必填槽位
        missing = self._get_missing_required_slots()
        if missing:
            self.pending_slot = missing[0]
            return SlotFillingResult(
                complete=False,
                prompt=self.template[missing[0]]["prompt"],
                missing_slots=missing
            )

        # 3. 槽位完整性校验
        validation = self._validate_slots()
        if not validation.valid:
            return SlotFillingResult(
                complete=False,
                error=validation.error
            )

        self.state = "COMPLETE"
        return SlotFillingResult(
            complete=True,
            slots=self.filled_slots
        )

    def _get_missing_required_slots(self) -> list:
        """获取缺失的必填槽位"""
        missing = []
        for slot_name in self.template.get("required", {}):
            if slot_name not in self.filled_slots:
                missing.append(slot_name)
        return missing

    def _validate_slots(self) -> ValidationResult:
        """验证槽位数据"""
        # 自定义验证逻辑
        return ValidationResult(valid=True)
```

### 3.5 Hooks 机制

#### 3.5.1 Hook 定义

```python
class AgentHooks:
    """Agent处理钩子"""

    # ========== 预处理阶段 ==========
    @hook
    async def before_preprocess(
        self,
        input_data: InputData
    ) -> Optional[InputData]:
        """输入预处理前调用"""
        pass

    @hook
    async def after_preprocess(
        self,
        processed_data: ProcessedData
    ) -> Optional[ProcessedData]:
        """输入预处理后调用"""
        pass

    # ========== 意图识别阶段 ==========
    @hook
    async def before_intent(
        self,
        text: str,
        context: DialogueContext
    ) -> Optional[str]:
        """意图识别前调用，可修改输入文本"""
        pass

    @hook
    async def after_intent(
        self,
        intent_result: IntentResult
    ) -> Optional[IntentResult]:
        """意图识别后调用，可修正意图"""
        pass

    @hook
    async def intent_fallback(
        self,
        text: str,
        confidence: float
    ) -> Optional[IntentResult]:
        """意图置信度不足时调用"""
        pass

    # ========== 实体抽取阶段 ==========
    @hook
    async def before_extract(
        self,
        text: str,
        intent: Intent
    ) -> Optional[str]:
        """实体抽取前调用"""
        pass

    @hook
    async def after_extract(
        self,
        entities: EntityResult
    ) -> Optional[EntityResult]:
        """实体抽取后调用，可修正实体"""
        pass

    @hook
    async def entity_normalize(
        self,
        entity: Entity
    ) -> Optional[Entity]:
        """实体标准化调用"""
        pass

    # ========== 槽位填充阶段 ==========
    @hook
    async def before_fill(
        self,
        slots: dict,
        entities: dict
    ) -> Optional[dict]:
        """槽位填充前调用"""
        pass

    @hook
    async def slot_required(
        self,
        slot_name: str,
        slot_config: dict
    ) -> Optional[str]:
        """需要必填槽位时调用，可自定义追问话术"""
        pass

    @hook
    async def slot_conflict(
        self,
        conflict: SlotConflict
    ) -> Optional[SlotResolution]:
        """槽位冲突时调用"""
        pass

    @hook
    async def after_fill(
        self,
        slots: SlotResult
    ) -> Optional[SlotResult]:
        """槽位填充后调用"""
        pass

    # ========== 决策分发阶段 ==========
    @hook
    async def before_dispatch(
        self,
        intent: Intent,
        slots: dict
    ) -> Optional[DispatchResult]:
        """分发前调用，可拦截或重定向"""
        pass

    @hook
    async def skill_select(
        self,
        intent: Intent,
        available_skills: list
    ) -> Optional[str]:
        """选择Skill时调用，可自定义选择逻辑"""
        pass

    @hook
    async def after_dispatch(
        self,
        dispatch_result: DispatchResult
    ) -> Optional[DispatchResult]:
        """分发后调用"""
        pass

    # ========== Skill执行阶段 ==========
    @hook
    async def before_execute(
        self,
        skill: str,
        params: dict
    ) -> Optional[dict]:
        """Skill执行前调用，可修改参数"""
        pass

    @hook
    async def after_execute(
        self,
        result: SkillResult
    ) -> Optional[SkillResult]:
        """Skill执行后调用，可处理或修改结果"""
        pass

    @hook
    async def on_error(
        self,
        error: Exception,
        skill: str,
        params: dict
    ) -> Optional[ErrorResponse]:
        """Skill执行出错时调用"""
        pass

    # ========== 响应生成阶段 ==========
    @hook
    async def before_response(
        self,
        result: SkillResult
    ) -> Optional[SkillResult]:
        """响应生成前调用"""
        pass

    @hook
    async def format_response(
        self,
        response: str,
        format: str
    ) -> Optional[str]:
        """响应格式化调用"""
        pass

    @hook
    async def after_response(
        self,
        response: str
    ) -> Optional[str]:
        """响应生成后调用"""
        pass
```

#### 3.5.2 Hook 使用示例

```python
# 示例1: 敏感词过滤
@hook
async def before_preprocess(self, input_data: InputData):
    """过滤敏感词"""
    sensitive_words = ["爆炸", "暴力"]
    for word in sensitive_words:
        if word in input_data.text:
            raise SensitiveWordError(f"输入包含敏感词: {word}")
    return input_data

# 示例2: 意图修正
@hook
async def after_intent(self, intent_result: IntentResult):
    """根据历史对话修正意图"""
    if intent_result.intent == "UNKNOWN":
        # 查看历史意图
        last_intent = self.context.last_intent
        if last_intent in ["SYMPTOM_INQUIRY", "MEDICATION_CONSULT"]:
            # 继续上一个意图
            intent_result.intent = last_intent
            intent_result.confidence = 0.9
    return intent_result

# 示例3: 实体标准化
@hook
async def entity_normalize(self, entity: Entity):
    """标准化医学实体"""
    if entity.type == "BODY_PART":
        # 头 → 头部
        mapping = {"头": "头部", "肚子": "腹部", "腰": "腰部"}
        if entity.value in mapping:
            entity.value = mapping[entity.value]
    return entity

# 示例4: 自定义追问
@hook
async def slot_required(self, slot_name: str, slot_config: dict):
    """自定义追问话术"""
    prompts = {
        "severity": "请问您的不适程度如何？\n1. 轻微 - 不影响日常生活\n2. 中等 - 有些影响\n3. 严重 - 无法正常生活"
    }
    return prompts.get(slot_name, slot_config["prompt"])

# 示例5: 安全拦截
@hook
async def before_execute(self, skill: str, params: dict):
    """执行前安全检查"""
    if skill == "medication_prescribe":
        # 禁止直接开处方
        raise PermissionError("禁止直接开具处方药")
    return params
```

---

## 4. Skill 调用与实现

### 4.1 Skill 架构

```python
class Skill:
    """Skill基类"""

    name: str = ""
    description: str = ""
    parameters: dict = {}
    mcp_tools: list = []

    async def execute(
        self,
        parameters: dict,
        context: Context
    ) -> SkillResult:
        """执行Skill逻辑"""
        pass

    async def validate(
        self,
        parameters: dict
    ) -> ValidationResult:
        """验证参数"""
        pass
```

### 4.2 Skill 列表

#### 4.2.1 症状分析 Skill (SymptomAnalyzer)

```yaml
name: symptom_analyzer
description: 分析用户症状，提供初步建议
intent: SYMPTOM_INQUIRY

parameters:
  body_part:
    type: string
    required: true
    description: 不适部位
  symptom:
    type: string
    required: true
    description: 具体症状
  duration:
    type: string
    required: false
    description: 持续时间
  severity:
    type: string
    required: false
    description: 严重程度
    enum: [mild, moderate, severe]
  accompanying:
    type: array
    required: false
    description: 伴随症状

mcp_tools:
  - medical_knowledge.query_symptom
  - medical_knowledge.get_triage_suggestion
  - medical_knowledge.check_red_flags

flow:
  1. 解析症状参数
  2. 调用医学知识库查询症状相关信息
  3. 检查红旗征（危险信号）
  4. 获取分诊建议
  5. 生成结构化症状报告
```

#### 4.2.2 科室推荐 Skill (DepartmentRecommender)

```yaml
name: department_recommender
description: 根据症状推荐挂号科室
intent: DEPARTMENT_QUERY

parameters:
  symptom_or_disease:
    type: string
    required: true
    description: 症状或疾病描述
  preferred_hospital:
    type: string
    required: false
    description: 偏好医院
  time_preference:
    type: string
    required: false
    description: 时间偏好

mcp_tools:
  - hospital.get_departments
  - hospital.get_doctors_by_department
  - hospital.check_availability

flow:
  1. 解析症状/疾病
  2. 匹配对应科室
  3. 查询医院科室信息
  4. 推荐可用医生
  5. 返回挂号建议
```

#### 4.2.3 用药咨询 Skill (MedicationAdvisor)

```yaml
name: medication_advisor
description: 提供药物使用咨询
intent: MEDICATION_CONSULT

parameters:
  medicine:
    type: string
    required: true
    description: 药物名称
  consult_type:
    type: string
    required: false
    description: 咨询类型
    enum: [dosage, side_effect, interaction, contraindication]
  patient_age:
    type: integer
    required: false
    description: 患者年龄
  patient_condition:
    type: string
    required: false
    description: 特殊情况

mcp_tools:
  - drug_db.get_medicine_info
  - drug_db.check_dosage
  - drug_db.check_interactions
  - drug_db.get_contraindications

flow:
  1. 验证药物名称
  2. 根据咨询类型获取相应信息
  3. 检查用药安全性
  4. 生成用药指导
```

#### 4.2.4 挂号服务 Skill (AppointmentService)

```yaml
name: appointment_service
description: 处理挂号预约
intent: APPOINTMENT_BOOK

parameters:
  department:
    type: string
    required: true
    description: 挂号科室
  appointment_time:
    type: datetime
    required: true
    description: 预约时间
  doctor:
    type: string
    required: false
    description: 指定医生
  patient_name:
    type: string
    required: true
    description: 患者姓名
  patient_id:
    type: string
    required: false
    description: 患者ID

mcp_tools:
  - appointment.check_availability
  - appointment.create_booking
  - appointment.send_confirmation
  - payment.create_order

flow:
  1. 验证时间可用性
  2. 检查医生排班
  3. 创建预约订单
  4. 发送确认信息
```

#### 4.2.5 报告解读 Skill (ReportInterpreter)

```yaml
name: report_interpreter
description: 解读医学检查报告
intent: REPORT_INTERPRET

parameters:
  report_type:
    type: string
    required: true
    description: 报告类型
    enum: [blood_test, urine_test, imaging, pathology]
  report_data:
    type: object
    required: true
    description: 报告数据

mcp_tools:
  - medical_knowledge.get_reference_range
  - medical_knowledge.explain_indicator
  - medical_knowledge.interpret_pattern

flow:
  1. 解析报告数据
  2. 对比正常参考范围
  3. 标记异常指标
  4. 生成解读说明
  5. 提供就医建议
```

#### 4.2.6 健康问答 Skill (HealthQA)

```yaml
name: health_qa
description: 回答健康相关问题
intent: HEALTH_EDU

parameters:
  question:
    type: string
    required: true
    description: 用户问题
  topic:
    type: string
    required: false
    description: 话题分类

mcp_tools:
  - medical_knowledge.search
  - medical_knowledge.get_article

flow:
  1. 分析问题类型
  2. 搜索医学知识库
  3. 提取相关答案
  4. 生成易懂解释
```

### 4.3 Skill 注册与调用

```python
class SkillRegistry:
    """Skill注册中心"""

    def __init__(self):
        self.skills = {}
        self.intent_skill_map = {}

    def register(self, skill: Skill):
        """注册Skill"""
        self.skills[skill.name] = skill
        for intent in skill.supported_intents:
            self.intent_skill_map[intent] = skill.name

    def get_skill(self, name: str) -> Skill:
        """获取Skill"""
        return self.skills.get(name)

    def get_skill_by_intent(self, intent: str) -> Skill:
        """根据意图获取Skill"""
        skill_name = self.intent_skill_map.get(intent)
        return self.skills.get(skill_name)

# 使用示例
registry = SkillRegistry()
registry.register(SymptomAnalyzer())
registry.register(DepartmentRecommender())
registry.register(MedicationAdvisor())

# 调用
skill = registry.get_skill_by_intent("SYMPTOM_INQUIRY")
result = await skill.execute(parameters, context)
```

---

## 5. MCP 工具整合

### 5.1 MCP 架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        MCP Client Layer                         │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    MCP Manager                             │  │
│  │  - Server Discovery                                        │  │
│  │  - Connection Management                                   │  │
│  │  - Tool Registration                                       │  │
│  │  - Load Balancing                                          │  │
│  │  - Error Handling                                          │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
┌───────▼────────┐  ┌────────▼────────┐  ┌────────▼────────┐
│ Medical KB     │  │ Hospital System  │  │ Drug Database   │
│ MCP Server     │  │ MCP Server       │  │ MCP Server      │
│                │  │                  │  │                 │
│ Tools:         │  │ Tools:           │  │ Tools:          │
│ - query_symptom│  │ - get_depts      │  │ - get_info      │
│ - get_triage   │  │ - get_doctors    │  │ - check_dose    │
│ - check_red    │  │ - check_availability│ - interaction   │
│ - search_kd    │  │ - create_booking │  │ - contra_ind    │
└────────────────┘  └──────────────────┘  └──────────────────┘
```

### 5.2 MCP Server 定义

#### 5.2.1 医学知识库 MCP Server

```yaml
name: medical_knowledge
description: 医学知识库服务
endpoint: http://localhost:3001

tools:
  query_symptom:
    description: 查询症状相关信息
    input_schema:
      type: object
      properties:
        symptom:
          type: string
          description: 症状名称
        body_part:
          type: string
          description: 身体部位
    output_schema:
      type: object
      properties:
        description:
          type: string
        possible_causes:
          type: array
          items:
            type: string
        red_flags:
          type: array
          items:
            type: string

  get_triage_suggestion:
    description: 获取分诊建议
    input_schema:
      type: object
      properties:
        symptoms:
          type: array
          items:
            type: object
        patient_info:
          type: object
    output_schema:
      type: object
      properties:
        urgency:
          type: string
          enum: [emergency, urgent, routine, self_care]
        department:
          type: string
        advice:
          type: string

  check_red_flags:
    description: 检查红旗征（危险信号）
    input_schema:
      type: object
      properties:
        symptoms:
          type: array
    output_schema:
      type: object
      properties:
        has_red_flag:
          type: boolean
        flags:
          type: array
          items:
            type: object
        action:
          type: string

  search_knowledge:
    description: 搜索医学知识
    input_schema:
      type: object
      properties:
        query:
          type: string
        category:
          type: string
    output_schema:
      type: object
      properties:
        results:
          type: array
        summary:
          type: string

  get_reference_range:
    description: 获取检验指标正常范围
    input_schema:
      type: object
      properties:
        indicator:
          type: string
        age:
          type: integer
        gender:
          type: string
    output_schema:
      type: object
      properties:
        indicator:
          type: string
        min:
          type: number
        max:
          type: number
        unit:
          type: string
```

#### 5.2.2 医院信息系统 MCP Server

```yaml
name: hospital_system
description: 医院信息系统服务
endpoint: http://localhost:3002

tools:
  get_departments:
    description: 获取医院科室列表
    input_schema:
      type: object
      properties:
        hospital_id:
          type: string
    output_schema:
      type: object
      properties:
        departments:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              name:
                type: string
              location:
                type: string

  get_doctors_by_department:
    description: 获取科室医生列表
    input_schema:
      type: object
      properties:
        department_id:
          type: string
        date:
          type: string
    output_schema:
      type: object
      properties:
        doctors:
          type: array
          items:
            type: object

  check_availability:
    description: 检查医生可用时间
    input_schema:
      type: object
      properties:
        doctor_id:
          type: string
        date:
          type: string
    output_schema:
      type: object
      properties:
        available_slots:
          type: array
          items:
            type: object

  create_booking:
    description: 创建预约挂号
    input_schema:
      type: object
      properties:
        patient_id:
          type: string
        doctor_id:
          type: string
        appointment_time:
          type: string
        department_id:
          type: string
    output_schema:
      type: object
      properties:
        booking_id:
          type: string
        status:
          type: string
        queue_number:
          type: integer
```

#### 5.2.3 药品数据库 MCP Server

```yaml
name: drug_database
description: 药品数据库服务
endpoint: http://localhost:3003

tools:
  get_medicine_info:
    description: 获取药品信息
    input_schema:
      type: object
      properties:
        medicine_name:
          type: string
    output_schema:
      type: object
      properties:
        name:
          type: string
        generic_name:
          type: string
        category:
          type: string
        description:
          type: string

  check_dosage:
    description: 检查用药剂量
    input_schema:
      type: object
      properties:
        medicine_name:
          type: string
        age:
          type: integer
        weight:
          type: number
    output_schema:
      type: object
      properties:
        recommended_dosage:
          type: string
        max_dosage:
          type: string
        frequency:
          type: string

  check_interactions:
    description: 检查药物相互作用
    input_schema:
      type: object
      properties:
        medicines:
          type: array
          items:
            type: string
    output_schema:
      type: object
      properties:
        has_interaction:
          type: boolean
        interactions:
          type: array
          items:
            type: object
        severity:
          type: string

  get_contraindications:
    description: 获取禁忌症
    input_schema:
      type: object
      properties:
        medicine_name:
          type: string
        patient_conditions:
          type: array
    output_schema:
      type: object
      properties:
        contraindications:
          type: array
          items:
            type: object
```

### 5.3 MCP 工具调用

```python
class MCPClient:
    """MCP客户端"""

    def __init__(self, server_url: str):
        self.server_url = server_url
        self.session = None

    async def connect(self):
        """连接MCP服务器"""
        self.session = await aiohttp.ClientSession().connect(self.server_url)

    async def call_tool(
        self,
        tool_name: str,
        parameters: dict
    ) -> MCPResult:
        """
        调用MCP工具

        Args:
            tool_name: 工具名称
            parameters: 工具参数

        Returns:
            MCPResult: 调用结果
        """
        payload = {
            "tool": tool_name,
            "parameters": parameters
        }
        response = await self.session.post("/tools/call", json=payload)
        return MCPResult(**await response.json())

# 使用示例
class SymptomAnalyzer(Skill):
    """症状分析Skill"""

    async def execute(self, parameters: dict, context: Context):
        # 获取MCP客户端
        kb_client = context.get_mcp_client("medical_knowledge")

        # 调用MCP工具
        symptom_info = await kb_client.call_tool(
            "query_symptom",
            {
                "symptom": parameters["symptom"],
                "body_part": parameters.get("body_part")
            }
        )

        # 检查红旗征
        red_flags = await kb_client.call_tool(
            "check_red_flags",
            {"symptoms": [parameters]}
        )

        # 获取分诊建议
        triage = await kb_client.call_tool(
            "get_triage_suggestion",
            {
                "symptoms": [parameters],
                "patient_info": context.patient_info
            }
        )

        return SkillResult(
            data={
                "symptom_info": symptom_info,
                "red_flags": red_flags,
                "triage": triage
            }
        )
```

---

## 6. 数据模型

### 6.1 核心数据结构

```python
@dataclass
class DialogueContext:
    """对话上下文"""
    session_id: str
    user_id: str
    history: List[DialogueTurn]
    current_intent: Optional[Intent]
    filled_slots: dict
    metadata: dict

@dataclass
class Intent:
    """意图"""
    name: str
    confidence: float
    raw_text: str

@dataclass
class Entity:
    """实体"""
    type: str
    value: Any
    span: Tuple[int, int]
    confidence: float

@dataclass
class SlotResult:
    """槽位结果"""
    complete: bool
    slots: dict
    missing: List[str]
    prompt: Optional[str]

@dataclass
class SkillResult:
    """Skill执行结果"""
    success: bool
    data: Any
    error: Optional[str]
    response: str
```

### 6.2 配置模型

```python
@dataclass
class AgentConfig:
    """Agent配置"""
    intent_threshold: float = 0.75
    entity_threshold: float = 0.70
    max_turns: int = 10
    enable_hooks: bool = True
    mcp_servers: List[str] = None

@dataclass
class SkillConfig:
    """Skill配置"""
    name: str
    enabled: bool = True
    timeout: int = 30
    retry: int = 3
    mcp_tools: List[str] = None
```

---

## 7. 对话示例

### 示例1: 症状咨询对话

```
用户: 我头疼三天了

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Agent处理流程:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[1. 预处理]
   @before_preprocess ✓
   输入文本: "我头疼三天了"

[2. 意图识别]
   @before_intent ✓
   识别结果: SYMPTOM_INQUIRY (置信度: 0.92)
   @after_intent ✓

[3. 实体抽取]
   @before_extract ✓
   抽取结果:
   - BODY_PART: "头" (位置: 1-2, 置信度: 0.95)
   - SYMPTOM: "疼" (位置: 2-3, 置信度: 0.88)
   - TIME_DURATION: "三天了" (位置: 3-6, 置信度: 0.91)
   @entity_normalize: "头" → "头部" ✓
   @after_extract ✓

[4. 槽位填充]
   当前槽位状态:
   {
     "body_part": "头部" ✓,
     "symptom": "疼痛" ✓,
     "duration": "3天" ✓,
     "severity": null ⚠ (可选)
   }
   必填槽位已完整，进入下一步

[5. 决策分发]
   @skill_select: symptom_analyzer
   目标Skill: symptom_analyzer

[6. Skill执行]
   @before_execute ✓
   调用MCP工具:
   - medical_knowledge.query_symptom ✓
   - medical_knowledge.check_red_flags ✓
   - medical_knowledge.get_triage_suggestion ✓
   @after_execute ✓

[7. 响应生成]
   @format_response ✓

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

助手: 了解到您头痛已经持续3天了。为了更好地帮助您，我想了解几个问题：

1. 请问疼痛的程度如何？
   - 轻微（不影响日常生活）
   - 中等（有些影响）
   - 严重（无法正常生活）

2. 疼痛是持续性的还是间歇性的？

3. 还有其他不适吗？比如发热、恶心等？

---

用户: 挺疼的，一阵一阵的，有点恶心

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[实体补充]
   SEVERITY: "挺疼的" → moderate (中等)
   SYMPTOM_PATTERN: "一阵一阵的" → 间歇性
   ACCOMPANYING: ["恶心"]

[槽位更新]
   {
     "body_part": "头部" ✓,
     "symptom": "疼痛" ✓,
     "duration": "3天" ✓,
     "severity": "中等" ✓,
     "pattern": "间歇性" ✓,
     "accompanying": ["恶心"] ✓
   }

[再次执行Skill]
   调用MCP: medical_knowledge.check_red_flags
   ⚠ 检测到红旗征: "头痛伴随恶心可能是偏头痛或更严重问题"

助手: 感谢您的补充。根据您描述的情况：
- 头痛，中等程度，间歇性发作
- 持续3天
- 伴有恶心

⚠️ **建议**: 头痛伴随恶心可能需要专业评估，建议您：

1. **优先级**: 建议尽快就医
2. **推荐科室**: 神经内科
3. **可能的诊断**: 偏头痛、紧张性头痛等（需医生确诊）

是否需要我帮您查看可预约的医生？
```

### 示例2: 科室推荐对话

```
用户: 头疼应该挂什么科？

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[意图识别]
   意图: DEPARTMENT_QUERY (置信度: 0.95)

[实体抽取]
   SYMPTOM: "头疼"

[槽位填充]
   symptom_or_disease: "头疼" ✓

[Skill执行]
   Skill: department_recommender
   MCP调用:
   - hospital_system.get_departments
   - medical_knowledge.get_triage_suggestion

助手: 根据头疼症状，建议挂号科室如下：

| 科室        | 适用情况                     |
|-------------|------------------------------|
| 神经内科    | 头痛、头晕、失眠等           |
| 普通内科    | 一般性头痛                   |
| 急诊科      | 剧烈头痛或突发头痛           |

📋 您想挂哪个科室？我可以帮您查看排班医生。
```

### 示例3: 用药咨询对话

```
用户: 阿莫西林怎么吃？

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[意图识别]
   意图: MEDICATION_CONSULT (置信度: 0.89)

[实体抽取]
   MEDICINE: "阿莫西林"
   CONSULT_TYPE: "怎么吃" → dosage

[Skill执行]
   Skill: medication_advisor
   MCP调用:
   - drug_database.get_medicine_info
   - drug_database.check_dosage

助手: 关于阿莫西林的用药说明：

💊 **药品信息**
- 通用名: 阿莫西林胶囊
- 类别: 青霉素类抗生素

📋 **常用剂量**
- 成人: 每次0.5g，每6-8小时一次
- 儿童: 按体重计算（请咨询医生）

⏰ **服用要点**
1. 每6-8小时服用一次，保持血药浓度稳定
2. 饭后服用可减少胃部不适
3. 完整服用整个疗程，不要中途停药

⚠️ **注意事项**
- 对青霉素过敏者禁用
- 请在医生指导下使用
- 如出现皮疹、呼吸困难请立即就医

❓ 还有其他关于阿莫西林的问题吗？
```

---

## 8. 安全与合规

### 8.1 安全措施

```yaml
privacy_protection:
  data_encryption: "全程加密传输和存储"
  anonymization: "用户数据去标识化处理"
  retention_policy: "对话历史保留30天后自动删除"

content_safety:
  sensitive_filter: "过滤敏感和不当内容"
  medical_disclaimer: "所有建议附带免责声明"
  emergency_redirect: "识别紧急情况引导就医"

access_control:
  authentication: "用户身份验证"
  rate_limiting: "接口访问频率限制"
  audit_log: "操作日志审计"
```

### 8.2 免责声明模板

```
⚠️ **重要声明**

1. 本助手提供的健康信息仅供参考，不能替代专业医疗建议

2. 如有以下情况，请立即就医：
   - 剧烈疼痛或突发严重症状
   - 呼吸困难、意识模糊
   - 持续高烧不退
   - 严重外伤

3. 药物使用请遵医嘱，本助手不提供处方药推荐

4. 紧急情况请拨打120急救电话
```

---

## 9. 扩展性设计

### 9.1 新增 Intent

```yaml
# 在 intents.yaml 中添加
NEW_INTENT:
  description: "新意图描述"
  examples: ["示例1", "示例2"]
  priority: N
  confidence_threshold: 0.75
```

### 9.2 新增 Skill

```python
# 创建新Skill类
class NewSkill(Skill):
    name = "new_skill"
    description = "新技能描述"
    supported_intents = ["NEW_INTENT"]
    mcp_tools = ["tool_name"]

    async def execute(self, parameters, context):
        # 实现逻辑
        pass

# 注册
registry.register(NewSkill())
```

### 9.3 新增 MCP Tool

```yaml
# 在MCP Server配置中添加
new_tool:
  description: "工具描述"
  input_schema: {...}
  output_schema: {...}
```

---

## 10. 技术栈建议

| 层级 | 技术选型 |
|------|----------|
| 意图识别 | NLP模型 (BERT/RoBERTa) 或 规则+分类器 |
| 实体抽取 | Medical NER 模型 |
| 对话管理 | 状态机 + DYM混合 |
| 框架 | Python + asyncio |
| MCP协议 | MCP SDK |
| 存储 | PostgreSQL + Redis |
| 部署 | Docker + Kubernetes |

---

## 11. 总结

本文档定义了医疗智能助手的产品架构，核心包括：

1. **完整的Agent处理流程**：从输入预处理到响应生成的全流程
2. **意图识别机制**：多意图分类、置信度判断、意图修正
3. **实体抽取能力**：医学实体NER、数值抽取、时间解析
4. **槽位填充系统**：必填/可选槽位、多轮对话、冲突处理
5. **全面的Hooks机制**：20+钩子点，支持全流程自定义
6. **Skill调用框架**：模块化技能设计，易于扩展
7. **MCP工具整合**：标准化的工具调用接口

该架构清晰、可扩展、符合医疗场景要求。
